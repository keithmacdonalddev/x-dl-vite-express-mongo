<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Vault — Module Map</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--bg4:#475569;
  --text:#e2e8f0;--text-dim:#94a3b8;--text-bright:#f8fafc;
  --border:#334155;--hover:#1e293b;
  --radius:8px;--radius-sm:4px;
  --transition:220ms ease;
}
html{font-size:14px}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;min-height:100vh;line-height:1.5;overflow-x:hidden}

/* ── Header ─────────────────────────── */
.header{padding:20px 28px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;max-width:1440px;margin:0 auto}
.header h1{font-size:1.4rem;font-weight:700;color:var(--text-bright);display:flex;align-items:center;gap:10px}
.header h1 .icon{width:28px;height:28px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:6px;display:grid;place-items:center;font-size:14px;color:#fff;font-weight:700}
.stats{display:flex;gap:12px;flex-wrap:wrap}
.stat{display:flex;flex-direction:column;align-items:center;padding:4px 14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border);transition:all var(--transition)}
.stat-val{font-size:1.15rem;font-weight:700;color:var(--text-bright)}
.stat-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim)}

/* ── Tabs ───────────────────────────── */
.tabs{display:flex;gap:4px;padding:14px 28px 0;max-width:1440px;margin:0 auto;flex-wrap:wrap}
.tab{background:var(--bg2);color:var(--text-dim);border:1px solid var(--border);padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;font-size:0.82rem;font-weight:600;transition:all var(--transition);display:flex;align-items:center;gap:6px;user-select:none;border-bottom:2px solid transparent}
.tab:hover{background:var(--bg3);color:var(--text)}
.tab.active{background:var(--bg);color:var(--text-bright);border-color:var(--bg4);border-bottom-color:var(--bg);position:relative;z-index:2}
.tab .tab-icon{font-size:1rem}

/* ── Scope Bar ─────────────────────── */
.scope-bar{display:flex;gap:4px;padding:10px 28px;max-width:1440px;margin:0 auto;background:var(--bg2);border-bottom:1px solid var(--border)}
.scope-btn{background:var(--bg);color:var(--text-dim);border:1px solid var(--border);padding:6px 18px;border-radius:6px;cursor:pointer;font-size:0.78rem;font-weight:600;transition:all var(--transition);user-select:none}
.scope-btn:hover{background:var(--bg3);color:var(--text)}
.scope-btn.active{background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(59,130,246,0.3)}

/* ── View container ─────────────────── */
.view-wrap{max-width:1440px;margin:0 auto;border-top:1px solid var(--bg4);min-height:calc(100vh - 190px);position:relative}
.view{display:none;padding:20px 28px 40px;animation:fadeIn 300ms ease}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.view-subtitle{font-size:0.82rem;color:var(--text-dim);margin-bottom:16px;font-style:italic}

/* ── Legend strip ───────────────────── */
.legend-strip{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px;padding:10px 14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)}
.legend-strip-title{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--bg4);font-weight:700;width:100%;margin-bottom:4px}
.legend-chip{display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--text-dim);cursor:default;padding:2px 8px;border-radius:20px;transition:all var(--transition);border:1px solid transparent}
.legend-chip:hover{background:rgba(255,255,255,0.06);color:var(--text)}
.legend-chip .lc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ── Tooltip ────────────────────────── */
.tooltip{position:fixed;pointer-events:none;z-index:9999;background:#1a1e2e;border:1px solid var(--bg4);border-radius:var(--radius);padding:8px 12px;max-width:340px;font-size:0.78rem;line-height:1.45;color:var(--text);box-shadow:0 8px 30px rgba(0,0,0,0.5);opacity:0;transition:opacity 150ms ease}
.tooltip.visible{opacity:1}
.tooltip .tt-path{color:var(--text-dim);font-size:0.7rem;margin-bottom:3px;font-family:'Cascadia Code','Fira Code',monospace}
.tooltip .tt-mod{display:inline-block;padding:1px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;color:#fff;margin-bottom:3px}
.tooltip .tt-desc{color:var(--text)}

/* ── Zoom Viewport (shared) ─────────── */
.zoom-viewport{position:relative;overflow:hidden;max-height:calc(100vh - 240px);border:1px solid var(--border);border-radius:var(--radius);cursor:grab;user-select:none;background:#0c1322}
.zoom-viewport.is-dragging{cursor:grabbing}
.zoom-viewport svg{width:100%;height:auto;transform-origin:0 0;pointer-events:all}
.zoom-controls{position:absolute;bottom:12px;right:12px;display:flex;align-items:center;gap:4px;z-index:10;background:rgba(15,23,42,0.92);border:1px solid var(--bg4);border-radius:8px;padding:4px 6px;backdrop-filter:blur(6px);box-shadow:0 4px 16px rgba(0,0,0,0.4)}
.zoom-controls button{background:var(--bg2);color:var(--text-bright);border:1px solid var(--bg4);border-radius:6px;width:30px;height:30px;font-size:1rem;font-weight:700;cursor:pointer;display:grid;place-items:center;transition:all 150ms ease;line-height:1}
.zoom-controls button:hover{background:var(--bg3);border-color:#64748b}
.zoom-controls button:active{background:var(--bg4)}
.zoom-controls .zoom-pct{color:var(--text-dim);font-size:0.72rem;font-weight:600;min-width:42px;text-align:center;padding:0 4px;user-select:none}

/* ── View 1: Top-Down ────────────────── */
.td-node{cursor:pointer;transition:filter 200ms}
.td-node:hover{filter:brightness(1.2)}
.td-arrow{fill:none;stroke:var(--bg4);stroke-width:1.5;marker-end:url(#arrowhead)}
.td-label{font-family:'Segoe UI',system-ui,sans-serif;fill:var(--text-bright);font-size:11px;font-weight:600;text-anchor:middle;pointer-events:none}
.td-sublabel{font-family:'Segoe UI',system-ui,sans-serif;fill:var(--text-dim);font-size:9px;text-anchor:middle;pointer-events:none}

/* ── View 3: Sunburst ────────────────── */
.sb-viewport{display:flex;justify-content:center;align-items:center;min-height:500px}
.sb-viewport svg{max-width:700px;max-height:700px}
.sb-arc{cursor:pointer;transition:opacity 200ms}
.sb-arc:hover{opacity:0.8}

/* ── View 4: Bubble Map ──────────────── */
.bub-circle{cursor:pointer;transition:opacity 200ms}
.bub-circle:hover{opacity:0.85}
.bub-label{font-family:'Segoe UI',system-ui,sans-serif;fill:var(--text-bright);font-weight:600;text-anchor:middle;pointer-events:none}

/* ── View 5: Dependency Flow ─────────── */
.dep-node{cursor:pointer;transition:filter 200ms}
.dep-node:hover{filter:brightness(1.15)}
.dep-edge{fill:none;stroke-width:1.2;opacity:0.5}

/* ── View 6: Grid Matrix ────────────── */
.grid-table{width:100%;border-collapse:collapse;font-size:0.78rem}
.grid-table th,.grid-table td{padding:8px 12px;border:1px solid var(--border);text-align:left}
.grid-table th{background:var(--bg2);color:var(--text-bright);font-weight:700;text-transform:uppercase;font-size:0.68rem;letter-spacing:0.06em;position:sticky;top:0;z-index:2}
.grid-table td{background:var(--bg);vertical-align:top}
.grid-team{display:flex;align-items:center;gap:6px;font-weight:600;white-space:nowrap}
.grid-team .gt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.grid-file{display:inline-block;padding:2px 6px;margin:1px 2px;border-radius:4px;font-size:0.7rem;font-family:'Cascadia Code','Fira Code',monospace;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);cursor:default;transition:all 150ms}
.grid-file:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.15)}

/* ── View 7: Architecture Layers ────── */
.arch-layer{border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;transition:all var(--transition)}
.arch-layer-header{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;user-select:none}
.arch-layer-header:hover{background:rgba(255,255,255,0.03)}
.arch-layer-title{font-weight:700;font-size:0.92rem;color:var(--text-bright)}
.arch-layer-desc{font-size:0.75rem;color:var(--text-dim);margin-left:auto}
.arch-layer-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.arch-layer-body{padding:10px 16px 14px;display:none;border-top:1px solid var(--border)}
.arch-layer.open .arch-layer-body{display:flex;flex-wrap:wrap;gap:6px}
.arch-file{font-size:0.72rem;font-family:'Cascadia Code','Fira Code',monospace;padding:3px 8px;border-radius:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);cursor:default;transition:all 150ms}
.arch-file:hover{background:rgba(255,255,255,0.1)}

/* ── View 8: File Tree ──────────────── */
.ftree{font-family:'Cascadia Code','Fira Code',monospace;font-size:0.78rem;line-height:1.7;white-space:pre;overflow-x:auto;padding:10px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border);max-height:calc(100vh - 280px);overflow-y:auto}
.ftree-line{display:flex;align-items:center;gap:0}
.ftree-indent{color:var(--bg4);flex-shrink:0;white-space:pre}
.ftree-icon{flex-shrink:0;margin-right:5px;font-size:0.85rem;width:16px;text-align:center}
.ftree-name{cursor:default;transition:color 150ms}
.ftree-name:hover{color:var(--text-bright)}
.ftree-name.is-folder{cursor:pointer;font-weight:600;color:var(--text-bright)}
.ftree-annotation{color:var(--text-dim);margin-left:12px;font-size:0.7rem;font-family:'Segoe UI',system-ui,sans-serif;font-style:italic}
.ftree-team-tag{display:inline-block;padding:0 5px;border-radius:3px;font-size:0.62rem;font-weight:600;color:#fff;margin-left:8px;font-family:'Segoe UI',system-ui,sans-serif}

/* ── View 9: Mind Map ────────────────── */
.mm-node{cursor:pointer;transition:filter 200ms}
.mm-node:hover{filter:brightness(1.15)}
.mm-edge{fill:none;stroke-width:1.5;opacity:0.4}

/* ── View 10: Network ────────────────── */
.net-node{cursor:grab;transition:filter 200ms}
.net-node:hover{filter:brightness(1.2)}
.net-node.dragging{cursor:grabbing}
.net-edge{stroke-width:1;opacity:0.3}

/* ── View 11: Teams ──────────────────── */
.teams-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.team-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:18px;transition:all var(--transition);position:relative;overflow:hidden}
.team-card:hover{border-color:var(--bg4);box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.team-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.team-card-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.team-card-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0}
.team-card-name{font-weight:700;font-size:1rem;color:var(--text-bright)}
.team-card-path{font-size:0.72rem;color:var(--text-dim);font-family:'Cascadia Code','Fira Code',monospace;margin-bottom:10px}
.team-card-files{display:flex;flex-wrap:wrap;gap:4px}
.team-card-file{font-size:0.7rem;font-family:'Cascadia Code','Fira Code',monospace;padding:2px 7px;border-radius:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);cursor:default;transition:all 150ms}
.team-card-file:hover{background:rgba(255,255,255,0.1)}
.team-card-count{position:absolute;top:14px;right:16px;font-size:0.68rem;color:var(--text-dim);font-weight:600}

/* ── Responsive ─────────────────────── */
@media(max-width:980px){
  .tabs{padding:10px 14px 0;gap:3px}
  .tab{padding:6px 10px;font-size:0.75rem}
  .scope-bar{padding:8px 14px}
  .view{padding:14px 14px 30px}
  .header{padding:14px 14px 0}
  .teams-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <h1><span class="icon">MV</span> Media Vault — Module Map</h1>
  <div class="stats" id="stats-bar"></div>
</div>

<div class="tabs" id="tab-bar"></div>

<div class="scope-bar" id="scope-bar">
  <button class="scope-btn active" data-scope="full" onclick="setScope('full')">Full</button>
  <button class="scope-btn" data-scope="server" onclick="setScope('server')">Server</button>
  <button class="scope-btn" data-scope="client" onclick="setScope('client')">Client</button>
</div>

<div class="view-wrap" id="view-wrap"></div>

<div class="tooltip" id="tooltip"></div>

<script>
/* ══════════════════════════════════════════════════════════════════
   DATA MODEL
   ══════════════════════════════════════════════════════════════════ */

const MODULES = {
  'api':        { label:'API Team',            color:'#f97316', side:'server', path:'server/src/api/' },
  'core':       { label:'Core Team',           color:'#e879f9', side:'server', path:'server/src/core/' },
  'platforms-s':{ label:'Platforms Team',       color:'#14b8a6', side:'server', path:'server/src/platforms/' },
  'services':   { label:'Services Team',       color:'#ef4444', side:'server', path:'server/src/services/' },
  'worker':     { label:'Worker Team',         color:'#6366f1', side:'server', path:'server/src/worker/' },
  'intake':     { label:'Intake Team',         color:'#10b981', side:'client', path:'client/src/features/intake/' },
  'dashboard':  { label:'Dashboard Team',      color:'#f59e0b', side:'client', path:'client/src/features/dashboard/' },
  'activity':   { label:'Activity Team',       color:'#8b5cf6', side:'client', path:'client/src/features/activity/' },
  'pages':      { label:'Page Components',     color:'#ec4899', side:'client', path:'client/src/components/' },
  'shell':      { label:'App Shell',           color:'#3b82f6', side:'client', path:'client/src/' },
  'data':       { label:'Data Layer',          color:'#06b6d4', side:'client', path:'client/src/' },
  'client-lib': { label:'Client Lib',          color:'#84cc16', side:'client', path:'client/src/lib/' },
  'client-plat':{ label:'Client Platforms',    color:'#14b8a6', side:'client', path:'client/src/platforms/' },
  'root':       { label:'Root',                color:'#9ca3af', side:'root',   path:'' },
};

/* ── File tree data ────────────────────────────────────── */
const FILES = [
  // Root
  { path:'package.json', mod:'root', desc:'Root orchestration scripts' },
  { path:'CLAUDE.md', mod:'root', desc:'Project instructions' },
  { path:'README.md', mod:'root', desc:'Project README' },

  // Client config
  { path:'client/package.json', mod:'shell', desc:'Client dependencies' },
  { path:'client/vite.config.js', mod:'shell', desc:'Vite config + /api proxy' },

  // App Shell
  { path:'client/src/App.jsx', mod:'shell', desc:'Hash router: dashboard + contact profile' },
  { path:'client/src/App.css', mod:'shell', desc:'Global styles + design tokens' },
  { path:'client/src/main.jsx', mod:'shell', desc:'React entry point' },
  { path:'client/src/index.css', mod:'shell', desc:'CSS reset' },

  // Data Layer
  { path:'client/src/api/jobsApi.js', mod:'data', desc:'Fetch wrapper for /api/* calls' },
  { path:'client/src/hooks/useJobsPolling.js', mod:'data', desc:'3s polling loop for job list' },

  // Page Components
  { path:'client/src/components/JobsPage.jsx', mod:'pages', desc:'Central dashboard page component' },
  { path:'client/src/components/ContactProfilePage.jsx', mod:'pages', desc:'Per-contact job history view' },
  { path:'client/src/components/ConfirmModal.jsx', mod:'pages', desc:'Shared confirmation dialog' },
  { path:'client/src/components/ActivityPanel.jsx', mod:'pages', desc:'Re-export stub for ActivityPanel' },

  // Intake
  { path:'client/src/features/intake/IntakeForm.jsx', mod:'intake', desc:'URL submission form' },
  { path:'client/src/features/intake/useIntake.js', mod:'intake', desc:'Intake logic + platform classifier' },
  { path:'client/src/features/intake/intake.css', mod:'intake', desc:'Intake styles' },

  // Dashboard
  { path:'client/src/features/dashboard/JobsList.jsx', mod:'dashboard', desc:'Job list with selection + bulk actions' },
  { path:'client/src/features/dashboard/JobRow.jsx', mod:'dashboard', desc:'Individual job card' },
  { path:'client/src/features/dashboard/JobEditForm.jsx', mod:'dashboard', desc:'Inline job editing form' },
  { path:'client/src/features/dashboard/useJobActions.js', mod:'dashboard', desc:'Delete, retry, bulk-delete actions' },
  { path:'client/src/features/dashboard/useSelection.js', mod:'dashboard', desc:'Multi-select state for bulk ops' },
  { path:'client/src/features/dashboard/dashboard.css', mod:'dashboard', desc:'Dashboard styles' },

  // Activity
  { path:'client/src/features/activity/ActivityPanel.jsx', mod:'activity', desc:'SSE telemetry feed panel' },
  { path:'client/src/features/activity/eventTranslator.js', mod:'activity', desc:'Raw telemetry to human-readable text' },
  { path:'client/src/features/activity/activity.css', mod:'activity', desc:'Activity panel styles' },

  // Client Lib
  { path:'client/src/lib/contacts.js', mod:'client-lib', desc:'Contact helpers' },
  { path:'client/src/lib/eventTranslator.js', mod:'client-lib', desc:'Legacy re-export' },

  // Client Platforms
  { path:'client/src/platforms/index.js', mod:'client-plat', desc:'Client-side platform definitions' },

  // ─── SERVER ───────────────────────────────────

  // API Team
  { path:'server/src/api/routes/jobs.js', mod:'api', desc:'CRUD for jobs' },
  { path:'server/src/api/routes/contacts.js', mod:'api', desc:'Contact aggregation routes' },
  { path:'server/src/api/routes/retry.js', mod:'api', desc:'Job retry endpoint' },
  { path:'server/src/api/routes/status.js', mod:'api', desc:'Status transition endpoint' },
  { path:'server/src/api/routes/worker-health.js', mod:'api', desc:'Worker health check' },
  { path:'server/src/api/routes/helpers/route-utils.js', mod:'api', desc:'Shared route helpers (sendError, validation)' },

  // Core Team
  { path:'server/src/core/config/env.js', mod:'core', desc:'Server config + runtime mode' },
  { path:'server/src/core/config/platform-capabilities.js', mod:'core', desc:'Platform enable/disable' },
  { path:'server/src/core/constants/job-status.js', mod:'core', desc:'Re-export shim for enums' },
  { path:'server/src/core/data/job-model.js', mod:'core', desc:'Canonical Job schema' },
  { path:'server/src/core/data/job-status.js', mod:'core', desc:'Canonical status + source enums' },
  { path:'server/src/core/dispatch/resolve-domain-id.js', mod:'core', desc:'URL to domain ID resolution' },
  { path:'server/src/core/dispatch/route-job-by-domain.js', mod:'core', desc:'Job to domain handler routing' },
  { path:'server/src/core/domain/job-transitions.js', mod:'core', desc:'Valid state transition definitions' },
  { path:'server/src/core/http/request-limits.js', mod:'core', desc:'Canonical HTTP middleware' },
  { path:'server/src/core/lib/error-codes.js', mod:'core', desc:'Standardized error code constants' },
  { path:'server/src/core/lib/logger.js', mod:'core', desc:'Structured logger (publishes to telemetry)' },
  { path:'server/src/core/lib/telemetry.js', mod:'core', desc:'Ring buffer + SSE pub/sub' },
  { path:'server/src/core/middleware/request-limits.js', mod:'core', desc:'Re-export shim' },
  { path:'server/src/core/models/job.js', mod:'core', desc:'Re-export shim for Job model' },
  { path:'server/src/core/models/worker-heartbeat.js', mod:'core', desc:'Worker heartbeat model' },
  { path:'server/src/core/models/telemetry-event.js', mod:'core', desc:'TTL telemetry model' },
  { path:'server/src/core/platforms/registry.js', mod:'core', desc:'Platform registry' },
  { path:'server/src/core/runtime/domain-context.js', mod:'core', desc:'Plugin context builder' },
  { path:'server/src/core/runtime/load-domains.js', mod:'core', desc:'Domain plugin loader' },
  { path:'server/src/core/runtime/register-shutdown.js', mod:'core', desc:'Graceful shutdown handler' },
  { path:'server/src/core/runtime/start-api-runtime.js', mod:'core', desc:'API startup orchestration' },
  { path:'server/src/core/runtime/start-worker-runtime.js', mod:'core', desc:'Worker startup orchestration' },
  { path:'server/src/core/runtime/entrypoints/index.js', mod:'core', desc:'Main entry point' },
  { path:'server/src/core/runtime/entrypoints/app.js', mod:'core', desc:'Express app factory' },
  { path:'server/src/core/runtime/entrypoints/start-api.js', mod:'core', desc:'API role shim' },
  { path:'server/src/core/runtime/entrypoints/start-worker.js', mod:'core', desc:'Worker role shim' },
  { path:'server/src/core/utils/account-profile.js', mod:'core', desc:'Account slug derivation' },
  { path:'server/src/core/utils/validation.js', mod:'core', desc:'URL validation, isTweetUrl, getPostUrlInfo' },

  // Platforms Team
  { path:'server/src/platforms/x/index.js', mod:'platforms-s', desc:'X (Twitter) platform definition' },
  { path:'server/src/platforms/tiktok/index.js', mod:'platforms-s', desc:'TikTok platform definition' },

  // Services Team
  { path:'server/src/services/extractor-service.js', mod:'services', desc:'Playwright-based media URL extraction' },
  { path:'server/src/services/downloader-service.js', mod:'services', desc:'Direct fetch + ffmpeg HLS download' },
  { path:'server/src/services/playwright-adapter.js', mod:'services', desc:'Singleton persistent Chromium context' },

  // Worker Team
  { path:'server/src/worker/queue.js', mod:'worker', desc:'Queue worker: 1s interval, atomic claim, heartbeat' },
  { path:'server/src/worker/process-job.js', mod:'worker', desc:'Extract, pick media, download, save pipeline' },
  { path:'server/src/worker/recovery.js', mod:'worker', desc:'Recover stale running jobs on restart' },
];

/* ── Dependency edges ──────────────────────────────── */
const DEPS = [
  // Client internal
  { from:'shell', to:'pages', label:'renders' },
  { from:'shell', to:'data', label:'imports' },
  { from:'pages', to:'intake', label:'embeds' },
  { from:'pages', to:'dashboard', label:'embeds' },
  { from:'pages', to:'activity', label:'embeds' },
  { from:'dashboard', to:'data', label:'uses hooks' },
  { from:'intake', to:'data', label:'calls API' },
  { from:'activity', to:'data', label:'SSE stream' },
  { from:'intake', to:'client-plat', label:'classifies' },
  { from:'data', to:'api', label:'HTTP /api/*', cross:true },

  // Server internal
  { from:'api', to:'core', label:'uses models, utils' },
  { from:'worker', to:'core', label:'uses models, transitions' },
  { from:'worker', to:'services', label:'extract + download' },
  { from:'services', to:'core', label:'uses logger, config' },
  { from:'services', to:'platforms-s', label:'platform-specific logic' },
  { from:'core', to:'platforms-s', label:'loads registry' },
  { from:'api', to:'worker', label:'enqueues jobs', cross:true },
];

/* ══════════════════════════════════════════════════════════════════
   GLOBAL STATE
   ══════════════════════════════════════════════════════════════════ */

let currentScope = 'full';
let currentView = 0;
const viewRendered = {};

const VIEWS = [
  { id:'topdown',    label:'Top-Down',        icon:'\u2B07' },
  { id:'filemap',    label:'File Map',         icon:'\uD83D\uDDFA' },
  { id:'sunburst',   label:'Sunburst',         icon:'\u2600' },
  { id:'bubble',     label:'Bubble Map',       icon:'\u2B55' },
  { id:'depflow',    label:'Dependency Flow',  icon:'\u27A1' },
  { id:'grid',       label:'Grid Matrix',      icon:'\u25A6' },
  { id:'archlayers', label:'Arch Layers',      icon:'\u2630' },
  { id:'filetree',   label:'File Tree',        icon:'\uD83C\uDF33' },
  { id:'mindmap',    label:'Mind Map',         icon:'\uD83E\uDDE0' },
  { id:'network',    label:'Network',          icon:'\uD83D\uDD17' },
  { id:'teams',      label:'Teams',            icon:'\uD83D\uDC65' },
];

/* ══════════════════════════════════════════════════════════════════
   HELPERS
   ══════════════════════════════════════════════════════════════════ */

function fileSide(f) {
  if (f.path.startsWith('server/')) return 'server';
  if (f.path.startsWith('client/')) return 'client';
  return 'root';
}

function filterFiles(scope) {
  if (scope === 'full') return FILES;
  return FILES.filter(f => {
    const s = fileSide(f);
    if (scope === 'server') return s === 'server';
    if (scope === 'client') return s === 'client' || s === 'root';
    return true;
  });
}

function filterModules(scope) {
  if (scope === 'full') return Object.entries(MODULES);
  return Object.entries(MODULES).filter(([k, m]) => {
    if (scope === 'server') return m.side === 'server' || m.side === 'root';
    if (scope === 'client') return m.side === 'client' || m.side === 'root';
    return true;
  });
}

function filterDeps(scope) {
  const mods = new Set(filterModules(scope).map(([k]) => k));
  return DEPS.filter(d => mods.has(d.from) && mods.has(d.to));
}

function filesByMod(scope) {
  const ff = filterFiles(scope);
  const map = {};
  ff.forEach(f => {
    if (!map[f.mod]) map[f.mod] = [];
    map[f.mod].push(f);
  });
  return map;
}

function basename(p) { return p.split('/').pop(); }

function svgEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  if (attrs) Object.entries(attrs).forEach(([k,v]) => el.setAttribute(k, v));
  return el;
}

function htmlEl(tag, cls, html) {
  const el = document.createElement(tag);
  if (cls) el.className = cls;
  if (html) el.innerHTML = html;
  return el;
}

/* ── Tooltip ─────────────────────────── */
const ttEl = document.getElementById('tooltip');
function showTip(e, file) {
  const m = MODULES[file.mod];
  ttEl.innerHTML = `<div class="tt-path">${file.path}</div><span class="tt-mod" style="background:${m.color}">${m.label}</span><div class="tt-desc">${file.desc}</div>`;
  ttEl.classList.add('visible');
  moveTip(e);
}
function showTipRaw(e, html) {
  ttEl.innerHTML = html;
  ttEl.classList.add('visible');
  moveTip(e);
}
function moveTip(e) {
  let x = e.clientX + 14, y = e.clientY + 14;
  if (x + 340 > window.innerWidth) x = e.clientX - 350;
  if (y + 100 > window.innerHeight) y = e.clientY - 110;
  ttEl.style.left = x + 'px';
  ttEl.style.top = y + 'px';
}
function hideTip() { ttEl.classList.remove('visible'); }
document.addEventListener('mousemove', e => { if (ttEl.classList.contains('visible')) moveTip(e); });

/* ── Zoom+Pan helper ─────────────────── */
function setupZoomPan(viewport, svgElement, pctEl) {
  let scale = 1, tx = 0, ty = 0, dragging = false, sx, sy, stx, sty;
  const update = () => {
    svgElement.style.transform = `translate(${tx}px,${ty}px) scale(${scale})`;
    if (pctEl) pctEl.textContent = Math.round(scale * 100) + '%';
  };
  viewport.addEventListener('wheel', e => {
    e.preventDefault();
    const d = e.deltaY > 0 ? 0.9 : 1.1;
    const ns = Math.max(0.1, Math.min(5, scale * d));
    const r = ns / scale;
    const rect = viewport.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    tx = mx - r * (mx - tx);
    ty = my - r * (my - ty);
    scale = ns;
    update();
  }, { passive: false });
  viewport.addEventListener('mousedown', e => {
    if (e.button !== 0) return;
    dragging = true; sx = e.clientX; sy = e.clientY; stx = tx; sty = ty;
    viewport.classList.add('is-dragging');
  });
  window.addEventListener('mousemove', e => {
    if (!dragging) return;
    tx = stx + (e.clientX - sx);
    ty = sty + (e.clientY - sy);
    update();
  });
  window.addEventListener('mouseup', () => { dragging = false; viewport.classList.remove('is-dragging'); });
  return {
    zoomIn() { scale = Math.min(5, scale * 1.2); update(); },
    zoomOut() { scale = Math.max(0.1, scale / 1.2); update(); },
    reset() { scale = 1; tx = 0; ty = 0; update(); },
    fitTo(w, h) {
      const rect = viewport.getBoundingClientRect();
      scale = Math.min(rect.width / w, (rect.height || 600) / h, 1.5) * 0.9;
      tx = (rect.width - w * scale) / 2;
      ty = 10;
      update();
    }
  };
}

/* ══════════════════════════════════════════════════════════════════
   STATS BAR
   ══════════════════════════════════════════════════════════════════ */

function updateStats() {
  const ff = filterFiles(currentScope);
  const mods = new Set(ff.map(f => f.mod));
  const bar = document.getElementById('stats-bar');
  let html = `<div class="stat"><span class="stat-val">${ff.length}</span><span class="stat-label">Files</span></div>`;
  html += `<div class="stat"><span class="stat-val">${mods.size}</span><span class="stat-label">Modules</span></div>`;
  if (currentScope === 'full') {
    const sc = ff.filter(f => fileSide(f) === 'client').length;
    const ss = ff.filter(f => fileSide(f) === 'server').length;
    html += `<div class="stat"><span class="stat-val">${sc}</span><span class="stat-label">Client</span></div>`;
    html += `<div class="stat"><span class="stat-val">${ss}</span><span class="stat-label">Server</span></div>`;
  }
  bar.innerHTML = html;
}

/* ══════════════════════════════════════════════════════════════════
   LEGEND
   ══════════════════════════════════════════════════════════════════ */

function buildLegend(scope) {
  const mods = filterModules(scope);
  let html = '<span class="legend-strip-title">Team / Module Ownership</span>';
  mods.forEach(([k, m]) => {
    html += `<span class="legend-chip"><span class="lc-dot" style="background:${m.color}"></span>${m.label}</span>`;
  });
  return html;
}

/* ══════════════════════════════════════════════════════════════════
   TAB BAR + VIEW CONTAINERS
   ══════════════════════════════════════════════════════════════════ */

function buildUI() {
  const tabBar = document.getElementById('tab-bar');
  const viewWrap = document.getElementById('view-wrap');
  VIEWS.forEach((v, i) => {
    const tab = htmlEl('div', 'tab' + (i === 0 ? ' active' : ''));
    tab.innerHTML = `<span class="tab-icon">${v.icon}</span>${v.label}`;
    tab.addEventListener('click', () => switchView(i));
    tabBar.appendChild(tab);

    const view = htmlEl('div', 'view' + (i === 0 ? ' active' : ''));
    view.id = 'view-' + v.id;
    viewWrap.appendChild(view);
  });
  updateStats();
  renderView(0);
}

function switchView(i) {
  document.querySelectorAll('.tab').forEach((t, j) => t.classList.toggle('active', j === i));
  document.querySelectorAll('.view').forEach((v, j) => v.classList.toggle('active', j === i));
  currentView = i;
  renderView(i);
}

function setScope(s) {
  currentScope = s;
  document.querySelectorAll('.scope-btn').forEach(b => b.classList.toggle('active', b.dataset.scope === s));
  updateStats();
  // Force re-render
  Object.keys(viewRendered).forEach(k => viewRendered[k] = false);
  renderView(currentView);
}

function renderView(i) {
  const key = i + '-' + currentScope;
  if (viewRendered[key]) return;
  viewRendered[key] = true;
  const renderers = [renderTopDown, renderFileMap, renderSunburst, renderBubble, renderDepFlow, renderGrid, renderArchLayers, renderFileTree, renderMindMap, renderNetwork, renderTeams];
  renderers[i](currentScope);
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 1: TOP-DOWN
   ══════════════════════════════════════════════════════════════════ */

function renderTopDown(scope) {
  const container = document.getElementById('view-topdown');

  const layers_full = [
    { id:'user', label:'User', sub:'Browser', color:'#64748b', mods:[] },
    { id:'shell', label:'App Shell', sub:'Hash Router', color:MODULES.shell.color, mods:['shell'] },
    { id:'features', label:'Features', sub:'Intake + Dashboard + Activity', color:'#f59e0b', mods:['intake','dashboard','activity','pages'] },
    { id:'data', label:'Data Layer', sub:'Hooks + API Wrapper', color:MODULES.data.color, mods:['data','client-lib','client-plat'] },
    { id:'boundary', label:'API BOUNDARY', sub:'/api/* proxy (Vite \u2192 :4000)', color:'#f43f5e', mods:[] },
    { id:'api', label:'API Routes', sub:'jobs, contacts, retry, status', color:MODULES.api.color, mods:['api'] },
    { id:'core', label:'Core', sub:'Config, Models, Dispatch, Runtime', color:MODULES.core.color, mods:['core'] },
    { id:'worker', label:'Worker', sub:'Queue + Pipeline + Recovery', color:MODULES.worker.color, mods:['worker'] },
    { id:'services', label:'Services', sub:'Extractor + Downloader + Playwright', color:MODULES.services.color, mods:['services'] },
    { id:'platforms', label:'Platforms', sub:'X + TikTok definitions', color:MODULES['platforms-s'].color, mods:['platforms-s'] },
    { id:'db', label:'MongoDB', sub:'Atlas + Mongoose', color:'#22c55e', mods:[] },
  ];

  let layers;
  if (scope === 'client') {
    layers = layers_full.filter(l => ['user','shell','features','data','boundary'].includes(l.id));
  } else if (scope === 'server') {
    layers = layers_full.filter(l => ['boundary','api','core','worker','services','platforms','db'].includes(l.id));
  } else {
    layers = layers_full;
  }

  const W = 900, nodeW = 260, nodeH = 56, gap = 28;
  const H = layers.length * (nodeH + gap) + 40;
  const cx = W / 2;

  let html = `<div class="view-subtitle">Vertical architecture flow \u2014 data flows top to bottom</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="zoom-viewport" id="td-vp" style="max-height:calc(100vh - 280px)">`;
  html += `<svg id="td-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
  html += `<defs><marker id="arrowhead" viewBox="0 0 10 8" refX="9" refY="4" markerWidth="8" markerHeight="6" orient="auto"><path d="M0,0 L10,4 L0,8 Z" fill="#64748b"/></marker></defs>`;

  layers.forEach((l, i) => {
    const y = 20 + i * (nodeH + gap);
    const x = cx - nodeW / 2;

    // Arrow from previous
    if (i > 0) {
      const py = 20 + (i - 1) * (nodeH + gap) + nodeH;
      html += `<path class="td-arrow" d="M${cx},${py} L${cx},${y}" />`;
    }

    const isBoundary = l.id === 'boundary';
    const rx = isBoundary ? 0 : 10;
    const fillOp = isBoundary ? 0.15 : 0.12;
    const strokeDash = isBoundary ? 'stroke-dasharray="6,4"' : '';

    html += `<g class="td-node" data-layer="${l.id}" onmouseenter="showTipRaw(event,'<b>${l.label}</b><br>${l.sub}')" onmouseleave="hideTip()">`;
    html += `<rect x="${x}" y="${y}" width="${nodeW}" height="${nodeH}" rx="${rx}" fill="${l.color}" fill-opacity="${fillOp}" stroke="${l.color}" stroke-width="1.5" ${strokeDash}/>`;
    html += `<text class="td-label" x="${cx}" y="${y + 22}">${l.label}</text>`;
    html += `<text class="td-sublabel" x="${cx}" y="${y + 38}">${l.sub}</text>`;
    html += `</g>`;
  });

  html += `</svg>`;
  html += `<div class="zoom-controls"><button onclick="tdZoom.zoomOut()">\u2212</button><span class="zoom-pct" id="td-pct">100%</span><button onclick="tdZoom.zoomIn()">+</button><button onclick="tdZoom.reset()" title="Reset">\u21BA</button></div>`;
  html += `</div>`;

  container.innerHTML = html;

  requestAnimationFrame(() => {
    const vp = document.getElementById('td-vp');
    const svg = document.getElementById('td-svg');
    const pct = document.getElementById('td-pct');
    if (vp && svg) window.tdZoom = setupZoomPan(vp, svg, pct);
  });
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 2: FILE MAP (SVG Node Graph)
   ══════════════════════════════════════════════════════════════════ */

function renderFileMap(scope) {
  const container = document.getElementById('view-filemap');
  const ff = filterFiles(scope);

  // Build tree
  const root = { name:'x-dl-vite-express-mongo', children:{}, _files:[] };
  ff.forEach(f => {
    const parts = f.path.split('/');
    let node = root;
    parts.forEach((p, i) => {
      if (i === parts.length - 1) {
        node._files.push(f);
      } else {
        if (!node.children[p]) node.children[p] = { name:p, children:{}, _files:[] };
        node = node.children[p];
      }
    });
  });

  const folderW = 180, folderH = 44, fileW = 160, fileH = 34;
  const hGap = 30, vGap = 90;

  // Flatten for layout
  let nodeId = 0;
  const nodes = [];
  const edges = [];
  const expandState = {};

  function layoutTree(treeNode, depth, startDepth) {
    const id = nodeId++;
    const isFolder = Object.keys(treeNode.children).length > 0 || treeNode._files.length > 0;
    const expanded = depth < startDepth + 2;
    const w = isFolder ? folderW : fileW;
    const h = isFolder ? folderH : fileH;
    const mod = treeNode._files.length > 0 ? treeNode._files[0].mod : null;
    const n = { id, name:treeNode.name, isFolder, w, h, x:0, y:depth * vGap, depth, children:[], mod, files:treeNode._files, expanded };
    nodes.push(n);

    if (expanded) {
      const childKeys = Object.keys(treeNode.children);
      const fileNodes = treeNode._files.map(f => {
        const fid = nodeId++;
        const fn = { id:fid, name:basename(f.path), isFolder:false, w:fileW, h:fileH, x:0, y:(depth+1)*vGap, depth:depth+1, children:[], mod:f.mod, files:[f], expanded:false };
        nodes.push(fn);
        edges.push({ from:id, to:fid });
        n.children.push(fn);
        return fn;
      });

      childKeys.forEach(k => {
        const child = layoutTree(treeNode.children[k], depth + 1, startDepth);
        edges.push({ from:id, to:child.id });
        n.children.push(child);
      });
    }

    return n;
  }

  layoutTree(root, 0, 0);

  // Calculate widths bottom-up
  function calcWidth(n) {
    if (n.children.length === 0) return n.w;
    let total = 0;
    n.children.forEach((c, i) => {
      if (i > 0) total += hGap;
      total += calcWidth(c);
    });
    n._totalW = Math.max(n.w, total);
    return n._totalW;
  }
  const rootNode = nodes[0];
  const totalW = calcWidth(rootNode);

  // Position nodes
  function positionNode(n, leftX) {
    if (n.children.length === 0) {
      n.x = leftX + (n._totalW || n.w) / 2 - n.w / 2;
      return;
    }
    let cx = leftX;
    n.children.forEach((c, i) => {
      if (i > 0) cx += hGap;
      c._totalW = c._totalW || c.w;
      positionNode(c, cx);
      cx += c._totalW;
    });
    // Center parent over children
    const firstChild = n.children[0];
    const lastChild = n.children[n.children.length - 1];
    const childCenter = (firstChild.x + firstChild.w / 2 + lastChild.x + lastChild.w / 2) / 2;
    n.x = childCenter - n.w / 2;
  }
  rootNode._totalW = totalW;
  positionNode(rootNode, 20);

  const maxDepth = Math.max(...nodes.map(n => n.depth));
  const svgW = totalW + 60;
  const svgH = (maxDepth + 1) * vGap + 60;

  let html = `<div class="view-subtitle">Top-down visual node graph \u2014 click folders to explore</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="zoom-viewport" id="fm-vp">`;
  html += `<svg id="fm-svg" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">`;

  // Draw edges
  edges.forEach(e => {
    const from = nodes.find(n => n.id === e.from);
    const to = nodes.find(n => n.id === e.to);
    if (!from || !to) return;
    const x1 = from.x + from.w / 2, y1 = from.y + from.h;
    const x2 = to.x + to.w / 2, y2 = to.y;
    const my = (y1 + y2) / 2;
    html += `<path d="M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}" fill="none" stroke="#475569" stroke-width="1.2" opacity="0.4"/>`;
  });

  // Draw nodes
  nodes.forEach(n => {
    const m = n.mod ? MODULES[n.mod] : null;
    const color = m ? m.color : '#64748b';
    const fillOp = n.isFolder ? 0.15 : 0.1;
    const rx = n.isFolder ? 8 : 6;
    const desc = n.files.length > 0 ? n.files[0].desc : (n.isFolder ? 'Folder' : '');
    const modLabel = m ? m.label : '';
    const ttHtml = `<b>${n.name}</b>${modLabel ? '<br><span style="color:'+color+'">'+modLabel+'</span>' : ''}${desc ? '<br>'+desc : ''}`;

    html += `<g class="td-node" onmouseenter="showTipRaw(event,\`${ttHtml.replace(/`/g,"'")}\`)" onmouseleave="hideTip()">`;
    html += `<rect x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="${rx}" fill="${color}" fill-opacity="${fillOp}" stroke="${color}" stroke-width="1"/>`;
    const label = n.name.length > 20 ? n.name.substring(0, 18) + '..' : n.name;
    const icon = n.isFolder ? '\uD83D\uDCC1 ' : '';
    html += `<text x="${n.x + n.w/2}" y="${n.y + n.h/2 + 4}" text-anchor="middle" fill="${n.isFolder ? '#f8fafc' : '#e2e8f0'}" font-size="${n.isFolder ? 11 : 10}" font-weight="${n.isFolder ? 600 : 400}" font-family="'Segoe UI',system-ui,sans-serif">${icon}${label}</text>`;
    html += `</g>`;
  });

  html += `</svg>`;
  html += `<div class="zoom-controls"><button onclick="fmZoom.zoomOut()">\u2212</button><span class="zoom-pct" id="fm-pct">100%</span><button onclick="fmZoom.zoomIn()">+</button><button onclick="fmZoom.reset()" title="Reset">\u21BA</button></div>`;
  html += `</div>`;

  container.innerHTML = html;

  requestAnimationFrame(() => {
    const vp = document.getElementById('fm-vp');
    const svg = document.getElementById('fm-svg');
    const pct = document.getElementById('fm-pct');
    if (vp && svg) {
      window.fmZoom = setupZoomPan(vp, svg, pct);
      fmZoom.fitTo(svgW, svgH);
    }
  });
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 3: SUNBURST
   ══════════════════════════════════════════════════════════════════ */

function renderSunburst(scope) {
  const container = document.getElementById('view-sunburst');
  const ff = filterFiles(scope);

  // Build hierarchy
  const root = { name:'root', children:{}, count:0 };
  ff.forEach(f => {
    const parts = f.path.split('/');
    let node = root;
    parts.forEach((p, i) => {
      if (!node.children[p]) node.children[p] = { name:p, children:{}, count:0, mod:f.mod };
      node = node.children[p];
    });
    node.count++;
  });

  function countLeaves(n) {
    const keys = Object.keys(n.children);
    if (keys.length === 0) return Math.max(1, n.count);
    let total = 0;
    keys.forEach(k => total += countLeaves(n.children[k]));
    return total;
  }

  const size = 600, cx = size/2, cy = size/2;
  const maxR = size/2 - 20, minR = 50;
  const maxDepth = 5;
  const ringW = (maxR - minR) / maxDepth;

  let svgContent = '';

  function drawArc(node, depth, startAngle, endAngle) {
    if (depth > maxDepth) return;
    const innerR = minR + (depth - 1) * ringW;
    const outerR = minR + depth * ringW;
    const m = node.mod ? MODULES[node.mod] : null;
    const color = m ? m.color : '#475569';
    const angleSpan = endAngle - startAngle;

    if (angleSpan > 0.01) {
      const x1i = cx + innerR * Math.cos(startAngle);
      const y1i = cy + innerR * Math.sin(startAngle);
      const x2i = cx + innerR * Math.cos(endAngle);
      const y2i = cy + innerR * Math.sin(endAngle);
      const x1o = cx + outerR * Math.cos(startAngle);
      const y1o = cy + outerR * Math.sin(startAngle);
      const x2o = cx + outerR * Math.cos(endAngle);
      const y2o = cy + outerR * Math.sin(endAngle);
      const largeArc = angleSpan > Math.PI ? 1 : 0;

      const d = `M${x1i},${y1i} A${innerR},${innerR} 0 ${largeArc},1 ${x2i},${y2i} L${x2o},${y2o} A${outerR},${outerR} 0 ${largeArc},0 ${x1o},${y1o} Z`;
      const modLabel = m ? m.label : '';
      svgContent += `<path class="sb-arc" d="${d}" fill="${color}" fill-opacity="0.6" stroke="#0f172a" stroke-width="1" onmouseenter="showTipRaw(event,'<b>${node.name}</b>${modLabel ? '<br>'+modLabel : ''}')" onmouseleave="hideTip()"/>`;
    }

    // Children
    const keys = Object.keys(node.children);
    const total = countLeaves(node);
    let angle = startAngle;
    keys.forEach(k => {
      const child = node.children[k];
      const childTotal = countLeaves(child);
      const childAngle = (childTotal / total) * angleSpan;
      drawArc(child, depth + 1, angle, angle + childAngle);
      angle += childAngle;
    });
  }

  drawArc(root, 0, 0, 2 * Math.PI);

  // Center label
  svgContent += `<circle cx="${cx}" cy="${cy}" r="${minR}" fill="#0f172a"/>`;
  svgContent += `<text x="${cx}" y="${cy - 6}" text-anchor="middle" fill="#f8fafc" font-size="13" font-weight="700" font-family="'Segoe UI',system-ui,sans-serif">Media Vault</text>`;
  svgContent += `<text x="${cx}" y="${cy + 12}" text-anchor="middle" fill="#94a3b8" font-size="10" font-family="'Segoe UI',system-ui,sans-serif">${ff.length} files</text>`;

  let html = `<div class="view-subtitle">Concentric rings \u2014 center is root, depth increases outward</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="sb-viewport"><svg viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">${svgContent}</svg></div>`;
  container.innerHTML = html;
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 4: BUBBLE MAP
   ══════════════════════════════════════════════════════════════════ */

function renderBubble(scope) {
  const container = document.getElementById('view-bubble');
  const byMod = filesByMod(scope);
  const mods = filterModules(scope);

  // Simple circle packing
  const W = 800, H = 600;
  const bubbles = mods.map(([k, m]) => {
    const count = (byMod[k] || []).length;
    return { id:k, label:m.label, color:m.color, count, r:Math.max(30, Math.sqrt(count) * 28) };
  }).filter(b => b.count > 0);

  // Position with simple force
  const totalR = bubbles.reduce((s, b) => s + b.r, 0);
  bubbles.forEach((b, i) => {
    const angle = (i / bubbles.length) * 2 * Math.PI;
    const dist = totalR / (2 * Math.PI) * 0.7;
    b.x = W / 2 + Math.cos(angle) * dist;
    b.y = H / 2 + Math.sin(angle) * dist;
  });

  // Simple collision resolution
  for (let iter = 0; iter < 60; iter++) {
    for (let i = 0; i < bubbles.length; i++) {
      for (let j = i + 1; j < bubbles.length; j++) {
        const a = bubbles[i], b = bubbles[j];
        const dx = b.x - a.x, dy = b.y - a.y;
        const dist = Math.sqrt(dx * dx + dy * dy) || 1;
        const minDist = a.r + b.r + 8;
        if (dist < minDist) {
          const push = (minDist - dist) / 2;
          const nx = dx / dist, ny = dy / dist;
          a.x -= nx * push; a.y -= ny * push;
          b.x += nx * push; b.y += ny * push;
        }
      }
      // Pull toward center
      const b = bubbles[i];
      b.x += (W / 2 - b.x) * 0.02;
      b.y += (H / 2 - b.y) * 0.02;
    }
  }

  let svg = '';
  bubbles.forEach(b => {
    svg += `<g class="bub-circle" onmouseenter="showTipRaw(event,'<b>${b.label}</b><br>${b.count} files')" onmouseleave="hideTip()">`;
    svg += `<circle cx="${b.x}" cy="${b.y}" r="${b.r}" fill="${b.color}" fill-opacity="0.2" stroke="${b.color}" stroke-width="1.5"/>`;
    const fontSize = Math.max(9, Math.min(13, b.r / 3));
    svg += `<text class="bub-label" x="${b.x}" y="${b.y - 4}" font-size="${fontSize}">${b.label}</text>`;
    svg += `<text x="${b.x}" y="${b.y + fontSize}" text-anchor="middle" fill="#94a3b8" font-size="${fontSize - 2}" font-family="'Segoe UI',system-ui,sans-serif">${b.count} files</text>`;
    svg += `</g>`;
  });

  let html = `<div class="view-subtitle">Nested circles sized by file count per team</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="zoom-viewport" id="bub-vp"><svg id="bub-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${svg}</svg>`;
  html += `<div class="zoom-controls"><button onclick="bubZoom.zoomOut()">\u2212</button><span class="zoom-pct" id="bub-pct">100%</span><button onclick="bubZoom.zoomIn()">+</button><button onclick="bubZoom.reset()" title="Reset">\u21BA</button></div>`;
  html += `</div>`;
  container.innerHTML = html;

  requestAnimationFrame(() => {
    const vp = document.getElementById('bub-vp');
    const svg = document.getElementById('bub-svg');
    const pct = document.getElementById('bub-pct');
    if (vp && svg) window.bubZoom = setupZoomPan(vp, svg, pct);
  });
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 5: DEPENDENCY FLOW
   ══════════════════════════════════════════════════════════════════ */

function renderDepFlow(scope) {
  const container = document.getElementById('view-depflow');
  const mods = filterModules(scope);
  const deps = filterDeps(scope);
  const modMap = Object.fromEntries(mods);

  const W = 1000, nodeW = 140, nodeH = 50;
  // Position modules in columns by side
  const clientMods = mods.filter(([k, m]) => m.side === 'client');
  const serverMods = mods.filter(([k, m]) => m.side === 'server');
  const rootMods = mods.filter(([k, m]) => m.side === 'root');

  const positions = {};
  const colX = { client: 100, root: 430, server: 650 };
  const all = [
    ...rootMods.map(([k]) => ({ k, col:'root' })),
    ...clientMods.map(([k]) => ({ k, col:'client' })),
    ...serverMods.map(([k]) => ({ k, col:'server' })),
  ];

  // Group by column and distribute vertically
  const cols = {};
  all.forEach(a => {
    if (!cols[a.col]) cols[a.col] = [];
    cols[a.col].push(a.k);
  });

  Object.entries(cols).forEach(([col, keys]) => {
    keys.forEach((k, i) => {
      positions[k] = { x: colX[col], y: 60 + i * 80 };
    });
  });

  const maxY = Math.max(...Object.values(positions).map(p => p.y)) + nodeH + 40;
  const H = Math.max(500, maxY);

  let svg = `<defs><marker id="dep-arrow" viewBox="0 0 10 8" refX="9" refY="4" markerWidth="7" markerHeight="5" orient="auto"><path d="M0,0 L10,4 L0,8 Z" fill="#64748b"/></marker></defs>`;

  // Draw edges
  deps.forEach(d => {
    const p1 = positions[d.from], p2 = positions[d.to];
    if (!p1 || !p2) return;
    const x1 = p1.x + nodeW, y1 = p1.y + nodeH / 2;
    const x2 = p2.x, y2 = p2.y + nodeH / 2;
    const mx = (x1 + x2) / 2;
    const color = d.cross ? '#f43f5e' : '#64748b';
    const dash = d.cross ? 'stroke-dasharray="6,4"' : '';
    svg += `<path class="dep-edge" d="M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}" stroke="${color}" ${dash} marker-end="url(#dep-arrow)" onmouseenter="showTipRaw(event,'${d.from} \u2192 ${d.to}<br>${d.label}')" onmouseleave="hideTip()"/>`;
  });

  // Draw nodes
  mods.forEach(([k, m]) => {
    const p = positions[k];
    if (!p) return;
    const byMd = filesByMod(scope);
    const count = (byMd[k] || []).length;
    svg += `<g class="dep-node" onmouseenter="showTipRaw(event,'<b>${m.label}</b><br>${m.path}<br>${count} files')" onmouseleave="hideTip()">`;
    svg += `<rect x="${p.x}" y="${p.y}" width="${nodeW}" height="${nodeH}" rx="8" fill="${m.color}" fill-opacity="0.15" stroke="${m.color}" stroke-width="1.5"/>`;
    svg += `<text x="${p.x + nodeW/2}" y="${p.y + nodeH/2 + 4}" text-anchor="middle" fill="#f8fafc" font-size="11" font-weight="600" font-family="'Segoe UI',system-ui,sans-serif">${m.label}</text>`;
    svg += `</g>`;
  });

  // Column headers
  if (scope === 'full') {
    [['CLIENT', colX.client + nodeW/2], ['SERVER', colX.server + nodeW/2]].forEach(([label, x]) => {
      svg += `<text x="${x}" y="30" text-anchor="middle" fill="#64748b" font-size="11" font-weight="700" letter-spacing="0.1em" font-family="'Segoe UI',system-ui,sans-serif">${label}</text>`;
    });
  }

  let html = `<div class="view-subtitle">Left-to-right dependency flow \u2014 dashed lines cross the API boundary</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="zoom-viewport" id="dep-vp"><svg id="dep-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${svg}</svg>`;
  html += `<div class="zoom-controls"><button onclick="depZoom.zoomOut()">\u2212</button><span class="zoom-pct" id="dep-pct">100%</span><button onclick="depZoom.zoomIn()">+</button><button onclick="depZoom.reset()" title="Reset">\u21BA</button></div>`;
  html += `</div>`;
  container.innerHTML = html;

  requestAnimationFrame(() => {
    const vp = document.getElementById('dep-vp');
    const svg = document.getElementById('dep-svg');
    const pct = document.getElementById('dep-pct');
    if (vp && svg) window.depZoom = setupZoomPan(vp, svg, pct);
  });
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 6: GRID MATRIX
   ══════════════════════════════════════════════════════════════════ */

function renderGrid(scope) {
  const container = document.getElementById('view-grid');
  const byMod = filesByMod(scope);
  const mods = filterModules(scope);

  const concerns = ['Config', 'Models / Data', 'Logic / Services', 'UI / Routes', 'Styles', 'Utilities'];

  function classifyFile(f) {
    const p = f.path.toLowerCase();
    if (p.endsWith('.css')) return 'Styles';
    if (p.includes('config') || p.includes('.env') || p.includes('vite.config') || p.includes('package.json') || p.includes('capabilities')) return 'Config';
    if (p.includes('model') || p.includes('schema') || p.includes('/data/') || p.includes('job-status')) return 'Models / Data';
    if (p.includes('utils') || p.includes('validation') || p.includes('account-profile') || p.includes('helpers')) return 'Utilities';
    if (p.includes('route') || p.includes('component') || p.includes('.jsx') || p.includes('Page') || p.includes('Form') || p.includes('Panel') || p.includes('Modal') || p.includes('List') || p.includes('Row')) return 'UI / Routes';
    return 'Logic / Services';
  }

  let html = `<div class="view-subtitle">Teams crossed with architectural concerns</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div style="overflow-x:auto;max-height:calc(100vh - 280px);overflow-y:auto">`;
  html += `<table class="grid-table"><thead><tr><th>Team</th>`;
  concerns.forEach(c => html += `<th>${c}</th>`);
  html += `</tr></thead><tbody>`;

  mods.forEach(([k, m]) => {
    const files = byMod[k] || [];
    if (files.length === 0) return;
    html += `<tr><td><span class="grid-team"><span class="gt-dot" style="background:${m.color}"></span>${m.label}</span></td>`;
    concerns.forEach(c => {
      const cf = files.filter(f => classifyFile(f) === c);
      html += `<td>`;
      cf.forEach(f => {
        html += `<span class="grid-file" onmouseenter="showTip(event,FILES.find(ff=>ff.path==='${f.path}'))" onmouseleave="hideTip()">${basename(f.path)}</span>`;
      });
      html += `</td>`;
    });
    html += `</tr>`;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 7: ARCHITECTURE LAYERS
   ══════════════════════════════════════════════════════════════════ */

function renderArchLayers(scope) {
  const container = document.getElementById('view-archlayers');
  const byMod = filesByMod(scope);

  const layers_all = [
    { label:'App Shell + Entry', mods:['shell','root'], desc:'Root config, React entry, routing, global styles' },
    { label:'Page Components', mods:['pages'], desc:'Top-level page components and shared dialogs' },
    { label:'Features', mods:['intake','dashboard','activity'], desc:'Feature-sliced modules: intake, dashboard, activity' },
    { label:'Client Data Layer', mods:['data','client-lib','client-plat'], desc:'Hooks, API wrapper, shared client utilities' },
    { label:'API Routes', mods:['api'], desc:'HTTP route handlers for jobs, contacts, retry, status' },
    { label:'Core Infrastructure', mods:['core'], desc:'Config, models, dispatch, runtime, middleware, logging' },
    { label:'Worker Pipeline', mods:['worker'], desc:'Queue processing, job pipeline, stale recovery' },
    { label:'External Services', mods:['services'], desc:'Playwright extraction, ffmpeg download, browser adapter' },
    { label:'Platform Definitions', mods:['platforms-s'], desc:'X and TikTok platform plugins' },
  ];

  const layers = layers_all.filter(l => {
    if (scope === 'full') return true;
    return l.mods.some(mk => {
      const m = MODULES[mk];
      if (!m) return false;
      if (scope === 'server') return m.side === 'server' || m.side === 'root';
      if (scope === 'client') return m.side === 'client' || m.side === 'root';
      return true;
    });
  });

  let html = `<div class="view-subtitle">Horizontal stacks \u2014 click to expand and see files</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;

  layers.forEach((l, i) => {
    const files = l.mods.flatMap(mk => byMod[mk] || []);
    if (files.length === 0) return;
    const color = l.mods.length > 0 && MODULES[l.mods[0]] ? MODULES[l.mods[0]].color : '#64748b';
    html += `<div class="arch-layer${i < 3 ? ' open' : ''}" onclick="this.classList.toggle('open')">`;
    html += `<div class="arch-layer-header"><span class="arch-layer-dot" style="background:${color}"></span><span class="arch-layer-title">${l.label}</span><span class="arch-layer-desc">${l.desc} (${files.length} files)</span></div>`;
    html += `<div class="arch-layer-body">`;
    files.forEach(f => {
      const m = MODULES[f.mod];
      html += `<span class="arch-file" style="border-left:3px solid ${m.color}" onmouseenter="showTip(event,FILES.find(ff=>ff.path==='${f.path}'))" onmouseleave="hideTip()">${basename(f.path)}</span>`;
    });
    html += `</div></div>`;
  });

  container.innerHTML = html;
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 8: FILE TREE
   ══════════════════════════════════════════════════════════════════ */

function renderFileTree(scope) {
  const container = document.getElementById('view-filetree');
  const ff = filterFiles(scope);

  // Build tree structure
  const root = { name:'x-dl-vite-express-mongo', children:{}, file:null };
  ff.forEach(f => {
    const parts = f.path.split('/');
    let node = root;
    parts.forEach((p, i) => {
      if (i === parts.length - 1) {
        node.children[p] = { name:p, children:{}, file:f };
      } else {
        if (!node.children[p]) node.children[p] = { name:p, children:{}, file:null };
        node = node.children[p];
      }
    });
  });

  function renderTreeNode(node, prefix, isLast, depth) {
    let lines = '';
    const keys = Object.keys(node.children).sort((a, b) => {
      const aIsDir = Object.keys(node.children[a].children).length > 0;
      const bIsDir = Object.keys(node.children[b].children).length > 0;
      if (aIsDir !== bIsDir) return aIsDir ? -1 : 1;
      return a.localeCompare(b);
    });

    keys.forEach((k, i) => {
      const child = node.children[k];
      const last = i === keys.length - 1;
      const connector = last ? '\u2514\u2500\u2500 ' : '\u251C\u2500\u2500 ';
      const isDir = Object.keys(child.children).length > 0;
      const f = child.file;
      const m = f ? MODULES[f.mod] : null;

      let line = `<div class="ftree-line">`;
      line += `<span class="ftree-indent">${prefix}${connector}</span>`;
      line += `<span class="ftree-icon">${isDir ? '\uD83D\uDCC1' : '\uD83D\uDCC4'}</span>`;
      line += `<span class="ftree-name${isDir ? ' is-folder' : ''}" style="${m ? 'color:'+m.color : ''}">${k}</span>`;
      if (m) {
        line += `<span class="ftree-team-tag" style="background:${m.color}">${m.label}</span>`;
      }
      if (f && f.desc) {
        line += `<span class="ftree-annotation">${f.desc}</span>`;
      }
      line += `</div>`;
      lines += line;

      if (isDir) {
        const nextPrefix = prefix + (last ? '    ' : '\u2502   ');
        lines += renderTreeNode(child, nextPrefix, last, depth + 1);
      }
    });
    return lines;
  }

  let html = `<div class="view-subtitle">Monospace file tree with team annotations</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="ftree">`;
  html += `<div class="ftree-line"><span class="ftree-icon">\uD83D\uDCC1</span><span class="ftree-name is-folder" style="color:#f8fafc">x-dl-vite-express-mongo</span></div>`;
  html += renderTreeNode(root, '', false, 0);
  html += `</div>`;
  container.innerHTML = html;
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 9: MIND MAP
   ══════════════════════════════════════════════════════════════════ */

function renderMindMap(scope) {
  const container = document.getElementById('view-mindmap');
  const mods = filterModules(scope);
  const byMod = filesByMod(scope);

  const W = 1000, H = 700;
  const cx = W / 2, cy = H / 2;
  const innerR = 120, outerR = 280;

  let svg = '';

  // Center node
  svg += `<circle cx="${cx}" cy="${cy}" r="40" fill="#3b82f6" fill-opacity="0.2" stroke="#3b82f6" stroke-width="2"/>`;
  svg += `<text x="${cx}" y="${cy + 4}" text-anchor="middle" fill="#f8fafc" font-size="12" font-weight="700" font-family="'Segoe UI',system-ui,sans-serif">Media Vault</text>`;

  // Group by side
  const sides = { client:[], server:[], root:[] };
  mods.forEach(([k, m]) => {
    const s = m.side === 'root' ? 'root' : m.side;
    sides[s].push([k, m]);
  });

  let allNodes = [];
  let angleOffset = 0;

  // Client on left, server on right
  const sideConfig = scope === 'server' ?
    [['server', -Math.PI/2, Math.PI*1.5]] :
    scope === 'client' ?
    [['client', -Math.PI/2, Math.PI*1.5], ['root', Math.PI*1.2, Math.PI*1.5]] :
    [['client', Math.PI*0.6, Math.PI*1.4], ['server', -Math.PI*0.4, Math.PI*0.6], ['root', Math.PI*1.4, Math.PI*1.6]];

  sideConfig.forEach(([side, startA, endA]) => {
    const items = sides[side] || [];
    if (items.length === 0) return;
    const step = (endA - startA) / Math.max(1, items.length);

    items.forEach(([k, m], i) => {
      const angle = startA + step * (i + 0.5);
      const r = innerR + 60;
      const x = cx + r * Math.cos(angle);
      const y = cy + r * Math.sin(angle);
      const files = byMod[k] || [];

      // Edge to center
      svg += `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="${m.color}" stroke-width="1.5" opacity="0.3"/>`;

      // Module node
      const nodeW = 110, nodeH = 36;
      svg += `<g class="mm-node" onmouseenter="showTipRaw(event,'<b>${m.label}</b><br>${m.path}<br>${files.length} files')" onmouseleave="hideTip()">`;
      svg += `<rect x="${x - nodeW/2}" y="${y - nodeH/2}" width="${nodeW}" height="${nodeH}" rx="8" fill="${m.color}" fill-opacity="0.15" stroke="${m.color}" stroke-width="1.2"/>`;
      const shortLabel = m.label.length > 14 ? m.label.substring(0, 12) + '..' : m.label;
      svg += `<text x="${x}" y="${y + 4}" text-anchor="middle" fill="#f8fafc" font-size="10" font-weight="600" font-family="'Segoe UI',system-ui,sans-serif">${shortLabel}</text>`;
      svg += `</g>`;

      // File nodes
      if (files.length <= 8) {
        files.forEach((f, fi) => {
          const fAngle = angle + (fi - files.length / 2) * 0.12;
          const fr = r + 80;
          const fx = cx + fr * Math.cos(fAngle);
          const fy = cy + fr * Math.sin(fAngle);
          svg += `<line x1="${x}" y1="${y}" x2="${fx}" y2="${fy}" stroke="${m.color}" stroke-width="0.8" opacity="0.2"/>`;
          svg += `<circle cx="${fx}" cy="${fy}" r="4" fill="${m.color}" fill-opacity="0.5" onmouseenter="showTip(event,FILES.find(ff=>ff.path==='${f.path}'))" onmouseleave="hideTip()"/>`;
        });
      }
    });
  });

  let html = `<div class="view-subtitle">Radial mind map \u2014 center is project root, branches are teams</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="zoom-viewport" id="mm-vp"><svg id="mm-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${svg}</svg>`;
  html += `<div class="zoom-controls"><button onclick="mmZoom.zoomOut()">\u2212</button><span class="zoom-pct" id="mm-pct">100%</span><button onclick="mmZoom.zoomIn()">+</button><button onclick="mmZoom.reset()" title="Reset">\u21BA</button></div>`;
  html += `</div>`;
  container.innerHTML = html;

  requestAnimationFrame(() => {
    const vp = document.getElementById('mm-vp');
    const svg = document.getElementById('mm-svg');
    const pct = document.getElementById('mm-pct');
    if (vp && svg) window.mmZoom = setupZoomPan(vp, svg, pct);
  });
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 10: NETWORK (Force-directed)
   ══════════════════════════════════════════════════════════════════ */

function renderNetwork(scope) {
  const container = document.getElementById('view-network');
  const mods = filterModules(scope);
  const deps = filterDeps(scope);
  const byMod = filesByMod(scope);

  const W = 900, H = 600;

  // Create nodes
  const nodes = mods.map(([k, m], i) => {
    const count = (byMod[k] || []).length;
    const r = Math.max(18, Math.sqrt(count) * 10);
    const angle = (i / mods.length) * 2 * Math.PI;
    return {
      id: k, label: m.label, color: m.color, r,
      x: W / 2 + Math.cos(angle) * 180 + (Math.random() - 0.5) * 40,
      y: H / 2 + Math.sin(angle) * 180 + (Math.random() - 0.5) * 40,
      vx: 0, vy: 0, count
    };
  });

  const nodeMap = {};
  nodes.forEach(n => nodeMap[n.id] = n);

  // Simple force simulation
  for (let iter = 0; iter < 100; iter++) {
    // Repulsion
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i + 1; j < nodes.length; j++) {
        const a = nodes[i], b = nodes[j];
        let dx = b.x - a.x, dy = b.y - a.y;
        const dist = Math.sqrt(dx * dx + dy * dy) || 1;
        const force = 3000 / (dist * dist);
        const fx = (dx / dist) * force, fy = (dy / dist) * force;
        a.vx -= fx; a.vy -= fy;
        b.vx += fx; b.vy += fy;
      }
    }

    // Attraction from edges
    deps.forEach(d => {
      const a = nodeMap[d.from], b = nodeMap[d.to];
      if (!a || !b) return;
      const dx = b.x - a.x, dy = b.y - a.y;
      const dist = Math.sqrt(dx * dx + dy * dy) || 1;
      const force = (dist - 150) * 0.01;
      const fx = (dx / dist) * force, fy = (dy / dist) * force;
      a.vx += fx; a.vy += fy;
      b.vx -= fx; b.vy -= fy;
    });

    // Center gravity
    nodes.forEach(n => {
      n.vx += (W / 2 - n.x) * 0.005;
      n.vy += (H / 2 - n.y) * 0.005;
      n.vx *= 0.85; n.vy *= 0.85;
      n.x += n.vx; n.y += n.vy;
      n.x = Math.max(n.r + 10, Math.min(W - n.r - 10, n.x));
      n.y = Math.max(n.r + 10, Math.min(H - n.r - 10, n.y));
    });
  }

  let svg = '';

  // Edges
  deps.forEach(d => {
    const a = nodeMap[d.from], b = nodeMap[d.to];
    if (!a || !b) return;
    const color = d.cross ? '#f43f5e' : '#64748b';
    const dash = d.cross ? 'stroke-dasharray="6,3"' : '';
    svg += `<line class="net-edge" x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="${color}" ${dash} onmouseenter="showTipRaw(event,'${d.from} \u2192 ${d.to}<br>${d.label}')" onmouseleave="hideTip()"/>`;
  });

  // Nodes
  nodes.forEach(n => {
    svg += `<g class="net-node" onmouseenter="showTipRaw(event,'<b>${n.label}</b><br>${n.count} files')" onmouseleave="hideTip()">`;
    svg += `<circle cx="${n.x}" cy="${n.y}" r="${n.r}" fill="${n.color}" fill-opacity="0.2" stroke="${n.color}" stroke-width="1.5"/>`;
    const fontSize = Math.max(8, Math.min(11, n.r / 2.5));
    const shortLabel = n.label.length > 14 ? n.label.substring(0, 12) + '..' : n.label;
    svg += `<text x="${n.x}" y="${n.y + 3}" text-anchor="middle" fill="#f8fafc" font-size="${fontSize}" font-weight="600" font-family="'Segoe UI',system-ui,sans-serif">${shortLabel}</text>`;
    svg += `</g>`;
  });

  let html = `<div class="view-subtitle">Force-directed network graph \u2014 edges represent imports/dependencies</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;
  html += `<div class="zoom-viewport" id="net-vp"><svg id="net-svg" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${svg}</svg>`;
  html += `<div class="zoom-controls"><button onclick="netZoom.zoomOut()">\u2212</button><span class="zoom-pct" id="net-pct">100%</span><button onclick="netZoom.zoomIn()">+</button><button onclick="netZoom.reset()" title="Reset">\u21BA</button></div>`;
  html += `</div>`;
  container.innerHTML = html;

  requestAnimationFrame(() => {
    const vp = document.getElementById('net-vp');
    const svg = document.getElementById('net-svg');
    const pct = document.getElementById('net-pct');
    if (vp && svg) window.netZoom = setupZoomPan(vp, svg, pct);
  });
}

/* ══════════════════════════════════════════════════════════════════
   VIEW 11: TEAMS
   ══════════════════════════════════════════════════════════════════ */

function renderTeams(scope) {
  const container = document.getElementById('view-teams');
  const byMod = filesByMod(scope);
  const mods = filterModules(scope);

  // Separate backend teams from others
  const backendTeams = ['api','core','platforms-s','services','worker'];
  const clientTeams = ['intake','dashboard','activity','pages'];
  const supportMods = ['shell','data','client-lib','client-plat','root'];

  let html = `<div class="view-subtitle">Team ownership cards \u2014 hover files for details</div>`;
  html += `<div class="legend-strip">${buildLegend(scope)}</div>`;

  function renderSection(title, keys) {
    const filtered = keys.filter(k => {
      const m = MODULES[k];
      if (!m) return false;
      if (scope === 'server') return m.side === 'server' || m.side === 'root';
      if (scope === 'client') return m.side === 'client' || m.side === 'root';
      return true;
    }).filter(k => (byMod[k] || []).length > 0);

    if (filtered.length === 0) return '';
    let s = `<h3 style="color:var(--text-dim);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;margin:18px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)">${title}</h3>`;
    s += `<div class="teams-grid">`;
    filtered.forEach(k => {
      const m = MODULES[k];
      const files = byMod[k] || [];
      s += `<div class="team-card" style="border-top:3px solid ${m.color}">`;
      s += `<div class="team-card-header"><span class="team-card-dot" style="background:${m.color}"></span><span class="team-card-name">${m.label}</span></div>`;
      s += `<div class="team-card-path">${m.path || 'various'}</div>`;
      s += `<div class="team-card-count">${files.length} files</div>`;
      s += `<div class="team-card-files">`;
      files.forEach(f => {
        s += `<span class="team-card-file" onmouseenter="showTip(event,FILES.find(ff=>ff.path==='${f.path}'))" onmouseleave="hideTip()">${basename(f.path)}</span>`;
      });
      s += `</div></div>`;
    });
    s += `</div>`;
    return s;
  }

  if (scope !== 'client') {
    html += renderSection('Backend Teams (5 dedicated teams)', backendTeams);
  }
  if (scope !== 'server') {
    html += renderSection('Client Feature Teams', clientTeams);
    html += renderSection('Support Modules (no dedicated team)', supportMods);
  }

  container.innerHTML = html;
}

/* ══════════════════════════════════════════════════════════════════
   BOOT
   ══════════════════════════════════════════════════════════════════ */

buildUI();
</script>
</body>
</html>
