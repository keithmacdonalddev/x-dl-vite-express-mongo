<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Vault — Module Map</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--bg4:#475569;
  --text:#e2e8f0;--text-dim:#94a3b8;--text-bright:#f8fafc;
  --border:#334155;--hover:#1e293b;
  --radius:8px;--radius-sm:4px;
  --transition:220ms ease;
}
html{font-size:14px}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;min-height:100vh;line-height:1.5;overflow-x:hidden}

/* ── Header ─────────────────────────── */
.header{padding:20px 28px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;max-width:1440px;margin:0 auto}
.header h1{font-size:1.4rem;font-weight:700;color:var(--text-bright);display:flex;align-items:center;gap:10px}
.header h1 .icon{width:28px;height:28px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:6px;display:grid;place-items:center;font-size:14px;color:#fff;font-weight:700}
.stats{display:flex;gap:12px;flex-wrap:wrap}
.stat{display:flex;flex-direction:column;align-items:center;padding:4px 14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)}
.stat-val{font-size:1.15rem;font-weight:700;color:var(--text-bright)}
.stat-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim)}

/* ── Tabs ───────────────────────────── */
.tabs{display:flex;gap:4px;padding:14px 28px 0;max-width:1440px;margin:0 auto;flex-wrap:wrap}
.tab{background:var(--bg2);color:var(--text-dim);border:1px solid var(--border);padding:8px 16px;border-radius:8px 8px 0 0;cursor:pointer;font-size:0.82rem;font-weight:600;transition:all var(--transition);display:flex;align-items:center;gap:6px;user-select:none;border-bottom:2px solid transparent}
.tab:hover{background:var(--bg3);color:var(--text)}
.tab.active{background:var(--bg);color:var(--text-bright);border-color:var(--bg4);border-bottom-color:var(--bg);position:relative;z-index:2}
.tab .tab-icon{font-size:1rem}

/* ── View container ─────────────────── */
.view-wrap{max-width:1440px;margin:0 auto;border-top:1px solid var(--bg4);min-height:calc(100vh - 140px);position:relative}
.view{display:none;padding:20px 28px 40px;animation:fadeIn 300ms ease}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.view-subtitle{font-size:0.82rem;color:var(--text-dim);margin-bottom:16px;font-style:italic}

/* ── Legend strip ───────────────────── */
.legend-strip{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px;padding:10px 14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)}
.legend-strip-title{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--bg4);font-weight:700;width:100%;margin-bottom:4px}
.legend-chip{display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--text-dim);cursor:default;padding:2px 8px;border-radius:20px;transition:all var(--transition);border:1px solid transparent}
.legend-chip:hover{background:rgba(255,255,255,0.06);color:var(--text)}
.legend-chip .lc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ── Tooltip ────────────────────────── */
.tooltip{position:fixed;pointer-events:none;z-index:9999;background:#1a1e2e;border:1px solid var(--bg4);border-radius:var(--radius);padding:8px 12px;max-width:340px;font-size:0.78rem;line-height:1.45;color:var(--text);box-shadow:0 8px 30px rgba(0,0,0,0.5);opacity:0;transition:opacity 150ms ease}
.tooltip.visible{opacity:1}
.tooltip .tt-path{color:var(--text-dim);font-size:0.7rem;margin-bottom:3px;font-family:'Cascadia Code','Fira Code',monospace}
.tooltip .tt-mod{display:inline-block;padding:1px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;color:#fff;margin-bottom:3px}
.tooltip .tt-desc{color:var(--text)}

/* ── View 1: Top-Down ────────────────── */
.td-zoom-viewport{position:relative;overflow:hidden;max-height:calc(100vh - 200px);border:1px solid var(--border);border-radius:var(--radius);cursor:grab;user-select:none}
.td-zoom-viewport.is-dragging{cursor:grabbing}
.td-zoom-viewport svg{width:100%;height:auto;transform-origin:0 0;pointer-events:all}
.td-node{cursor:pointer;transition:filter 200ms}
.td-node:hover{filter:brightness(1.2)}
.td-arrow{fill:none;stroke:var(--bg4);stroke-width:1.5;marker-end:url(#arrowhead)}
.td-arrow.stub{stroke-dasharray:5,4;stroke:var(--text-dim);opacity:0.5}
.td-label{font-family:'Segoe UI',system-ui,sans-serif;fill:var(--text-bright);font-size:11px;font-weight:600;text-anchor:middle;pointer-events:none}
.td-sublabel{font-family:'Segoe UI',system-ui,sans-serif;fill:var(--text-dim);font-size:9px;text-anchor:middle;pointer-events:none}

/* ── Zoom Controls ──────────────────── */
.td-zoom-controls{position:absolute;bottom:12px;right:12px;display:flex;align-items:center;gap:4px;z-index:10;background:rgba(15,23,42,0.92);border:1px solid var(--bg4);border-radius:8px;padding:4px 6px;backdrop-filter:blur(6px);box-shadow:0 4px 16px rgba(0,0,0,0.4)}
.td-zoom-controls button{background:var(--bg2);color:var(--text-bright);border:1px solid var(--bg4);border-radius:6px;width:30px;height:30px;font-size:1rem;font-weight:700;cursor:pointer;display:grid;place-items:center;transition:all 150ms ease;line-height:1}
.td-zoom-controls button:hover{background:var(--bg3);border-color:#64748b}
.td-zoom-controls button:active{background:var(--bg4)}
.td-zoom-controls .td-zoom-pct{color:var(--text-dim);font-size:0.72rem;font-weight:600;min-width:42px;text-align:center;padding:0 4px;user-select:none}

/* ── View 2: File Map ────────────────── */
.fm-container{font-family:'Cascadia Code','Fira Code',monospace;font-size:0.8rem;line-height:1.8}
.fm-row{display:flex;align-items:center;gap:6px;padding:2px 8px;border-radius:4px;cursor:pointer;transition:background 150ms}
.fm-row:hover{background:rgba(255,255,255,0.04)}
.fm-indent{display:inline-block;width:20px;flex-shrink:0}
.fm-icon{width:16px;text-align:center;flex-shrink:0;font-size:0.9rem}
.fm-name{color:var(--text)}
.fm-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-left:auto}
.fm-tag{font-size:0.62rem;color:var(--text-dim);margin-left:6px;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
.fm-row.collapsed .fm-children{display:none}
.fm-toggle{cursor:pointer;user-select:none;width:16px;text-align:center;flex-shrink:0;font-size:0.8rem;color:var(--text-dim)}

/* ── View 3: Sunburst ────────────────── */
#view-sunburst svg{width:100%;max-width:700px;height:auto;margin:0 auto;display:block}
.sb-arc{cursor:pointer;transition:opacity 200ms}
.sb-arc:hover{opacity:0.8}

/* ── View 4: Bubble Map ──────────────── */
#view-bubble svg{width:100%;height:auto;max-height:calc(100vh - 200px)}
.bub-circle{cursor:pointer;transition:opacity 200ms}
.bub-circle:hover{opacity:0.85}
.bub-label{font-family:'Segoe UI',system-ui,sans-serif;fill:var(--text-bright);font-weight:600;text-anchor:middle;pointer-events:none}

/* ── View 5: Dependency Flow ─────────── */
#view-deps svg{width:100%;height:auto;max-height:calc(100vh - 200px)}
.dep-node{cursor:pointer;transition:filter 200ms}
.dep-node:hover{filter:brightness(1.15)}
.dep-edge{fill:none;stroke-width:1.5;opacity:0.6}
.dep-edge.stub{stroke-dasharray:5,3;opacity:0.4}

/* ── View 6: Grid Matrix ────────────── */
.gm-table{width:100%;border-collapse:separate;border-spacing:3px}
.gm-table th{background:var(--bg2);color:var(--text-dim);font-size:0.7rem;text-transform:uppercase;letter-spacing:0.06em;padding:8px 6px;border-radius:var(--radius-sm);font-weight:600;position:sticky;top:0;z-index:2}
.gm-table td{padding:6px;text-align:center;border-radius:var(--radius-sm);font-size:0.72rem;transition:all 150ms}
.gm-table td.filled{cursor:pointer}
.gm-table td.filled:hover{filter:brightness(1.25);transform:scale(1.05)}
.gm-table td.empty{background:rgba(255,255,255,0.02)}
.gm-row-header{background:var(--bg2)!important;color:var(--text-dim);font-weight:600;text-align:left!important;white-space:nowrap;padding-left:10px!important}

/* ── View 7: Architecture Layers ───── */
#view-layers svg{width:100%;height:auto;max-height:calc(100vh - 200px)}
.ly-layer{cursor:pointer;transition:opacity 200ms}
.ly-layer:hover{opacity:0.88}
.ly-label{font-family:'Segoe UI',system-ui,sans-serif;fill:#fff;font-weight:700;text-anchor:middle;pointer-events:none}
.ly-sublabel{font-family:'Segoe UI',system-ui,sans-serif;fill:rgba(255,255,255,0.7);font-size:10px;text-anchor:middle;pointer-events:none}

/* ── View 8: File Tree (text) ───────── */
.ft-container{font-family:'Cascadia Code','Fira Code',monospace;font-size:0.82rem;line-height:1.9;white-space:pre;padding:12px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border);overflow-x:auto;max-height:calc(100vh - 240px);overflow-y:auto}
.ft-line{transition:background 150ms}
.ft-line:hover{background:rgba(255,255,255,0.04)}
.ft-dir{color:#60a5fa;font-weight:600}
.ft-file{color:var(--text)}
.ft-tag{color:var(--text-dim);font-style:italic}
.ft-stub{color:#9ca3af;opacity:0.7}
.ft-new{color:#e879f9;font-weight:600}

/* ── Responsive ─────────────────────── */
@media(max-width:768px){
  .header{padding:14px 16px 0}
  .tabs{padding:10px 16px 0}
  .view{padding:16px 16px 32px}
  .legend-strip{gap:6px;padding:8px 10px}
  .gm-table th,.gm-table td{padding:4px 3px;font-size:0.62rem}
}
</style>
</head>
<body>

<div class="header">
  <h1><span class="icon">MV</span> Media Vault — Module Map</h1>
  <div class="stats">
    <div class="stat"><span class="stat-val" id="stat-files">0</span><span class="stat-label">Files</span></div>
    <div class="stat"><span class="stat-val" id="stat-modules">12</span><span class="stat-label">Modules</span></div>
    <div class="stat"><span class="stat-val" id="stat-client">0</span><span class="stat-label">Client</span></div>
    <div class="stat"><span class="stat-val" id="stat-server">0</span><span class="stat-label">Server</span></div>
  </div>
</div>

<div class="tabs" id="tab-bar"></div>

<div class="view-wrap">
  <div class="view active" id="view-topdown"></div>
  <div class="view" id="view-filemap"></div>
  <div class="view" id="view-sunburst"></div>
  <div class="view" id="view-bubble"></div>
  <div class="view" id="view-deps"></div>
  <div class="view" id="view-grid"></div>
  <div class="view" id="view-layers"></div>
  <div class="view" id="view-filetree"></div>
</div>

<div class="tooltip" id="tooltip">
  <div class="tt-path"></div>
  <div class="tt-mod"></div>
  <div class="tt-desc"></div>
</div>

<script>
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  DATA — All files, modules, and descriptions
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

const MODULES = [
  { id:'intake',       name:'Intake',            color:'#10b981', files:3 },
  { id:'dashboard',    name:'Dashboard',         color:'#f59e0b', files:6 },
  { id:'activity',     name:'Activity',          color:'#8b5cf6', files:3 },
  { id:'pages',        name:'Page Components',   color:'#ec4899', files:4 },
  { id:'shell',        name:'Server Shell',      color:'#3b82f6', files:4 },
  { id:'routes',       name:'API Routes',        color:'#f97316', files:6 },
  { id:'models',       name:'Data Models',       color:'#eab308', files:3 },
  { id:'platforms',    name:'Platform Registry',  color:'#14b8a6', files:4 },
  { id:'worker',       name:'Worker/Queue',      color:'#6366f1', files:3 },
  { id:'services',     name:'Services',          color:'#ef4444', files:3 },
  { id:'core',         name:'Core Kernel',       color:'#e879f9', files:9 },
  { id:'runtime',      name:'Process Runtime',   color:'#a78bfa', files:3 },
];

const SUPPORT = [
  { id:'app-shell',    name:'App Shell (Client)', color:'#3b82f6' },
  { id:'data-layer',   name:'Data Layer',         color:'#06b6d4' },
  { id:'client-lib',   name:'Client Lib',         color:'#84cc16' },
  { id:'client-plat',  name:'Client Platforms',   color:'#14b8a6' },
  { id:'server-config',name:'Server Config',      color:'#78716c' },
  { id:'server-infra', name:'Server Infrastructure',color:'#f43f5e' },
  { id:'server-utils', name:'Server Utils',       color:'#84cc16' },
  { id:'stubs',        name:'Re-export Stubs',    color:'#9ca3af' },
];

const FILES = [
  // ── Client: App Shell ──
  {path:'client/src/App.jsx',           mod:'app-shell',   desc:'Hash router — dashboard + contact profile views'},
  {path:'client/src/App.css',           mod:'app-shell',   desc:'Global styles + design system tokens'},
  {path:'client/src/main.jsx',          mod:'app-shell',   desc:'React entry point, renders App'},
  {path:'client/src/index.css',         mod:'app-shell',   desc:'CSS reset'},
  // ── Client: Intake ──
  {path:'client/src/features/intake/IntakeForm.jsx', mod:'intake', desc:'URL submission form with platform detection'},
  {path:'client/src/features/intake/useIntake.js',   mod:'intake', desc:'Intake logic, validation, platform classifier'},
  {path:'client/src/features/intake/intake.css',     mod:'intake', desc:'Intake form styles'},
  // ── Client: Dashboard ──
  {path:'client/src/features/dashboard/JobsList.jsx',      mod:'dashboard', desc:'Job list with selection + bulk actions'},
  {path:'client/src/features/dashboard/JobRow.jsx',        mod:'dashboard', desc:'Individual job card with actions'},
  {path:'client/src/features/dashboard/JobEditForm.jsx',   mod:'dashboard', desc:'Inline job editing form'},
  {path:'client/src/features/dashboard/useJobActions.js',  mod:'dashboard', desc:'Delete, retry, bulk-delete actions'},
  {path:'client/src/features/dashboard/useSelection.js',   mod:'dashboard', desc:'Multi-select state for bulk operations'},
  {path:'client/src/features/dashboard/dashboard.css',     mod:'dashboard', desc:'Dashboard styles'},
  // ── Client: Activity ──
  {path:'client/src/features/activity/ActivityPanel.jsx',    mod:'activity', desc:'Real-time telemetry feed via SSE'},
  {path:'client/src/features/activity/eventTranslator.js',   mod:'activity', desc:'Raw telemetry -> human-readable text'},
  {path:'client/src/features/activity/activity.css',         mod:'activity', desc:'Activity panel styles'},
  // ── Client: Page Components ──
  {path:'client/src/components/JobsPage.jsx',            mod:'pages', desc:'Central dashboard — wires intake + dashboard + activity'},
  {path:'client/src/components/ContactProfilePage.jsx',  mod:'pages', desc:'Per-contact job history view'},
  {path:'client/src/components/ConfirmModal.jsx',        mod:'pages', desc:'Shared confirmation dialog'},
  {path:'client/src/components/ActivityPanel.jsx',       mod:'pages', desc:'Re-export stub -> features/activity/', isStub:true},
  // ── Client: Data Layer ──
  {path:'client/src/hooks/useJobsPolling.js', mod:'data-layer', desc:'3s polling loop for job list updates'},
  {path:'client/src/api/jobsApi.js',          mod:'data-layer', desc:'Fetch wrapper for all /api/* calls'},
  // ── Client: Lib ──
  {path:'client/src/lib/contacts.js',         mod:'client-lib', desc:'Contact display helpers, slug formatting, avatar generation'},
  {path:'client/src/lib/eventTranslator.js',  mod:'client-lib', desc:'Stale re-export (superseded by features/activity/)', isStub:true},
  // ── Client: Platforms ──
  {path:'client/src/platforms/index.js',      mod:'client-plat', desc:'Client-side platform definitions + detection'},
  // ── Server: Shell ──
  {path:'server/src/index.js',         mod:'shell', desc:'Entry point — MongoDB connect, HTTP listen, queue start, graceful shutdown'},
  {path:'server/src/app.js',           mod:'shell', desc:'Express app — middleware, routes, telemetry SSE, static downloads'},
  {path:'server/src/start-api.js',     mod:'shell', desc:'Sets ROLE=api, requires index.js for API-only process'},
  {path:'server/src/start-worker.js',  mod:'shell', desc:'Sets ROLE=worker, requires index.js for worker-only process'},
  // ── Server: Core Kernel ──
  {path:'server/src/core/data/job-model.js',              mod:'core', desc:'Canonical Mongoose Job schema (source of truth)'},
  {path:'server/src/core/data/job-status.js',             mod:'core', desc:'Canonical JOB_STATUSES + SOURCE_TYPES enums'},
  {path:'server/src/core/domain/job-transitions.js',      mod:'core', desc:'Canonical state machine (canTransition)'},
  {path:'server/src/core/http/request-limits.js',         mod:'core', desc:'Canonical CORS + body parser middleware'},
  {path:'server/src/core/platforms/registry.js',          mod:'core', desc:'Canonical platform registry'},
  {path:'server/src/core/dispatch/resolve-domain-id.js',  mod:'core', desc:'Maps URL -> domain ID string'},
  {path:'server/src/core/dispatch/route-job-by-domain.js',mod:'core', desc:'Routes job to registered domain handler'},
  {path:'server/src/core/runtime/domain-context.js',      mod:'core', desc:'Builds ctx object for domain plugins'},
  {path:'server/src/core/runtime/load-domains.js',        mod:'core', desc:'Domain plugin loader/lifecycle manager'},
  // ── Server: Runtime ──
  {path:'server/src/runtime/register-shutdown.js',      mod:'runtime', desc:'SIGINT/SIGTERM cleanup handler registry'},
  {path:'server/src/runtime/start-api-runtime.js',      mod:'runtime', desc:'API-only startup sequence'},
  {path:'server/src/runtime/start-worker-runtime.js',   mod:'runtime', desc:'Worker-only startup sequence'},
  // ── Server: Routes ──
  {path:'server/src/routes/jobs.js',               mod:'routes', desc:'CRUD — list, get, create, update, delete, bulk-delete'},
  {path:'server/src/routes/contacts.js',           mod:'routes', desc:'Contact aggregation routes'},
  {path:'server/src/routes/retry.js',              mod:'routes', desc:'Job retry endpoint'},
  {path:'server/src/routes/status.js',             mod:'routes', desc:'Job status transition endpoint'},
  {path:'server/src/routes/worker-health.js',      mod:'routes', desc:'GET /api/worker/health — heartbeat staleness check'},
  {path:'server/src/routes/helpers/route-utils.js',mod:'routes', desc:'Shared route helpers (sendError, file deletion)'},
  // ── Server: Models ──
  {path:'server/src/models/job.js',                mod:'models', desc:'Thin wrapper importing from core/data/job-model.js', isStub:true},
  {path:'server/src/models/worker-heartbeat.js',   mod:'models', desc:'WorkerHeartbeat schema (30s heartbeat, stale threshold)'},
  {path:'server/src/models/telemetry-event.js',    mod:'models', desc:'TelemetryEvent schema with 24h TTL index'},
  // ── Server: Platforms ──
  {path:'server/src/platforms/registry.js',    mod:'platforms', desc:'Re-export stub -> core/platforms/registry.js', isStub:true},
  {path:'server/src/platforms/x/index.js',     mod:'platforms', desc:'X (Twitter) platform definition'},
  {path:'server/src/platforms/tiktok/index.js',mod:'platforms', desc:'TikTok platform definition'},
  // ── Server: Worker ──
  {path:'server/src/worker/queue.js',        mod:'worker', desc:'1s interval, atomic job claim (FIFO)'},
  {path:'server/src/worker/process-job.js',  mod:'worker', desc:'Extract -> pick media -> download -> save (+ domain routing)'},
  {path:'server/src/worker/recovery.js',     mod:'worker', desc:'Recover stale running jobs after restart'},
  // ── Server: Services ──
  {path:'server/src/services/extractor-service.js',  mod:'services', desc:'Playwright-based media URL extraction'},
  {path:'server/src/services/downloader-service.js', mod:'services', desc:'Direct fetch + ffmpeg HLS download'},
  {path:'server/src/services/playwright-adapter.js', mod:'services', desc:'Singleton persistent Chromium context'},
  // ── Server: Config ──
  {path:'server/src/config/env.js',                     mod:'server-config', desc:'getServerConfig(), chooseRuntime(), isDomainKernelEnabled()'},
  {path:'server/src/config/platform-capabilities.js',   mod:'server-config', desc:'Runtime enable/disable per platform'},
  // ── Server: Lib ──
  {path:'server/src/lib/logger.js',      mod:'server-infra', desc:'Structured logger -> publishes to telemetry ring buffer'},
  {path:'server/src/lib/telemetry.js',   mod:'server-infra', desc:'In-memory ring buffer + SSE pub/sub'},
  {path:'server/src/lib/error-codes.js', mod:'server-infra', desc:'Standardized error code constants'},
  // ── Server: Utils ──
  {path:'server/src/utils/validation.js',       mod:'server-utils', desc:'URL validation, isTweetUrl, getPostUrlInfo'},
  {path:'server/src/utils/account-profile.js',  mod:'server-utils', desc:'Account slug derivation, path normalization'},
  // ── Server: Re-export Stubs ──
  {path:'server/src/constants/job-status.js',      mod:'stubs', desc:'Re-export stub -> core/data/job-status.js', isStub:true},
  {path:'server/src/domain/job-transitions.js',    mod:'stubs', desc:'Re-export stub -> core/domain/job-transitions.js', isStub:true},
  {path:'server/src/middleware/request-limits.js',  mod:'stubs', desc:'Re-export stub -> core/http/request-limits.js', isStub:true},
];

// Root-level non-source files
const ROOT_FILES = [
  {path:'package.json',           desc:'Root scripts: dev, build, test, verify'},
  {path:'CLAUDE.md',              desc:'Project instructions and architecture'},
  {path:'README.md',              desc:'Project readme'},
  {path:'client/package.json',    desc:'Client dependencies'},
  {path:'client/vite.config.js',  desc:'Vite config with /api proxy to :4000'},
  {path:'server/package.json',    desc:'Server dependencies'},
  {path:'server/.env.example',    desc:'Environment variable template'},
];

// ── Computed stats ──
const clientFiles = FILES.filter(f => f.path.startsWith('client/')).length;
const serverFiles = FILES.filter(f => f.path.startsWith('server/')).length;
const totalFiles = FILES.length + ROOT_FILES.length;
document.getElementById('stat-files').textContent = totalFiles;
document.getElementById('stat-client').textContent = clientFiles;
document.getElementById('stat-server').textContent = serverFiles;

function getModuleInfo(modId) {
  return MODULES.find(m => m.id === modId) || SUPPORT.find(s => s.id === modId) || {name:modId,color:'#666'};
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  TAB BAR
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

const VIEWS = [
  {id:'topdown',  icon:'\u2B07', label:'Top-Down'},
  {id:'filemap',  icon:'\uD83D\uDCC2', label:'File Map'},
  {id:'sunburst', icon:'\u25CE', label:'Sunburst'},
  {id:'bubble',   icon:'\u25CB', label:'Bubble Map'},
  {id:'deps',     icon:'\u27A1', label:'Dependency Flow'},
  {id:'grid',     icon:'\u25A6', label:'Grid Matrix'},
  {id:'layers',   icon:'\u2261', label:'Architecture Layers'},
  {id:'filetree', icon:'\uD83C\uDF33', label:'File Tree'},
];

const tabBar = document.getElementById('tab-bar');
VIEWS.forEach((v,i) => {
  const btn = document.createElement('div');
  btn.className = 'tab' + (i===0?' active':'');
  btn.innerHTML = `<span class="tab-icon">${v.icon}</span>${v.label}`;
  btn.onclick = () => switchView(v.id);
  tabBar.appendChild(btn);
});

function switchView(id) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', VIEWS[i].id === id);
  });
  document.querySelectorAll('.view').forEach(v => {
    v.classList.toggle('active', v.id === 'view-' + id);
  });
  // Lazy render
  if(!rendered[id]) { renderers[id](); rendered[id]=true; }
}

const rendered = {topdown:false};
const renderers = {};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  TOOLTIP
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

const tooltip = document.getElementById('tooltip');
function showTooltip(e, file) {
  if(!file) return;
  const info = getModuleInfo(file.mod || file.module);
  tooltip.querySelector('.tt-path').textContent = file.path;
  const modEl = tooltip.querySelector('.tt-mod');
  modEl.textContent = info.name;
  modEl.style.background = info.color;
  tooltip.querySelector('.tt-desc').textContent = file.desc || '';
  tooltip.classList.add('visible');
  positionTooltip(e);
}
function showTooltipRaw(e, path, modId, desc) {
  showTooltip(e, {path, mod:modId, desc});
}
function positionTooltip(e) {
  let x = e.clientX + 14, y = e.clientY + 14;
  const r = tooltip.getBoundingClientRect();
  if(x + 350 > window.innerWidth) x = e.clientX - 350;
  if(y + r.height > window.innerHeight) y = e.clientY - r.height - 10;
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}
function hideTooltip() { tooltip.classList.remove('visible'); }
document.addEventListener('mousemove', e => { if(tooltip.classList.contains('visible')) positionTooltip(e); });

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  SHARED: Legend strip builder
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

function buildLegend(container) {
  const strip = document.createElement('div');
  strip.className = 'legend-strip';
  strip.innerHTML = '<div class="legend-strip-title">Modules (12)</div>';
  MODULES.forEach(m => {
    strip.innerHTML += `<div class="legend-chip"><span class="lc-dot" style="background:${m.color}"></span>${m.name} <span style="color:var(--text-dim);font-size:0.62rem">(${m.files})</span></div>`;
  });
  strip.innerHTML += '<div class="legend-strip-title" style="margin-top:6px">Support / Shared</div>';
  SUPPORT.forEach(s => {
    strip.innerHTML += `<div class="legend-chip"><span class="lc-dot" style="background:${s.color}"></span>${s.name}</div>`;
  });
  container.prepend(strip);
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  SVG Helpers
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

function svgEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for(const [k,v] of Object.entries(attrs||{})) el.setAttribute(k, v);
  return el;
}
function hexToRgba(hex, a) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 1: TOP-DOWN (Vertical architecture flow)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

(function renderTopDown() {
  rendered.topdown = true;
  const container = document.getElementById('view-topdown');
  container.innerHTML = '<div class="view-subtitle">Vertical architecture flow: User -> Client -> API -> Worker -> External</div>';
  buildLegend(container);

  const W = 1100, H = 980;
  const svg = svgEl('svg', {viewBox:`0 0 ${W} ${H}`, preserveAspectRatio:'xMidYMid meet'});

  // Defs
  const defs = svgEl('defs');
  const marker = svgEl('marker', {id:'arrowhead',viewBox:'0 0 10 7',refX:'10',refY:'3.5',markerWidth:'8',markerHeight:'6',orient:'auto-start-reverse'});
  marker.appendChild(svgEl('polygon', {points:'0 0, 10 3.5, 0 7', fill:'#64748b'}));
  defs.appendChild(marker);
  svg.appendChild(defs);

  // Background grid
  for(let y=0;y<H;y+=40){
    svg.appendChild(svgEl('line',{x1:0,y1:y,x2:W,y2:y,stroke:'#1e293b',strokeWidth:'0.5'}));
  }

  const layers = [
    {y:20,  label:'User / Browser', items:[], bg:'none'},
    {y:80,  label:'Client', items:[
      {x:200,w:140,label:'App Shell',sub:'App.jsx, main.jsx',color:'#3b82f6',mod:'app-shell'},
      {x:380,w:140,label:'Intake',sub:'IntakeForm, useIntake',color:'#10b981',mod:'intake'},
      {x:560,w:140,label:'Dashboard',sub:'JobsList, JobRow, ...',color:'#f59e0b',mod:'dashboard'},
      {x:740,w:140,label:'Activity',sub:'ActivityPanel, SSE',color:'#8b5cf6',mod:'activity'},
    ]},
    {y:170, label:'Data Layer', items:[
      {x:360,w:160,label:'Data Layer',sub:'useJobsPolling, jobsApi',color:'#06b6d4',mod:'data-layer'},
      {x:560,w:160,label:'Page Components',sub:'JobsPage, ContactProfile',color:'#ec4899',mod:'pages'},
    ]},
    {y:260, label:'', items:[
      {x:400,w:260,label:'API BOUNDARY',sub:'/api/* proxy (Vite -> :4000)',color:'#475569',mod:null,isBorder:true},
    ]},
    {y:330, label:'Server', items:[
      {x:120,w:160,label:'Process Runtime',sub:'start-api, start-worker',color:'#a78bfa',mod:'runtime'},
      {x:320,w:130,label:'Server Shell',sub:'index.js, app.js',color:'#3b82f6',mod:'shell'},
      {x:490,w:120,label:'Middleware',sub:'request-limits',color:'#9ca3af',mod:'stubs'},
      {x:650,w:160,label:'API Routes',sub:'jobs, contacts, retry, ...',color:'#f97316',mod:'routes'},
    ]},
    {y:420, label:'', items:[
      {x:250,w:160,label:'Data Models',sub:'Job, Heartbeat, Telemetry',color:'#eab308',mod:'models'},
      {x:450,w:200,label:'Platform Registry',sub:'X, TikTok + core/platforms',color:'#14b8a6',mod:'platforms'},
      {x:700,w:160,label:'Config / Infra',sub:'logger, telemetry, env',color:'#f43f5e',mod:'server-infra'},
    ]},
    {y:510, label:'', items:[
      {x:350,w:160,label:'Worker / Queue',sub:'queue, process-job, recovery',color:'#6366f1',mod:'worker'},
      {x:560,w:160,label:'Services',sub:'extractor, downloader',color:'#ef4444',mod:'services'},
    ]},
    {y:610, label:'', items:[
      {x:400,w:260,label:'Playwright Adapter',sub:'Singleton Chromium context',color:'#ef4444',mod:'services'},
    ]},
    {y:720, label:'Core Kernel', items:[
      {x:100,w:140,label:'core/data',sub:'job-model, job-status',color:'#e879f9',mod:'core'},
      {x:270,w:140,label:'core/domain',sub:'job-transitions',color:'#e879f9',mod:'core'},
      {x:440,w:140,label:'core/http',sub:'request-limits',color:'#e879f9',mod:'core'},
      {x:610,w:140,label:'core/dispatch',sub:'resolve, route',color:'#e879f9',mod:'core'},
      {x:780,w:160,label:'core/runtime',sub:'domain-context, load',color:'#e879f9',mod:'core'},
    ]},
    {y:830, label:'External', items:[
      {x:200,w:160,label:'MongoDB (Atlas)',sub:'Mongoose 9.2',color:'#47A248',mod:null},
      {x:420,w:160,label:'Chromium',sub:'Playwright 1.58',color:'#4285F4',mod:null},
      {x:640,w:160,label:'ffmpeg',sub:'HLS stream downloads',color:'#007808',mod:null},
    ]},
  ];

  // Draw layers
  layers.forEach(layer => {
    if(layer.label && layer.items.length > 0) {
      const lt = svgEl('text', {x:20, y:layer.y+28, fill:'#64748b', 'font-size':'10', 'font-family':'Segoe UI,system-ui,sans-serif', 'font-weight':'600', 'text-anchor':'start'});
      lt.textContent = layer.label;
      svg.appendChild(lt);
    }
    layer.items.forEach(item => {
      const g = svgEl('g', {class:'td-node'});
      const rect = svgEl('rect', {
        x:item.x, y:layer.y, width:item.w, height:50,
        rx:8, ry:8,
        fill: item.isBorder ? 'none' : hexToRgba(item.color, 0.15),
        stroke: item.color, 'stroke-width': item.isBorder ? 2 : 1,
        'stroke-dasharray': item.isBorder ? '8,4' : 'none'
      });
      g.appendChild(rect);
      const t1 = svgEl('text', {x:item.x+item.w/2, y:layer.y+22, class:'td-label'});
      t1.textContent = item.label;
      g.appendChild(t1);
      const t2 = svgEl('text', {x:item.x+item.w/2, y:layer.y+37, class:'td-sublabel'});
      t2.textContent = item.sub;
      g.appendChild(t2);
      if(item.mod) {
        g.addEventListener('mousemove', e => showTooltipRaw(e, item.label, item.mod, item.sub));
        g.addEventListener('mouseleave', hideTooltip);
      }
      svg.appendChild(g);
    });
  });

  // Arrows (connections)
  const arrows = [
    // Client internal
    [450,130, 440,170],  // Intake -> Data Layer
    [630,130, 640,170],  // Dashboard -> Pages
    [810,130, 720,170],  // Activity -> Pages
    // Data Layer -> API Boundary
    [440,210, 530,260],
    [640,210, 530,260],
    // API -> Server
    [530,300, 385,330],  // -> Shell
    [530,300, 730,330],  // -> Routes
    // Runtime -> Shell
    [280,340, 320,345],
    // Shell -> Models
    [385,380, 330,420],
    // Routes -> Models
    [730,380, 410,420],
    // Routes -> Platforms
    [730,380, 550,420],
    // Models -> Worker
    [330,470, 430,510],
    // Platforms -> Worker
    [550,470, 430,510],
    // Worker -> Services
    [510,560, 640,510],
    // Services -> Playwright
    [640,560, 530,610],
    // External
    [330,470, 280,830],  // Models -> MongoDB
    [530,660, 500,830],  // Playwright -> Chromium
    [640,560, 720,830],  // Services -> ffmpeg
  ];

  arrows.forEach(([x1,y1,x2,y2]) => {
    const path = svgEl('line', {x1,y1,x2,y2,class:'td-arrow'});
    svg.appendChild(path);
  });

  // Stub arrows (dashed) from re-export stubs to core
  const stubArrows = [
    // constants/ -> core/data
    {label:'constants/', from:[170,720], to:[170,710]},
    // domain/ -> core/domain
    // middleware/ -> core/http
    // models/job -> core/data/job-model
    // platforms/registry -> core/platforms
  ];

  // Stub annotation area
  const stubG = svgEl('g');
  const stubItems = [
    {x:20, y:680, label:'Re-export stubs', items:['constants/job-status', 'domain/job-transitions', 'middleware/request-limits', 'models/job', 'platforms/registry']},
  ];
  const stubBg = svgEl('rect',{x:10,y:665,width:140,height:48,rx:6,fill:hexToRgba('#9ca3af',0.1),stroke:'#9ca3af','stroke-width':0.5,'stroke-dasharray':'4,3'});
  stubG.appendChild(stubBg);
  const stubT = svgEl('text',{x:80,y:683,'font-size':'9','text-anchor':'middle',fill:'#9ca3af','font-family':'Segoe UI,system-ui,sans-serif','font-weight':'600'});
  stubT.textContent = 'Re-export Stubs';
  stubG.appendChild(stubT);
  const stubT2 = svgEl('text',{x:80,y:696,'font-size':'8','text-anchor':'middle',fill:'#64748b','font-family':'Segoe UI,system-ui,sans-serif'});
  stubT2.textContent = 'constants, domain, middleware';
  stubG.appendChild(stubT2);
  const stubT3 = svgEl('text',{x:80,y:707,'font-size':'8','text-anchor':'middle',fill:'#64748b','font-family':'Segoe UI,system-ui,sans-serif'});
  stubT3.textContent = 'models/job, platforms/registry';
  stubG.appendChild(stubT3);
  // Dashed line from stubs to core
  const stubLine = svgEl('line',{x1:150,y1:690,x2:170,y2:730,class:'td-arrow stub'});
  stubG.appendChild(stubLine);
  svg.appendChild(stubG);

  // Title for core layer
  const coreLabel = svgEl('text',{x:550,y:718,fill:'#e879f9','font-size':'12','font-weight':'700','text-anchor':'middle','font-family':'Segoe UI,system-ui,sans-serif'});
  coreLabel.textContent = 'CORE KERNEL (Plugin Architecture)';
  svg.appendChild(coreLabel);

  // Foundation line under core
  svg.appendChild(svgEl('line',{x1:80,y1:780,x2:960,y2:780,stroke:'#e879f9','stroke-width':'1','stroke-dasharray':'6,4',opacity:'0.4'}));

  // ── Zoom/Pan viewport ──
  const viewport = document.createElement('div');
  viewport.className = 'td-zoom-viewport';
  viewport.appendChild(svg);

  // Zoom controls
  const controls = document.createElement('div');
  controls.className = 'td-zoom-controls';
  controls.innerHTML = `<button class="td-zin" title="Zoom in">+</button><button class="td-zout" title="Zoom out">\u2212</button><span class="td-zoom-pct">100%</span><button class="td-zreset" title="Reset zoom">&#x21bb;</button>`;
  viewport.appendChild(controls);
  container.appendChild(viewport);

  // ── Zoom/Pan state ──
  let scale = 1, panX = 0, panY = 0;
  const MIN_SCALE = 0.25, MAX_SCALE = 3;
  let isDragging = false, dragStartX = 0, dragStartY = 0, dragPanStartX = 0, dragPanStartY = 0;
  const pctLabel = controls.querySelector('.td-zoom-pct');

  function applyTransform(smooth) {
    svg.style.transition = smooth ? 'transform 200ms ease' : 'none';
    svg.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
    pctLabel.textContent = Math.round(scale * 100) + '%';
  }

  function zoomAt(cx, cy, newScale, smooth) {
    newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, newScale));
    const rect = viewport.getBoundingClientRect();
    // Point in viewport-relative coords
    const vx = cx - rect.left;
    const vy = cy - rect.top;
    // Adjust pan so the point under the cursor stays fixed
    panX = vx - (vx - panX) * (newScale / scale);
    panY = vy - (vy - panY) * (newScale / scale);
    scale = newScale;
    applyTransform(smooth);
  }

  function resetZoom() {
    scale = 1; panX = 0; panY = 0;
    applyTransform(true);
  }

  // Mouse wheel zoom (centered on cursor)
  viewport.addEventListener('wheel', function(e) {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    zoomAt(e.clientX, e.clientY, scale * delta, false);
  }, {passive: false});

  // Click-and-drag to pan
  viewport.addEventListener('mousedown', function(e) {
    // Ignore right-click; allow node clicks through
    if (e.button !== 0) return;
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    dragPanStartX = panX;
    dragPanStartY = panY;
    viewport.classList.add('is-dragging');
  });
  window.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    panX = dragPanStartX + (e.clientX - dragStartX);
    panY = dragPanStartY + (e.clientY - dragStartY);
    applyTransform(false);
  });
  window.addEventListener('mouseup', function() {
    if (!isDragging) return;
    isDragging = false;
    viewport.classList.remove('is-dragging');
  });

  // Double-click to zoom in centered on click point
  viewport.addEventListener('dblclick', function(e) {
    e.preventDefault();
    zoomAt(e.clientX, e.clientY, scale * 1.4, true);
  });

  // Button controls
  controls.querySelector('.td-zin').addEventListener('click', function(e) {
    e.stopPropagation();
    const rect = viewport.getBoundingClientRect();
    zoomAt(rect.left + rect.width / 2, rect.top + rect.height / 2, scale * 1.25, true);
  });
  controls.querySelector('.td-zout').addEventListener('click', function(e) {
    e.stopPropagation();
    const rect = viewport.getBoundingClientRect();
    zoomAt(rect.left + rect.width / 2, rect.top + rect.height / 2, scale / 1.25, true);
  });
  controls.querySelector('.td-zreset').addEventListener('click', function(e) {
    e.stopPropagation();
    resetZoom();
  });

  // Prevent zoom controls from triggering viewport drag
  controls.addEventListener('mousedown', function(e) { e.stopPropagation(); });
})();

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 2: FILE MAP (visual directory tree)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.filemap = function() {
  const container = document.getElementById('view-filemap');
  container.innerHTML = '<div class="view-subtitle">Interactive file/folder tree — click folders to collapse/expand</div>';
  buildLegend(container);

  // Build tree structure
  const tree = {name:'x-dl-vite-express-mongo', children:{}, isDir:true};

  function ensureDir(parts) {
    let node = tree;
    parts.forEach(p => {
      if(!node.children[p]) node.children[p] = {name:p, children:{}, isDir:true};
      node = node.children[p];
    });
    return node;
  }

  [...FILES, ...ROOT_FILES].forEach(f => {
    const parts = f.path.split('/');
    const fileName = parts.pop();
    const dir = ensureDir(parts);
    dir.children[fileName] = {name:fileName, isDir:false, file:f};
  });

  const fm = document.createElement('div');
  fm.className = 'fm-container';

  function renderNode(node, depth, parentPath) {
    const entries = Object.values(node.children).sort((a,b) => {
      if(a.isDir && !b.isDir) return -1;
      if(!a.isDir && b.isDir) return 1;
      return a.name.localeCompare(b.name);
    });

    entries.forEach(child => {
      const fullPath = parentPath ? parentPath + '/' + child.name : child.name;
      const row = document.createElement('div');
      row.className = 'fm-row';
      row.style.paddingLeft = (depth * 20 + 8) + 'px';

      if(child.isDir) {
        const childCount = Object.keys(child.children).length;
        row.innerHTML = `<span class="fm-toggle">\u25BE</span><span class="fm-icon">\uD83D\uDCC1</span><span class="fm-name" style="font-weight:600;color:#60a5fa">${child.name}/</span><span class="fm-tag">${childCount} items</span>`;
        fm.appendChild(row);
        const childContainer = document.createElement('div');
        childContainer.className = 'fm-children';
        row.querySelector('.fm-toggle').onclick = () => {
          const collapsed = childContainer.style.display === 'none';
          childContainer.style.display = collapsed ? 'block' : 'none';
          row.querySelector('.fm-toggle').textContent = collapsed ? '\u25BE' : '\u25B8';
        };
        fm.appendChild(childContainer);
        const prevParent = fm;
        // Render children into the child container
        const subEntries = Object.values(child.children).sort((a,b) => {
          if(a.isDir && !b.isDir) return -1;
          if(!a.isDir && b.isDir) return 1;
          return a.name.localeCompare(b.name);
        });
        subEntries.forEach(sub => {
          const subPath = fullPath + '/' + sub.name;
          if(sub.isDir) {
            renderSubDir(sub, depth + 1, subPath, childContainer);
          } else {
            const srow = document.createElement('div');
            srow.className = 'fm-row';
            srow.style.paddingLeft = ((depth+1) * 20 + 8) + 'px';
            const info = sub.file ? getModuleInfo(sub.file.mod) : {color:'#666',name:''};
            const stubMark = sub.file && sub.file.isStub ? ' <span style="color:#9ca3af;font-size:0.65rem">(stub)</span>' : '';
            srow.innerHTML = `<span class="fm-indent"></span><span class="fm-icon">\uD83D\uDCC4</span><span class="fm-name">${sub.name}${stubMark}</span><span class="fm-dot" style="background:${info.color}"></span><span class="fm-tag">${sub.file?sub.file.desc:''}</span>`;
            if(sub.file) {
              srow.addEventListener('mousemove', e => showTooltip(e, sub.file));
              srow.addEventListener('mouseleave', hideTooltip);
            }
            childContainer.appendChild(srow);
          }
        });
      }
    });
  }

  function renderSubDir(node, depth, fullPath, parentEl) {
    const row = document.createElement('div');
    row.className = 'fm-row';
    row.style.paddingLeft = (depth * 20 + 8) + 'px';
    const childCount = Object.keys(node.children).length;
    row.innerHTML = `<span class="fm-toggle">\u25BE</span><span class="fm-icon">\uD83D\uDCC1</span><span class="fm-name" style="font-weight:600;color:#60a5fa">${node.name}/</span><span class="fm-tag">${childCount} items</span>`;
    parentEl.appendChild(row);

    const childContainer = document.createElement('div');
    childContainer.className = 'fm-children';
    row.querySelector('.fm-toggle').onclick = () => {
      const collapsed = childContainer.style.display === 'none';
      childContainer.style.display = collapsed ? 'block' : 'none';
      row.querySelector('.fm-toggle').textContent = collapsed ? '\u25BE' : '\u25B8';
    };
    parentEl.appendChild(childContainer);

    const subEntries = Object.values(node.children).sort((a,b) => {
      if(a.isDir && !b.isDir) return -1;
      if(!a.isDir && b.isDir) return 1;
      return a.name.localeCompare(b.name);
    });

    subEntries.forEach(sub => {
      const subPath = fullPath + '/' + sub.name;
      if(sub.isDir) {
        renderSubDir(sub, depth + 1, subPath, childContainer);
      } else {
        const srow = document.createElement('div');
        srow.className = 'fm-row';
        srow.style.paddingLeft = ((depth+1) * 20 + 8) + 'px';
        const info = sub.file ? getModuleInfo(sub.file.mod) : {color:'#666',name:''};
        const stubMark = sub.file && sub.file.isStub ? ' <span style="color:#9ca3af;font-size:0.65rem">(stub)</span>' : '';
        srow.innerHTML = `<span class="fm-indent"></span><span class="fm-icon">\uD83D\uDCC4</span><span class="fm-name">${sub.name}${stubMark}</span><span class="fm-dot" style="background:${info.color}"></span><span class="fm-tag">${sub.file?sub.file.desc:''}</span>`;
        if(sub.file) {
          srow.addEventListener('mousemove', e => showTooltip(e, sub.file));
          srow.addEventListener('mouseleave', hideTooltip);
        }
        childContainer.appendChild(srow);
      }
    });
  }

  renderNode(tree, 0, '');
  container.appendChild(fm);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 3: SUNBURST
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.sunburst = function() {
  const container = document.getElementById('view-sunburst');
  container.innerHTML = '<div class="view-subtitle">Concentric rings — center is root, outer rings are deeper directories. Color by module.</div>';
  buildLegend(container);

  const size = 700, cx = size/2, cy = size/2;
  const svg = svgEl('svg', {viewBox:`0 0 ${size} ${size}`, preserveAspectRatio:'xMidYMid meet'});

  // Build hierarchical data
  const root = {name:'root', children:[]};
  const sides = {client:{name:'client', children:[]}, server:{name:'server', children:[]}};
  root.children.push(sides.client, sides.server);

  function getOrCreateChild(parent, name) {
    let c = parent.children.find(x => x.name === name);
    if(!c) { c = {name, children:[]}; parent.children.push(c); }
    return c;
  }

  FILES.forEach(f => {
    const parts = f.path.split('/');
    let node = parts[0] === 'client' ? sides.client : sides.server;
    // Skip the first part (client/server) and 'src'
    const relevantParts = parts.slice(parts[1] === 'src' ? 2 : 1);
    const fileName = relevantParts.pop();
    relevantParts.forEach(p => { node = getOrCreateChild(node, p); });
    node.children.push({name:fileName, file:f, children:[]});
  });

  // Count leaves
  function countLeaves(node) {
    if(node.children.length === 0) return 1;
    return node.children.reduce((s,c) => s + countLeaves(c), 0);
  }

  // Draw arcs
  const maxDepth = 6;
  const innerR = 50, outerR = 320;
  const ringW = (outerR - innerR) / maxDepth;

  function drawNode(node, depth, startAngle, endAngle) {
    if(depth > maxDepth) return;
    const r1 = innerR + depth * ringW;
    const r2 = r1 + ringW - 2;
    const total = countLeaves(node);
    if(total === 0) return;

    // Determine color
    let color = '#334155';
    if(node.file) {
      color = getModuleInfo(node.file.mod).color;
    } else if(node.name === 'client') {
      color = '#3b82f6';
    } else if(node.name === 'server') {
      color = '#6366f1';
    } else {
      // Use color of majority of children
      const modCounts = {};
      function countMods(n) {
        if(n.file) modCounts[n.file.mod] = (modCounts[n.file.mod]||0) + 1;
        n.children.forEach(c => countMods(c));
      }
      countMods(node);
      const topMod = Object.entries(modCounts).sort((a,b) => b[1]-a[1])[0];
      if(topMod) color = getModuleInfo(topMod[0]).color;
    }

    if(endAngle - startAngle > 0.01) {
      const path = arcPath(cx, cy, r1, r2, startAngle, endAngle - 0.005);
      const arc = svgEl('path', {d:path, fill:hexToRgba(color, depth === 0 ? 0.4 : 0.25 + depth*0.1), stroke:hexToRgba(color, 0.6), 'stroke-width':'1', class:'sb-arc'});
      if(node.file) {
        arc.addEventListener('mousemove', e => showTooltip(e, node.file));
        arc.addEventListener('mouseleave', hideTooltip);
      } else if(node.name !== 'root') {
        arc.addEventListener('mousemove', e => showTooltipRaw(e, node.name, '', `Directory: ${node.name} (${total} files)`));
        arc.addEventListener('mouseleave', hideTooltip);
      }
      svg.appendChild(arc);

      // Label for larger arcs
      if(endAngle - startAngle > 0.25 && depth <= 3) {
        const midAngle = (startAngle + endAngle) / 2;
        const midR = (r1 + r2) / 2;
        const lx = cx + midR * Math.cos(midAngle);
        const ly = cy + midR * Math.sin(midAngle);
        const label = svgEl('text', {x:lx, y:ly, fill:'#e2e8f0', 'font-size': depth===0?'12':'9', 'font-weight':'600', 'text-anchor':'middle', 'dominant-baseline':'middle', 'font-family':'Segoe UI,system-ui,sans-serif', 'pointer-events':'none'});
        label.textContent = node.name.length > 12 ? node.name.slice(0,10)+'..' : node.name;
        svg.appendChild(label);
      }
    }

    // Recurse into children
    let angle = startAngle;
    node.children.forEach(child => {
      const childLeaves = countLeaves(child);
      const childAngle = (childLeaves / total) * (endAngle - startAngle);
      drawNode(child, depth + 1, angle, angle + childAngle);
      angle += childAngle;
    });
  }

  function arcPath(cx, cy, r1, r2, startAngle, endAngle) {
    const x1 = cx + r1 * Math.cos(startAngle), y1 = cy + r1 * Math.sin(startAngle);
    const x2 = cx + r2 * Math.cos(startAngle), y2 = cy + r2 * Math.sin(startAngle);
    const x3 = cx + r2 * Math.cos(endAngle), y3 = cy + r2 * Math.sin(endAngle);
    const x4 = cx + r1 * Math.cos(endAngle), y4 = cy + r1 * Math.sin(endAngle);
    const large = endAngle - startAngle > Math.PI ? 1 : 0;
    return `M${x1},${y1} L${x2},${y2} A${r2},${r2} 0 ${large} 1 ${x3},${y3} L${x4},${y4} A${r1},${r1} 0 ${large} 0 ${x1},${y1} Z`;
  }

  // Center circle
  svg.appendChild(svgEl('circle', {cx, cy, r:innerR-2, fill:'#1e293b', stroke:'#475569', 'stroke-width':'1'}));
  const ct = svgEl('text', {x:cx, y:cy-6, fill:'#f8fafc', 'font-size':'13', 'font-weight':'700', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif'});
  ct.textContent = 'Media';
  svg.appendChild(ct);
  const ct2 = svgEl('text', {x:cx, y:cy+10, fill:'#94a3b8', 'font-size':'11', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif'});
  ct2.textContent = 'Vault';
  svg.appendChild(ct2);

  drawNode(root, 0, 0, Math.PI * 2);
  container.appendChild(svg);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 4: BUBBLE MAP
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.bubble = function() {
  const container = document.getElementById('view-bubble');
  container.innerHTML = '<div class="view-subtitle">Nested circles — size proportional to file count. Client left, Server right.</div>';
  buildLegend(container);

  const W = 1100, H = 650;
  const svg = svgEl('svg', {viewBox:`0 0 ${W} ${H}`, preserveAspectRatio:'xMidYMid meet'});

  // Client bubble
  svg.appendChild(svgEl('circle', {cx:300, cy:H/2, r:260, fill:'rgba(59,130,246,0.06)', stroke:'#3b82f6', 'stroke-width':'1', 'stroke-dasharray':'6,3'}));
  const clLabel = svgEl('text', {x:300, y:40, fill:'#3b82f6', 'font-size':'14', 'font-weight':'700', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif'});
  clLabel.textContent = 'CLIENT';
  svg.appendChild(clLabel);

  // Server bubble
  svg.appendChild(svgEl('circle', {cx:750, cy:H/2, r:310, fill:'rgba(99,102,241,0.06)', stroke:'#6366f1', 'stroke-width':'1', 'stroke-dasharray':'6,3'}));
  const svLabel = svgEl('text', {x:750, y:30, fill:'#6366f1', 'font-size':'14', 'font-weight':'700', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif'});
  svLabel.textContent = 'SERVER';
  svg.appendChild(svLabel);

  // Module bubbles
  const clientMods = [
    {mod:'intake',    x:180, y:200, r:45},
    {mod:'dashboard', x:350, y:180, r:60},
    {mod:'activity',  x:230, y:350, r:45},
    {mod:'pages',     x:380, y:340, r:50},
    {mod:'data-layer',x:160, y:480, r:35},
    {mod:'app-shell', x:330, y:470, r:42},
    {mod:'client-lib',x:440, y:460, r:30},
  ];

  const serverMods = [
    {mod:'core',         x:700, y:160, r:70},
    {mod:'routes',       x:870, y:180, r:55},
    {mod:'worker',       x:600, y:310, r:45},
    {mod:'services',     x:760, y:330, r:45},
    {mod:'models',       x:900, y:330, r:45},
    {mod:'platforms',    x:650, y:460, r:50},
    {mod:'runtime',      x:830, y:460, r:42},
    {mod:'shell',        x:550, y:480, r:42},
    {mod:'server-infra', x:950, y:480, r:40},
    {mod:'stubs',        x:750, y:550, r:30},
  ];

  function drawBubble(b) {
    const info = getModuleInfo(b.mod);
    const g = svgEl('g', {class:'bub-circle'});
    g.appendChild(svgEl('circle', {cx:b.x, cy:b.y, r:b.r, fill:hexToRgba(info.color, 0.2), stroke:info.color, 'stroke-width':'1.5'}));
    const label = svgEl('text', {x:b.x, y:b.y-4, class:'bub-label', 'font-size': b.r > 50 ? '11' : '9'});
    label.textContent = info.name;
    g.appendChild(label);
    const count = svgEl('text', {x:b.x, y:b.y+10, fill:'#94a3b8', 'font-size':'9', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif', 'pointer-events':'none'});
    const fileCount = FILES.filter(f => f.mod === b.mod).length;
    count.textContent = fileCount + ' files';
    g.appendChild(count);
    g.addEventListener('mousemove', e => showTooltipRaw(e, info.name, b.mod, `${fileCount} files in this module`));
    g.addEventListener('mouseleave', hideTooltip);
    svg.appendChild(g);
  }

  clientMods.forEach(drawBubble);
  serverMods.forEach(drawBubble);
  container.appendChild(svg);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 5: DEPENDENCY FLOW (left-to-right)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.deps = function() {
  const container = document.getElementById('view-deps');
  container.innerHTML = '<div class="view-subtitle">Left-to-right dependency flow: how modules connect, including core dispatch and re-export stubs.</div>';
  buildLegend(container);

  const W = 1200, H = 700;
  const svg = svgEl('svg', {viewBox:`0 0 ${W} ${H}`, preserveAspectRatio:'xMidYMid meet'});

  // Defs
  const defs = svgEl('defs');
  const marker = svgEl('marker', {id:'dep-arrow',viewBox:'0 0 10 7',refX:'10',refY:'3.5',markerWidth:'7',markerHeight:'5',orient:'auto-start-reverse'});
  marker.appendChild(svgEl('polygon', {points:'0 0, 10 3.5, 0 7', fill:'#64748b'}));
  defs.appendChild(marker);
  svg.appendChild(defs);

  // Columns: Client | API Boundary | Server Core | Worker Pipeline | External
  const cols = [60, 280, 500, 740, 1000];
  const colLabels = ['Client', 'API Layer', 'Server Core', 'Worker Pipeline', 'External'];
  colLabels.forEach((l,i) => {
    const t = svgEl('text', {x:cols[i]+80, y:25, fill:'#475569', 'font-size':'11', 'font-weight':'700', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif'});
    t.textContent = l;
    svg.appendChild(t);
    if(i < colLabels.length - 1) {
      svg.appendChild(svgEl('line', {x1:cols[i]+170, y1:35, x2:cols[i]+170, y2:H-20, stroke:'#1e293b', 'stroke-width':'1', 'stroke-dasharray':'4,4'}));
    }
  });

  // Nodes
  const nodes = [
    // Client column
    {id:'intake',    x:60,  y:80,  w:160, h:40, mod:'intake'},
    {id:'dashboard', x:60,  y:140, w:160, h:40, mod:'dashboard'},
    {id:'activity',  x:60,  y:200, w:160, h:40, mod:'activity'},
    {id:'pages',     x:60,  y:260, w:160, h:40, mod:'pages'},
    {id:'data-layer',x:60,  y:340, w:160, h:40, mod:'data-layer'},
    {id:'app-shell', x:60,  y:420, w:160, h:40, mod:'app-shell'},
    // API column
    {id:'routes',    x:280, y:80,  w:160, h:40, mod:'routes'},
    {id:'stubs',     x:280, y:160, w:160, h:40, mod:'stubs'},
    {id:'shell',     x:280, y:240, w:160, h:40, mod:'shell'},
    {id:'runtime',   x:280, y:320, w:160, h:40, mod:'runtime'},
    {id:'config',    x:280, y:400, w:160, h:40, mod:'server-config'},
    {id:'infra',     x:280, y:480, w:160, h:40, mod:'server-infra'},
    // Core column
    {id:'core',      x:500, y:80,  w:160, h:50, mod:'core'},
    {id:'models',    x:500, y:160, w:160, h:40, mod:'models'},
    {id:'platforms', x:500, y:240, w:160, h:40, mod:'platforms'},
    {id:'utils',     x:500, y:340, w:160, h:40, mod:'server-utils'},
    // Worker column
    {id:'worker',    x:740, y:80,  w:160, h:40, mod:'worker'},
    {id:'services',  x:740, y:180, w:160, h:40, mod:'services'},
    // External column
    {id:'mongodb',   x:1000,y:80,  w:140, h:40, color:'#47A248', label:'MongoDB'},
    {id:'chromium',  x:1000,y:160, w:140, h:40, color:'#4285F4', label:'Chromium'},
    {id:'ffmpeg',    x:1000,y:240, w:140, h:40, color:'#007808', label:'ffmpeg'},
  ];

  const nodeMap = {};
  nodes.forEach(n => {
    nodeMap[n.id] = n;
    const info = n.mod ? getModuleInfo(n.mod) : {color:n.color,name:n.label};
    const g = svgEl('g', {class:'dep-node'});
    g.appendChild(svgEl('rect', {x:n.x, y:n.y, width:n.w, height:n.h, rx:8, fill:hexToRgba(info.color, 0.15), stroke:info.color, 'stroke-width':'1'}));
    const t = svgEl('text', {x:n.x+n.w/2, y:n.y+n.h/2+4, fill:'#e2e8f0', 'font-size':'10', 'font-weight':'600', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif', 'pointer-events':'none'});
    t.textContent = info.name;
    g.appendChild(t);
    if(n.mod) {
      g.addEventListener('mousemove', e => showTooltipRaw(e, info.name, n.mod, `Module: ${info.name}`));
      g.addEventListener('mouseleave', hideTooltip);
    }
    svg.appendChild(g);
  });

  // Edges
  const edges = [
    // Client internal
    ['intake','data-layer'],['dashboard','data-layer'],['activity','data-layer'],
    ['pages','intake'],['pages','dashboard'],['pages','activity'],
    ['app-shell','pages'],
    // Client -> API
    ['data-layer','routes'],
    // Server internal
    ['shell','routes'],['shell','runtime'],
    ['routes','models'],['routes','platforms'],['routes','utils'],['routes','infra'],
    ['stubs','core',true],  // stub
    ['models','core',true], // models/job -> core
    ['runtime','shell'],
    ['config','core'],
    // Core -> everything
    ['core','platforms'],['core','models'],
    // Worker pipeline
    ['worker','models'],['worker','services'],['worker','core'],
    ['services','worker'],
    // External
    ['models','mongodb'],['services','chromium'],['services','ffmpeg'],
    ['infra','mongodb'],
  ];

  edges.forEach(([fromId, toId, isStub]) => {
    const from = nodeMap[fromId], to = nodeMap[toId];
    if(!from || !to) return;
    const x1 = from.x + from.w, y1 = from.y + from.h/2;
    const x2 = to.x, y2 = to.y + to.h/2;
    // If same column, draw differently
    const sameCol = Math.abs(from.x - to.x) < 20;
    let d;
    if(sameCol) {
      d = `M${from.x+from.w/2},${from.y+from.h} L${to.x+to.w/2},${to.y}`;
    } else {
      const mx = (x1 + x2) / 2;
      d = `M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}`;
    }
    const info = from.mod ? getModuleInfo(from.mod) : {color:from.color||'#64748b'};
    const path = svgEl('path', {d, class:'dep-edge' + (isStub?' stub':''), stroke:info.color, 'marker-end':'url(#dep-arrow)'});
    svg.appendChild(path);
  });

  container.appendChild(svg);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 6: GRID MATRIX (Modules x Concerns)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.grid = function() {
  const container = document.getElementById('view-grid');
  container.innerHTML = '<div class="view-subtitle">12 modules mapped against architectural concerns. Filled cells = module participates in that concern.</div>';
  buildLegend(container);

  const concerns = [
    'UI / Components',
    'State / Hooks',
    'CSS / Styles',
    'HTTP Routes',
    'Data / Models',
    'Validation',
    'Worker / Queue',
    'Browser / Playwright',
    'File Download',
    'Platform System',
    'Telemetry / Logging',
    'Plugin System',
    'Process Lifecycle',
    'Configuration',
  ];

  // Matrix: which modules touch which concerns
  const matrix = {
    intake:     [1,1,1,0,0,1,0,0,0,1,0,0,0,0],
    dashboard:  [1,1,1,0,0,0,0,0,0,0,0,0,0,0],
    activity:   [1,0,1,0,0,0,0,0,0,0,1,0,0,0],
    pages:      [1,1,0,0,0,0,0,0,0,0,0,0,0,0],
    shell:      [0,0,0,1,0,0,0,0,0,0,1,0,1,1],
    routes:     [0,0,0,1,1,1,0,0,1,0,0,0,0,0],
    models:     [0,0,0,0,1,0,0,0,0,0,1,0,0,0],
    platforms:  [0,0,0,0,0,0,0,0,0,1,0,1,0,0],
    worker:     [0,0,0,0,1,0,1,0,1,0,1,1,0,0],
    services:   [0,0,0,0,0,0,0,1,1,0,1,0,0,0],
    core:       [0,0,0,1,1,1,0,0,0,1,0,1,1,0],
    runtime:    [0,0,0,0,0,0,0,0,0,0,0,0,1,1],
  };

  const table = document.createElement('table');
  table.className = 'gm-table';

  // Header
  const thead = document.createElement('thead');
  const hrow = document.createElement('tr');
  hrow.innerHTML = '<th></th>';
  concerns.forEach(c => { hrow.innerHTML += `<th>${c}</th>`; });
  thead.appendChild(hrow);
  table.appendChild(thead);

  // Body
  const tbody = document.createElement('tbody');
  MODULES.forEach(mod => {
    const row = document.createElement('tr');
    row.innerHTML = `<td class="gm-row-header"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${mod.color};margin-right:6px"></span>${mod.name}</td>`;
    const vals = matrix[mod.id] || [];
    concerns.forEach((c,i) => {
      const filled = vals[i];
      const td = document.createElement('td');
      if(filled) {
        td.className = 'filled';
        td.style.background = hexToRgba(mod.color, 0.25);
        td.style.color = mod.color;
        td.textContent = '\u25CF';
        td.addEventListener('mousemove', e => showTooltipRaw(e, `${mod.name} + ${c}`, mod.id, `${mod.name} participates in ${c}`));
        td.addEventListener('mouseleave', hideTooltip);
      } else {
        td.className = 'empty';
        td.textContent = '';
      }
      row.appendChild(td);
    });
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  container.appendChild(table);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 7: ARCHITECTURE LAYERS (horizontal stacked)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.layers = function() {
  const container = document.getElementById('view-layers');
  container.innerHTML = '<div class="view-subtitle">Horizontal architecture layers from UI (top) to Foundation (bottom), with Runtime orchestration on the side.</div>';
  buildLegend(container);

  const W = 1100, H = 750;
  const svg = svgEl('svg', {viewBox:`0 0 ${W} ${H}`, preserveAspectRatio:'xMidYMid meet'});

  const layerData = [
    {y:20,  h:70,  label:'Presentation Layer', sub:'React 19 + Framer Motion', color:'#3b82f6',
     blocks:[
       {x:40,w:200,label:'App Shell',color:'#3b82f6',mod:'app-shell'},
       {x:260,w:160,label:'Intake',color:'#10b981',mod:'intake'},
       {x:440,w:200,label:'Dashboard',color:'#f59e0b',mod:'dashboard'},
       {x:660,w:160,label:'Activity',color:'#8b5cf6',mod:'activity'},
     ]},
    {y:110, h:55,  label:'Page / Data Layer', sub:'Polling + API calls', color:'#ec4899',
     blocks:[
       {x:40,w:250,label:'Page Components',color:'#ec4899',mod:'pages'},
       {x:310,w:220,label:'Data Layer (hooks + api)',color:'#06b6d4',mod:'data-layer'},
       {x:550,w:180,label:'Client Platforms',color:'#14b8a6',mod:'client-plat'},
     ]},
    {y:190, h:30, label:'', sub:'', color:'#475569', isBoundary:true, blocks:[
      {x:40,w:770,label:'API BOUNDARY  ( /api/* proxy )',color:'#475569'},
    ]},
    {y:240, h:55,  label:'API Layer', sub:'Express 5', color:'#f97316',
     blocks:[
       {x:40,w:200,label:'Server Shell',color:'#3b82f6',mod:'shell'},
       {x:260,w:250,label:'API Routes',color:'#f97316',mod:'routes'},
       {x:530,w:160,label:'Middleware',color:'#9ca3af',mod:'stubs'},
       {x:710,w:100,label:'Config',color:'#78716c',mod:'server-config'},
     ]},
    {y:320, h:55,  label:'Data & Platform Layer', sub:'Mongoose + Registry', color:'#eab308',
     blocks:[
       {x:40,w:200,label:'Data Models',color:'#eab308',mod:'models'},
       {x:260,w:200,label:'Platform Registry',color:'#14b8a6',mod:'platforms'},
       {x:480,w:200,label:'Infrastructure',color:'#f43f5e',mod:'server-infra'},
       {x:700,w:110,label:'Utils',color:'#84cc16',mod:'server-utils'},
     ]},
    {y:400, h:55,  label:'Worker Layer', sub:'Background processing', color:'#6366f1',
     blocks:[
       {x:40,w:240,label:'Worker / Queue',color:'#6366f1',mod:'worker'},
       {x:300,w:240,label:'Services',color:'#ef4444',mod:'services'},
     ]},
    {y:490, h:30, label:'', sub:'', color:'#e879f9', isBoundary:true, blocks:[
      {x:40,w:770,label:'CORE KERNEL BOUNDARY',color:'#e879f9'},
    ]},
    {y:540, h:80,  label:'Core Kernel (Plugin Architecture)', sub:'Canonical data, dispatch, runtime', color:'#e879f9',
     blocks:[
       {x:40,w:130,label:'core/data',color:'#e879f9',mod:'core'},
       {x:185,w:130,label:'core/domain',color:'#e879f9',mod:'core'},
       {x:330,w:130,label:'core/http',color:'#e879f9',mod:'core'},
       {x:475,w:150,label:'core/dispatch',color:'#e879f9',mod:'core'},
       {x:640,w:170,label:'core/runtime',color:'#e879f9',mod:'core'},
       {x:40,w:130,label:'core/platforms',color:'#e879f9',mod:'core',yOff:42},
     ]},
    {y:660, h:55,  label:'External Services', sub:'', color:'#47A248',
     blocks:[
       {x:40,w:200,label:'MongoDB (Atlas)',color:'#47A248'},
       {x:260,w:200,label:'Chromium (Playwright)',color:'#4285F4'},
       {x:480,w:200,label:'ffmpeg',color:'#007808'},
     ]},
  ];

  // Runtime sidebar
  const runtimeX = 860, runtimeY = 60, runtimeW = 200, runtimeH = 500;
  svg.appendChild(svgEl('rect', {x:runtimeX, y:runtimeY, width:runtimeW, height:runtimeH, rx:12, fill:hexToRgba('#a78bfa',0.08), stroke:'#a78bfa', 'stroke-width':'1', 'stroke-dasharray':'6,3'}));
  const rtLabel = svgEl('text', {x:runtimeX+runtimeW/2, y:runtimeY+20, fill:'#a78bfa', 'font-size':'12', 'font-weight':'700', 'text-anchor':'middle', 'font-family':'Segoe UI,system-ui,sans-serif'});
  rtLabel.textContent = 'Process Runtime';
  svg.appendChild(rtLabel);

  const rtItems = [
    {label:'register-shutdown.js', y:50, desc:'SIGINT/SIGTERM registry'},
    {label:'start-api-runtime.js', y:80, desc:'API process startup'},
    {label:'start-worker-runtime.js', y:110, desc:'Worker process startup'},
  ];
  rtItems.forEach(item => {
    const g = svgEl('g',{class:'ly-layer',cursor:'pointer'});
    g.appendChild(svgEl('rect', {x:runtimeX+15, y:runtimeY+item.y, width:runtimeW-30, height:24, rx:6, fill:hexToRgba('#a78bfa',0.15), stroke:'#a78bfa', 'stroke-width':'0.5'}));
    const t = svgEl('text', {x:runtimeX+runtimeW/2, y:runtimeY+item.y+16, fill:'#e2e8f0', 'font-size':'8.5', 'text-anchor':'middle', 'font-family':'Cascadia Code,Fira Code,monospace','pointer-events':'none'});
    t.textContent = item.label;
    g.appendChild(t);
    g.addEventListener('mousemove', e => showTooltipRaw(e, 'server/src/runtime/'+item.label, 'runtime', item.desc));
    g.addEventListener('mouseleave', hideTooltip);
    svg.appendChild(g);
  });

  // Arrow from runtime to layers
  svg.appendChild(svgEl('line', {x1:runtimeX, y1:runtimeY+80, x2:830, y2:260, stroke:'#a78bfa', 'stroke-width':'1', 'stroke-dasharray':'4,3', opacity:'0.5', 'marker-end':'url(#dep-arrow)'}));
  svg.appendChild(svgEl('line', {x1:runtimeX, y1:runtimeY+120, x2:830, y2:420, stroke:'#a78bfa', 'stroke-width':'1', 'stroke-dasharray':'4,3', opacity:'0.5', 'marker-end':'url(#dep-arrow)'}));

  // Arrow defs
  const defs = svgEl('defs');
  const marker = svgEl('marker', {id:'ly-arrow',viewBox:'0 0 10 7',refX:'10',refY:'3.5',markerWidth:'7',markerHeight:'5',orient:'auto-start-reverse'});
  marker.appendChild(svgEl('polygon', {points:'0 0, 10 3.5, 0 7', fill:'#64748b'}));
  defs.appendChild(marker);
  svg.appendChild(defs);

  layerData.forEach(layer => {
    // Layer background
    if(!layer.isBoundary && layer.blocks.length > 0) {
      const bg = svgEl('rect', {x:20, y:layer.y, width:820, height:layer.h, rx:10, fill:hexToRgba(layer.color, 0.03), stroke:hexToRgba(layer.color, 0.15), 'stroke-width':'0.5'});
      svg.appendChild(bg);
    }

    layer.blocks.forEach(block => {
      const by = layer.y + (block.yOff || 10);
      const bh = layer.isBoundary ? layer.h : (block.yOff ? 28 : layer.h - 20);
      const g = svgEl('g', {class:'ly-layer'});
      g.appendChild(svgEl('rect', {
        x:block.x, y:by, width:block.w, height:bh,
        rx:layer.isBoundary ? 4 : 8,
        fill: layer.isBoundary ? 'none' : hexToRgba(block.color, 0.2),
        stroke: block.color,
        'stroke-width': layer.isBoundary ? 1.5 : 1,
        'stroke-dasharray': layer.isBoundary ? '8,4' : 'none',
      }));
      const labelY = by + bh/2 + (layer.isBoundary ? 4 : 1);
      const t = svgEl('text', {x:block.x+block.w/2, y:labelY, class:'ly-label', 'font-size': layer.isBoundary ? '10' : '11'});
      t.textContent = block.label;
      g.appendChild(t);
      if(block.mod) {
        g.addEventListener('mousemove', e => showTooltipRaw(e, block.label, block.mod, `Layer: ${layer.label || block.label}`));
        g.addEventListener('mouseleave', hideTooltip);
      }
      svg.appendChild(g);
    });

    // Layer label on the right
    if(layer.label && !layer.isBoundary) {
      const lt = svgEl('text', {x:835, y:layer.y+layer.h/2+4, fill:'#64748b', 'font-size':'9', 'font-weight':'600', 'text-anchor':'start', 'font-family':'Segoe UI,system-ui,sans-serif', 'writing-mode':'horizontal-tb'});
      lt.textContent = '';
      svg.appendChild(lt);
    }
  });

  container.appendChild(svg);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  VIEW 8: FILE TREE (collapsible text)
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

renderers.filetree = function() {
  const container = document.getElementById('view-filetree');
  container.innerHTML = '<div class="view-subtitle">Collapsible text-based file tree with module annotations.</div>';
  buildLegend(container);

  // Build a proper tree string
  const lines = [];
  const fileMap = {};
  FILES.forEach(f => fileMap[f.path] = f);

  function addLine(indent, prefix, name, file, isDir, isNew) {
    const pad = '  '.repeat(indent);
    let cls = isDir ? 'ft-dir' : 'ft-file';
    if(file && file.isStub) cls = 'ft-stub';
    if(isNew) cls = 'ft-new';
    let tag = '';
    if(file) {
      const info = getModuleInfo(file.mod);
      tag = `  <span class="ft-tag"># ${info.name} — ${file.desc}</span>`;
    }
    const stubMark = file && file.isStub ? ' <span class="ft-stub">(stub)</span>' : '';
    const newMark = isNew ? ' <span class="ft-new">(NEW)</span>' : '';
    lines.push(`<span class="ft-line"><span style="color:#475569">${pad}${prefix}</span><span class="${cls}">${name}${stubMark}${newMark}</span>${tag}</span>`);
  }

  // Hardcoded tree for precise control
  addLine(0,'','x-dl-vite-express-mongo/', null, true);
  addLine(1,'\u251C\u2500\u2500 ','package.json', {path:'package.json',mod:'',desc:'Root scripts: dev, build, test, verify'}, false);
  addLine(1,'\u251C\u2500\u2500 ','CLAUDE.md', {path:'CLAUDE.md',mod:'',desc:'Project instructions and architecture'}, false);
  addLine(1,'\u251C\u2500\u2500 ','README.md', {path:'README.md',mod:'',desc:'Project readme'}, false);
  addLine(1,'\u2502', '', null, false);
  addLine(1,'\u251C\u2500\u2500 ','client/', null, true);
  addLine(2,'\u2502   \u251C\u2500\u2500 ','package.json', {path:'client/package.json',mod:'',desc:'Client dependencies'}, false);
  addLine(2,'\u2502   \u251C\u2500\u2500 ','vite.config.js', {path:'client/vite.config.js',mod:'',desc:'Vite config with /api proxy to :4000'}, false);
  addLine(2,'\u2502   \u2514\u2500\u2500 ','src/', null, true);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','App.jsx', fileMap['client/src/App.jsx'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','App.css', fileMap['client/src/App.css'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','main.jsx', fileMap['client/src/main.jsx'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','index.css', fileMap['client/src/index.css'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','features/', null, true);
  addLine(4,'\u2502       \u2502   \u251C\u2500\u2500 ','intake/', null, true);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','IntakeForm.jsx', fileMap['client/src/features/intake/IntakeForm.jsx'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','useIntake.js', fileMap['client/src/features/intake/useIntake.js'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u2514\u2500\u2500 ','intake.css', fileMap['client/src/features/intake/intake.css'], false);
  addLine(4,'\u2502       \u2502   \u251C\u2500\u2500 ','dashboard/', null, true);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','JobsList.jsx', fileMap['client/src/features/dashboard/JobsList.jsx'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','JobRow.jsx', fileMap['client/src/features/dashboard/JobRow.jsx'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','JobEditForm.jsx', fileMap['client/src/features/dashboard/JobEditForm.jsx'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','useJobActions.js', fileMap['client/src/features/dashboard/useJobActions.js'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u251C\u2500\u2500 ','useSelection.js', fileMap['client/src/features/dashboard/useSelection.js'], false);
  addLine(5,'\u2502       \u2502   \u2502   \u2514\u2500\u2500 ','dashboard.css', fileMap['client/src/features/dashboard/dashboard.css'], false);
  addLine(4,'\u2502       \u2502   \u2514\u2500\u2500 ','activity/', null, true);
  addLine(5,'\u2502       \u2502       \u251C\u2500\u2500 ','ActivityPanel.jsx', fileMap['client/src/features/activity/ActivityPanel.jsx'], false);
  addLine(5,'\u2502       \u2502       \u251C\u2500\u2500 ','eventTranslator.js', fileMap['client/src/features/activity/eventTranslator.js'], false);
  addLine(5,'\u2502       \u2502       \u2514\u2500\u2500 ','activity.css', fileMap['client/src/features/activity/activity.css'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','components/', null, true);
  addLine(4,'\u2502       \u2502   \u251C\u2500\u2500 ','JobsPage.jsx', fileMap['client/src/components/JobsPage.jsx'], false);
  addLine(4,'\u2502       \u2502   \u251C\u2500\u2500 ','ContactProfilePage.jsx', fileMap['client/src/components/ContactProfilePage.jsx'], false);
  addLine(4,'\u2502       \u2502   \u251C\u2500\u2500 ','ConfirmModal.jsx', fileMap['client/src/components/ConfirmModal.jsx'], false);
  addLine(4,'\u2502       \u2502   \u2514\u2500\u2500 ','ActivityPanel.jsx', fileMap['client/src/components/ActivityPanel.jsx'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','hooks/', null, true);
  addLine(4,'\u2502       \u2502   \u2514\u2500\u2500 ','useJobsPolling.js', fileMap['client/src/hooks/useJobsPolling.js'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','api/', null, true);
  addLine(4,'\u2502       \u2502   \u2514\u2500\u2500 ','jobsApi.js', fileMap['client/src/api/jobsApi.js'], false);
  addLine(3,'\u2502       \u251C\u2500\u2500 ','lib/', null, true);
  addLine(4,'\u2502       \u2502   \u251C\u2500\u2500 ','contacts.js', fileMap['client/src/lib/contacts.js'], false);
  addLine(4,'\u2502       \u2502   \u2514\u2500\u2500 ','eventTranslator.js', fileMap['client/src/lib/eventTranslator.js'], false);
  addLine(3,'\u2502       \u2514\u2500\u2500 ','platforms/', null, true);
  addLine(4,'\u2502           \u2514\u2500\u2500 ','index.js', fileMap['client/src/platforms/index.js'], false);
  addLine(1,'\u2502', '', null, false);
  addLine(1,'\u2514\u2500\u2500 ','server/', null, true);
  addLine(2,'    \u251C\u2500\u2500 ','package.json', {path:'server/package.json',mod:'',desc:'Server dependencies'}, false);
  addLine(2,'    \u251C\u2500\u2500 ','.env.example', {path:'server/.env.example',mod:'',desc:'Environment variable template'}, false);
  addLine(2,'    \u2514\u2500\u2500 ','src/', null, true);
  addLine(3,'        \u251C\u2500\u2500 ','index.js', fileMap['server/src/index.js'], false);
  addLine(3,'        \u251C\u2500\u2500 ','app.js', fileMap['server/src/app.js'], false);
  addLine(3,'        \u251C\u2500\u2500 ','start-api.js', fileMap['server/src/start-api.js'], false);
  addLine(3,'        \u251C\u2500\u2500 ','start-worker.js', fileMap['server/src/start-worker.js'], false);
  addLine(3,'        \u2502', '', null, false);
  // Core Kernel (NEW)
  addLine(3,'        \u251C\u2500\u2500 ','core/', null, true, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','data/', null, true, true);
  addLine(5,'        \u2502   \u2502   \u251C\u2500\u2500 ','job-model.js', fileMap['server/src/core/data/job-model.js'], false, true);
  addLine(5,'        \u2502   \u2502   \u2514\u2500\u2500 ','job-status.js', fileMap['server/src/core/data/job-status.js'], false, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','domain/', null, true, true);
  addLine(5,'        \u2502   \u2502   \u2514\u2500\u2500 ','job-transitions.js', fileMap['server/src/core/domain/job-transitions.js'], false, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','http/', null, true, true);
  addLine(5,'        \u2502   \u2502   \u2514\u2500\u2500 ','request-limits.js', fileMap['server/src/core/http/request-limits.js'], false, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','platforms/', null, true, true);
  addLine(5,'        \u2502   \u2502   \u2514\u2500\u2500 ','registry.js', fileMap['server/src/core/platforms/registry.js'], false, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','dispatch/', null, true, true);
  addLine(5,'        \u2502   \u2502   \u251C\u2500\u2500 ','resolve-domain-id.js', fileMap['server/src/core/dispatch/resolve-domain-id.js'], false, true);
  addLine(5,'        \u2502   \u2502   \u2514\u2500\u2500 ','route-job-by-domain.js', fileMap['server/src/core/dispatch/route-job-by-domain.js'], false, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','runtime/', null, true, true);
  addLine(5,'        \u2502       \u251C\u2500\u2500 ','domain-context.js', fileMap['server/src/core/runtime/domain-context.js'], false, true);
  addLine(5,'        \u2502       \u2514\u2500\u2500 ','load-domains.js', fileMap['server/src/core/runtime/load-domains.js'], false, true);
  addLine(3,'        \u2502', '', null, false);
  // Runtime (NEW)
  addLine(3,'        \u251C\u2500\u2500 ','runtime/', null, true, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','register-shutdown.js', fileMap['server/src/runtime/register-shutdown.js'], false, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','start-api-runtime.js', fileMap['server/src/runtime/start-api-runtime.js'], false, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','start-worker-runtime.js', fileMap['server/src/runtime/start-worker-runtime.js'], false, true);
  addLine(3,'        \u2502', '', null, false);
  // Routes
  addLine(3,'        \u251C\u2500\u2500 ','routes/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','jobs.js', fileMap['server/src/routes/jobs.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','contacts.js', fileMap['server/src/routes/contacts.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','retry.js', fileMap['server/src/routes/retry.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','status.js', fileMap['server/src/routes/status.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','worker-health.js', fileMap['server/src/routes/worker-health.js'], false, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','helpers/', null, true);
  addLine(5,'        \u2502       \u2514\u2500\u2500 ','route-utils.js', fileMap['server/src/routes/helpers/route-utils.js'], false);
  // Services
  addLine(3,'        \u251C\u2500\u2500 ','services/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','extractor-service.js', fileMap['server/src/services/extractor-service.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','downloader-service.js', fileMap['server/src/services/downloader-service.js'], false);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','playwright-adapter.js', fileMap['server/src/services/playwright-adapter.js'], false);
  // Worker
  addLine(3,'        \u251C\u2500\u2500 ','worker/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','queue.js', fileMap['server/src/worker/queue.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','process-job.js', fileMap['server/src/worker/process-job.js'], false);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','recovery.js', fileMap['server/src/worker/recovery.js'], false);
  // Platforms
  addLine(3,'        \u251C\u2500\u2500 ','platforms/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','registry.js', fileMap['server/src/platforms/registry.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','x/', null, true);
  addLine(5,'        \u2502   \u2502   \u2514\u2500\u2500 ','index.js', fileMap['server/src/platforms/x/index.js'], false);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','tiktok/', null, true);
  addLine(5,'        \u2502       \u2514\u2500\u2500 ','index.js', fileMap['server/src/platforms/tiktok/index.js'], false);
  // Models
  addLine(3,'        \u251C\u2500\u2500 ','models/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','job.js', fileMap['server/src/models/job.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','worker-heartbeat.js', fileMap['server/src/models/worker-heartbeat.js'], false, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','telemetry-event.js', fileMap['server/src/models/telemetry-event.js'], false, true);
  // Constants (stub)
  addLine(3,'        \u251C\u2500\u2500 ','constants/', null, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','job-status.js', fileMap['server/src/constants/job-status.js'], false);
  // Domain (stub)
  addLine(3,'        \u251C\u2500\u2500 ','domain/', null, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','job-transitions.js', fileMap['server/src/domain/job-transitions.js'], false);
  // Middleware (stub)
  addLine(3,'        \u251C\u2500\u2500 ','middleware/', null, true);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','request-limits.js', fileMap['server/src/middleware/request-limits.js'], false);
  // Config
  addLine(3,'        \u251C\u2500\u2500 ','config/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','env.js', fileMap['server/src/config/env.js'], false);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','platform-capabilities.js', fileMap['server/src/config/platform-capabilities.js'], false);
  // Lib
  addLine(3,'        \u251C\u2500\u2500 ','lib/', null, true);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','logger.js', fileMap['server/src/lib/logger.js'], false);
  addLine(4,'        \u2502   \u251C\u2500\u2500 ','telemetry.js', fileMap['server/src/lib/telemetry.js'], false);
  addLine(4,'        \u2502   \u2514\u2500\u2500 ','error-codes.js', fileMap['server/src/lib/error-codes.js'], false);
  // Utils
  addLine(3,'        \u2514\u2500\u2500 ','utils/', null, true);
  addLine(4,'            \u251C\u2500\u2500 ','validation.js', fileMap['server/src/utils/validation.js'], false);
  addLine(4,'            \u2514\u2500\u2500 ','account-profile.js', fileMap['server/src/utils/account-profile.js'], false);

  const pre = document.createElement('div');
  pre.className = 'ft-container';
  pre.innerHTML = lines.join('\n');
  container.appendChild(pre);
};

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  INITIAL RENDER
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// View 1 (Top-Down) is already rendered inline above.
// All other views are lazy-rendered on tab switch.

</script>
</body>
</html>
