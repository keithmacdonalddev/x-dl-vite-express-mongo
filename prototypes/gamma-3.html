<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Vault ‚Äî Gamma-3: Depth Layers</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1219;
  --card:#1a1f2e;
  --card2:#1e2436;
  --line:rgba(255,255,255,.09);
  --line2:rgba(255,255,255,.06);
  --ink:#dde4f0;
  --muted:#7a8aa8;
  --faint:#3e4f68;
  --acc:#00d4aa;
  --acc-l:rgba(0,212,170,.12);
  --acc-s:rgba(0,212,170,.07);
  --blue:#4f9cf9;
  --blue-l:rgba(79,156,249,.12);
  --purp:#a78bfa;
  --purp-l:rgba(167,139,250,.12);
  --grn:#34d399;
  --grn-l:rgba(52,211,153,.12);
  --red:#f87171;
  --red-l:rgba(248,113,113,.12);
  --amber:#fbbf24;
  --amber-l:rgba(251,191,36,.12);
  --r:12px;
  --rl:16px;
  --rf:999px;
  --f:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,system-ui,sans-serif;
}

html{font-family:var(--f);background:var(--bg);color:var(--ink);font-size:15px}
body{
  height:100vh;display:flex;flex-direction:column;overflow:hidden;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(0,212,170,.05) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(99,102,241,.05) 0%, transparent 60%),
    radial-gradient(ellipse at 50% 90%, rgba(79,156,249,.04) 0%, transparent 55%),
    radial-gradient(ellipse at 20% 10%, #0d1a2e 0%, #0f1219 60%);
}

/* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
.nav{
  height:50px;display:flex;align-items:center;padding:0 18px;gap:10px;
  background:rgba(12,15,22,.75);
  backdrop-filter:blur(20px) saturate(160%);
  -webkit-backdrop-filter:blur(20px) saturate(160%);
  border-bottom:1px solid rgba(255,255,255,.1);
  box-shadow:0 1px 0 rgba(255,255,255,.04), 0 4px 16px rgba(0,0,0,.3);
  flex-shrink:0;z-index:500;position:relative;
}
.nav-logo{
  font-weight:800;font-size:14.5px;letter-spacing:-.3px;display:flex;align-items:center;
  gap:8px;color:var(--ink);flex-shrink:0;
}
.nav-mark{
  width:26px;height:26px;border-radius:7px;
  background:linear-gradient(135deg,var(--acc),var(--blue));
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:900;color:#0f1219;
}
.nav-sep{width:1px;height:16px;background:var(--line);margin:0 2px;flex-shrink:0}
.nav-tabs{display:flex;gap:1px}
.ntab{
  display:flex;align-items:center;gap:6px;padding:5px 14px;
  border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;
  font-family:var(--f);color:var(--muted);background:transparent;
  transition:color .15s,background .15s;position:relative;
}
.ntab:hover{background:rgba(255,255,255,.05);color:var(--ink)}
.ntab.active{color:var(--ink);background:rgba(255,255,255,.08)}
.ntab.active::after{
  content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);
  width:20px;height:2px;background:var(--acc);border-radius:1px;
}
.ntab-badge{
  font-size:9.5px;width:16px;height:16px;border-radius:50%;
  background:var(--acc-l);color:var(--acc);
  display:flex;align-items:center;justify-content:center;font-weight:700;
}
.nav-sp{flex:1}
.nav-hint{
  font-size:11.5px;color:var(--faint);
  display:flex;align-items:center;gap:5px;
}
.nav-hint kbd{
  padding:1px 5px;border-radius:4px;
  background:rgba(255,255,255,.06);border:1px solid var(--line2);
  font-size:10px;font-family:var(--f);color:var(--muted);
}

/* ‚îÄ‚îÄ‚îÄ STAGE ‚îÄ‚îÄ‚îÄ */
.stage{flex:1;position:relative;overflow:hidden}

/* ‚îÄ‚îÄ‚îÄ LAYER PANELS ‚îÄ‚îÄ‚îÄ */
/*
  KEY FIX: Only ONE layer is visible at a time.
  Non-active layers are opacity:0, pointer-events:none, and
  translated off-screen so they can't bleed through.

  Transition states:
  .layer-panel               = hidden (waiting behind, will come in from deeper/front)
  .layer-panel.is-active     = visible (current)
  .layer-panel.slide-out-back = leaving toward back (scale down, fade)
  .layer-panel.slide-out-front = leaving toward front (scale up, fade)
  .layer-panel.slide-in-back = entering from behind (scale up, fade in)
  .layer-panel.slide-in-front = entering from front (scale down, fade in)
*/

.layer-panel{
  position:absolute;inset:0;
  display:flex;align-items:flex-start;justify-content:center;
  padding:14px 16px 60px;
  overflow-y:auto;overflow-x:hidden;
  /* Hidden state: invisible, no interaction */
  opacity:0;
  pointer-events:none;
  /* Default hidden position: scaled down slightly, as if "behind" */
  transform:scale(0.92);
  filter:blur(6px);
  transition:opacity 400ms ease-out, transform 400ms ease-out, filter 400ms ease-out;
  will-change:opacity,transform,filter;
}
.layer-panel::-webkit-scrollbar{width:4px}
.layer-panel::-webkit-scrollbar-thumb{background:var(--line);border-radius:2px}

/* ACTIVE layer: fully visible, centered */
.layer-panel.is-active{
  opacity:1;
  pointer-events:all;
  transform:scale(1);
  filter:blur(0px);
}

/* Outgoing: moving to back (going deeper) ‚Äî shrinks and fades */
.layer-panel.exit-to-back{
  opacity:0;
  transform:scale(0.88);
  filter:blur(8px);
  transition:opacity 400ms ease-out, transform 400ms ease-out, filter 400ms ease-out;
  pointer-events:none;
}

/* Outgoing: moving to front (coming back up) ‚Äî expands and fades */
.layer-panel.exit-to-front{
  opacity:0;
  transform:scale(1.08);
  filter:blur(6px);
  transition:opacity 400ms ease-out, transform 400ms ease-out, filter 400ms ease-out;
  pointer-events:none;
}

/* Incoming from back (was behind, now becoming active) ‚Äî starts big, scales to 1 */
/* We set this immediately before adding is-active */
.layer-panel.enter-from-back{
  opacity:0;
  transform:scale(1.06);
  filter:blur(4px);
  transition:none; /* instant snap to start position */
  pointer-events:none;
}

/* Incoming from front (was in front, now becoming active) ‚Äî starts small, scales to 1 */
.layer-panel.enter-from-front{
  opacity:0;
  transform:scale(0.94);
  filter:blur(4px);
  transition:none;
  pointer-events:none;
}

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ */
.bnav{
  position:fixed;bottom:14px;left:50%;transform:translateX(-50%);
  display:flex;gap:8px;align-items:center;z-index:600;
  background:rgba(12,15,22,.7);
  backdrop-filter:blur(20px) saturate(170%);
  -webkit-backdrop-filter:blur(20px) saturate(170%);
  border:1px solid rgba(255,255,255,.11);
  border-radius:var(--rf);
  padding:7px 14px;
  box-shadow:0 8px 32px rgba(0,0,0,.55), 0 1px 0 rgba(255,255,255,.07) inset;
}
.bnav-btn{
  width:30px;height:30px;border-radius:50%;border:1px solid var(--line2);
  background:rgba(255,255,255,.05);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  color:var(--muted);font-size:16px;font-family:var(--f);
  transition:background .13s,color .13s;line-height:1;
}
.bnav-btn:hover{background:rgba(255,255,255,.1);color:var(--ink)}
.bnav-btn:disabled{opacity:.25;cursor:not-allowed;pointer-events:none}
.bnav-dots{display:flex;gap:8px;align-items:center}
.bnav-dot{
  width:7px;height:7px;border-radius:50%;
  background:var(--faint);cursor:pointer;
  transition:background .22s,transform .22s,box-shadow .22s;
}
.bnav-dot.active{
  background:var(--acc);transform:scale(1.4);
  box-shadow:0 0 8px rgba(0,212,170,.5);
}
.bnav-label{
  font-size:11px;font-weight:600;color:var(--muted);
  min-width:60px;text-align:center;
}

/* ‚îÄ‚îÄ‚îÄ SHARED COMPONENTS ‚îÄ‚îÄ‚îÄ */
.sec-hdr{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.sec-title{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.11em;color:var(--faint)}
.sec-badge{padding:2px 9px;border-radius:var(--rf);font-size:11px;font-weight:700}
.badge-amber{background:var(--amber-l);color:var(--amber)}
.badge-grn{background:var(--grn-l);color:var(--grn)}
.badge-blue{background:var(--blue-l);color:var(--blue)}
.badge-muted{background:rgba(255,255,255,.07);color:var(--muted);border:1px solid var(--line2)}
.sec-sp{flex:1}

.card{
  background:rgba(26,31,46,.6);
  backdrop-filter:blur(12px) saturate(150%);
  -webkit-backdrop-filter:blur(12px) saturate(150%);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--rl);padding:18px;
  box-shadow:0 8px 32px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.06) inset;
}

.empty{text-align:center;padding:40px 12px;color:var(--muted)}
.empty-ico{font-size:32px;margin-bottom:8px}
.empty-h{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:3px}

/* ‚îÄ‚îÄ‚îÄ LAYER 0: ACTIVE ‚îÄ‚îÄ‚îÄ */
#layer0{max-width:820px;width:100%;margin:0 auto}

.intake-wrap{
  background:rgba(26,31,46,.55);
  backdrop-filter:blur(16px) saturate(160%);
  -webkit-backdrop-filter:blur(16px) saturate(160%);
  border:1px solid rgba(255,255,255,.1);
  border-radius:var(--rl);padding:26px 24px 20px;
  margin-bottom:18px;
  box-shadow:0 8px 32px rgba(0,0,0,.5), 0 0 0 1px rgba(0,212,170,.08), 0 1px 0 rgba(255,255,255,.07) inset;
  position:relative;overflow:hidden;
}
.intake-wrap::before{
  content:'';position:absolute;top:-60%;left:-30%;width:70%;height:80%;
  background:radial-gradient(circle,rgba(0,212,170,.05) 0%,transparent 70%);
  pointer-events:none;
}
.intake-title{
  text-align:center;margin-bottom:20px;
}
.intake-title h1{
  font-size:clamp(18px,2.8vw,28px);font-weight:800;letter-spacing:-.5px;
  background:linear-gradient(135deg,var(--acc) 20%,var(--blue) 80%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.intake-title p{color:var(--muted);font-size:13px;margin-top:4px}

.url-wrap{position:relative;max-width:560px;margin:0 auto}
.url-input{
  width:100%;padding:13px 106px 13px 16px;
  font-size:14px;background:rgba(255,255,255,.06);
  border:1.5px solid var(--line);border-radius:var(--rl);
  color:var(--ink);font-family:var(--f);outline:none;
  transition:border-color .16s,box-shadow .16s,background .16s;
  backdrop-filter:blur(8px);
}
.url-input::placeholder{color:var(--faint)}
.url-input:focus{
  border-color:var(--acc);
  box-shadow:0 0 0 3px rgba(0,212,170,.1);
  background:rgba(255,255,255,.08);
}
.url-input.valid{border-color:var(--grn);box-shadow:0 0 0 3px rgba(52,211,153,.1)}
.url-input.invalid{
  border-color:var(--red);box-shadow:0 0 0 3px rgba(248,113,113,.1);
  animation:shake .3s ease;
}
@keyframes shake{0%,100%{transform:none}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.url-btn{
  position:absolute;right:6px;top:50%;transform:translateY(-50%);
  padding:7px 15px;background:var(--acc);color:#0f1219;
  border:none;border-radius:10px;font-weight:700;font-size:13px;
  cursor:pointer;font-family:var(--f);transition:background .15s,transform .15s;
}
.url-btn:hover{background:#00bfa0;transform:translateY(-50%) scale(1.04)}
.url-btn:active{transform:translateY(-50%) scale(.97)}
.url-btn.loading{
  background:linear-gradient(90deg,var(--acc) 0%,var(--blue) 50%,var(--acc) 100%);
  background-size:200% auto;animation:shimmer 1.05s linear infinite;
}
@keyframes shimmer{to{background-position:200% center}}

.plat-chips{display:flex;gap:8px;justify-content:center;margin-top:14px}
.pchip{
  display:flex;align-items:center;gap:5px;padding:4px 12px;
  border-radius:var(--rf);font-size:11px;font-weight:700;border:1px solid;
}
.pchip-x{background:rgba(79,156,249,.1);color:var(--blue);border-color:rgba(79,156,249,.25)}
.pchip-tt{background:rgba(167,139,250,.1);color:var(--purp);border-color:rgba(167,139,250,.25)}
.pchip-dot{width:5px;height:5px;border-radius:50%}

/* Job list */
.bulk-bar{
  background:rgba(10,14,28,.65);
  backdrop-filter:blur(16px) saturate(160%);
  -webkit-backdrop-filter:blur(16px) saturate(160%);
  border:1px solid rgba(0,212,170,.22);
  border-radius:var(--r);
  padding:9px 13px;display:flex;align-items:center;gap:8px;
  margin-bottom:10px;
  box-shadow:0 4px 20px rgba(0,0,0,.4), 0 0 0 1px rgba(0,212,170,.08);
  animation:slidein .16s ease;
}
@keyframes slidein{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}
.bulk-count{font-weight:700;font-size:13px;color:var(--acc)}
.bulk-sp{flex:1}
.bulk-btn{
  padding:4px 11px;border-radius:7px;border:1px solid;cursor:pointer;
  font-size:12px;font-weight:600;font-family:var(--f);transition:all .12s;
}
.bulk-del{background:var(--red-l);border-color:rgba(248,113,113,.35);color:var(--red)}
.bulk-del:hover{background:var(--red);color:#fff;border-color:var(--red)}
.bulk-cancel{background:rgba(255,255,255,.05);border-color:var(--line2);color:var(--muted)}
.bulk-cancel:hover{color:var(--ink);background:rgba(255,255,255,.08)}

.job-list{display:flex;flex-direction:column;gap:7px}
.jcard{
  background:rgba(26,31,46,.6);
  backdrop-filter:blur(10px) saturate(140%);
  -webkit-backdrop-filter:blur(10px) saturate(140%);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--r);
  padding:11px 13px;display:flex;align-items:center;gap:10px;
  transition:background .16s,border-color .16s,transform .16s,box-shadow .16s;
  cursor:pointer;position:relative;overflow:hidden;
}
.jcard:hover{
  background:rgba(30,36,54,.7);
  border-color:rgba(255,255,255,.13);
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(0,0,0,.5), 0 1px 0 rgba(255,255,255,.07) inset;
}
.jcard.selected{border-color:rgba(0,212,170,.35);background:rgba(0,212,170,.08)}

.jbar{position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:0 2px 2px 0}
.jbar-running{background:var(--amber);animation:pulse-bar 1.4s ease-in-out infinite}
.jbar-completed{background:var(--grn)}
.jbar-failed{background:var(--red)}
.jbar-queued{background:var(--faint)}
@keyframes pulse-bar{0%,100%{opacity:1}50%{opacity:.25}}

.jchk{
  width:14px;height:14px;flex-shrink:0;accent-color:var(--acc);cursor:pointer;
  transition:transform .15s;
}
.jchk:checked{transform:scale(1.15)}

.jthumbnail{
  width:40px;height:30px;border-radius:7px;background:rgba(255,255,255,.06);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px;
}
.jinfo{flex:1;min-width:0}
.jtitle{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--ink)}
.jmeta{display:flex;gap:5px;margin-top:3px;align-items:center;flex-wrap:wrap}
.jpill{font-size:10px;font-weight:700;padding:1px 6px;border-radius:4px}
.jpill-x{background:rgba(79,156,249,.2);color:var(--blue)}
.jpill-tt{background:rgba(167,139,250,.2);color:var(--purp)}
.jhandle{font-size:11px;color:var(--muted)}
.jtime{font-size:10.5px;color:var(--faint)}

.jstatus{
  font-size:10.5px;font-weight:700;padding:3px 8px;
  border-radius:var(--rf);flex-shrink:0;white-space:nowrap;
}
.js-running{background:var(--amber-l);color:var(--amber)}
.js-completed{background:var(--grn-l);color:var(--grn)}
.js-failed{background:var(--red-l);color:var(--red)}
.js-queued{background:rgba(255,255,255,.07);color:var(--muted);border:1px solid var(--line2)}

.jactions{display:flex;gap:3px;flex-shrink:0}
.jact{
  padding:3px 8px;border-radius:6px;border:1px solid var(--line2);
  background:transparent;cursor:pointer;font-size:11.5px;font-weight:600;
  font-family:var(--f);transition:all .12s;color:var(--muted);
}
.jact:hover{background:rgba(255,255,255,.07);color:var(--ink)}
.jact.del:hover{background:var(--red-l);color:var(--red);border-color:rgba(248,113,113,.4)}
.jact.retry:hover{background:var(--acc-l);color:var(--acc);border-color:rgba(0,212,170,.4)}

.jprog{
  position:absolute;bottom:0;left:3px;right:0;height:2px;
  background:linear-gradient(90deg,var(--amber),#fde68a);border-radius:1px;
  transition:width .6s ease;
}

/* ‚îÄ‚îÄ‚îÄ LAYER 1: GALLERY ‚îÄ‚îÄ‚îÄ */
#layer1{width:100%;max-width:1100px;margin:0 auto}

.gallery-layout{display:grid;grid-template-columns:1.2fr 1fr;gap:14px;width:100%}

.panel{
  background:rgba(26,31,46,.6);
  backdrop-filter:blur(14px) saturate(150%);
  -webkit-backdrop-filter:blur(14px) saturate(150%);
  border:1px solid rgba(255,255,255,.09);
  border-radius:var(--rl);padding:16px;
  box-shadow:0 8px 28px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.06) inset;
}
.panel-title{
  font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;
  color:var(--faint);margin-bottom:14px;display:flex;align-items:center;gap:7px;
}
.panel-dot{width:5px;height:5px;border-radius:50%}
.panel-scroll{max-height:calc(100vh - 220px);overflow-y:auto}
.panel-scroll::-webkit-scrollbar{width:3px}
.panel-scroll::-webkit-scrollbar-thumb{background:var(--line);border-radius:2px}

.gallery-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.gitem{
  aspect-ratio:16/9;border-radius:9px;
  background:rgba(26,31,46,.55);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.08);
  overflow:hidden;cursor:pointer;
  transition:transform .2s,border-color .2s,box-shadow .2s;
  position:relative;display:flex;align-items:center;justify-content:center;
  font-size:24px;
}
.gitem:hover{
  transform:scale(1.04);
  border-color:rgba(255,255,255,.14);
  box-shadow:0 10px 28px rgba(0,0,0,.6), 0 1px 0 rgba(255,255,255,.08) inset;
}
.g-overlay{
  position:absolute;inset:0;
  background:linear-gradient(to top,rgba(0,0,0,.85) 0%,transparent 55%);
  opacity:0;transition:opacity .18s;
}
.gitem:hover .g-overlay{opacity:1}
.g-info{
  position:absolute;bottom:0;left:0;right:0;padding:8px;
  opacity:0;transform:translateY(5px);transition:all .18s;
}
.gitem:hover .g-info{opacity:1;transform:none}
.g-title{font-size:11px;color:#fff;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.g-handle{font-size:10px;color:rgba(255,255,255,.5)}
.g-badge{
  position:absolute;top:5px;right:5px;
  padding:2px 6px;border-radius:4px;font-size:9.5px;font-weight:700;
  background:rgba(52,211,153,.2);color:var(--grn);
}

.cr-list{display:flex;flex-direction:column;gap:4px}
.cr-row{
  display:flex;align-items:center;gap:10px;padding:9px 10px;
  border-radius:9px;cursor:pointer;transition:all .15s;border:1px solid transparent;
}
.cr-row:hover{background:rgba(255,255,255,.05);border-color:var(--line2);transform:translateX(2px)}
.cr-avatar{
  width:36px;height:36px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:16px;flex-shrink:0;
}
.cr-name{font-size:13px;font-weight:700;color:var(--ink)}
.cr-handle{font-size:11px;color:var(--muted);margin-top:1px}
.cr-sp{flex:1}
.cr-stats{display:flex;gap:10px}
.cr-stat{text-align:center}
.cr-stat-val{font-size:14px;font-weight:800;color:var(--ink)}
.cr-stat-lbl{font-size:9px;color:var(--faint);text-transform:uppercase;letter-spacing:.05em}

/* ‚îÄ‚îÄ‚îÄ LAYER 2: ACTIVITY ‚îÄ‚îÄ‚îÄ */
#layer2{width:100%;max-width:1100px;margin:0 auto}

.activity-layout{display:grid;grid-template-columns:1.4fr 1fr;gap:14px;width:100%}

.ac-panel{
  background:rgba(26,31,46,.6);
  backdrop-filter:blur(14px) saturate(150%);
  -webkit-backdrop-filter:blur(14px) saturate(150%);
  border:1px solid rgba(255,255,255,.09);
  border-radius:var(--rl);padding:16px;
  box-shadow:0 8px 28px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.06) inset;
}
.ac-head{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.ac-title{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--faint)}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--grn);margin-left:auto;animation:livepulse 1.5s ease-in-out infinite}
@keyframes livepulse{0%,100%{opacity:1}50%{opacity:.3}}
.live-txt{font-size:11px;font-weight:700;color:var(--grn)}

.ac-filters{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.afpill{
  padding:3px 9px;border-radius:var(--rf);font-size:11px;font-weight:600;
  border:1px solid var(--line2);background:transparent;cursor:pointer;
  color:var(--muted);font-family:var(--f);transition:all .12s;
}
.afpill:hover{color:var(--ink);border-color:var(--line)}
.afpill.active{background:var(--acc-s);border-color:rgba(0,212,170,.35);color:var(--acc)}

.ac-scroll{max-height:calc(100vh - 240px);overflow-y:auto;padding-right:2px}
.ac-scroll::-webkit-scrollbar{width:3px}
.ac-scroll::-webkit-scrollbar-thumb{background:var(--line2);border-radius:2px}
.ac-entry{
  display:flex;gap:8px;padding:5px 6px;border-radius:7px;
  transition:background .12s;align-items:flex-start;
  animation:acfade .2s ease;
}
@keyframes acfade{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}
.ac-entry:hover{background:rgba(255,255,255,.04)}
.ac-ts{font-size:9.5px;color:var(--faint);font-family:monospace;white-space:nowrap;padding-top:2px;min-width:50px}
.ac-lvl{
  font-size:9px;font-weight:700;padding:2px 5px;border-radius:3px;
  text-transform:uppercase;flex-shrink:0;margin-top:1px;
}
.lvl-info{background:var(--blue-l);color:var(--blue)}
.lvl-warn{background:var(--amber-l);color:var(--amber)}
.lvl-error{background:var(--red-l);color:var(--red)}
.lvl-debug{background:rgba(255,255,255,.06);color:var(--faint);border:1px solid var(--line2)}
.ac-msg{font-size:12px;line-height:1.45;color:var(--muted);flex:1}
.ac-job{font-size:10px;font-family:monospace;padding:1px 5px;border-radius:3px;background:rgba(255,255,255,.05);color:var(--faint);margin-left:4px}

.se-panel{
  background:rgba(26,31,46,.6);
  backdrop-filter:blur(14px) saturate(150%);
  -webkit-backdrop-filter:blur(14px) saturate(150%);
  border:1px solid rgba(255,255,255,.09);
  border-radius:var(--rl);padding:16px;
  box-shadow:0 8px 28px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.06) inset;
}
.se-title{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--faint);margin-bottom:14px}
.se-section{margin-bottom:16px}
.se-section-title{
  font-size:9.5px;text-transform:uppercase;letter-spacing:.09em;
  color:var(--faint);margin-bottom:9px;
  border-bottom:1px solid var(--line2);padding-bottom:5px;
}
.se-row{
  display:flex;align-items:center;padding:9px 0;gap:10px;
  border-bottom:1px solid var(--line2);
}
.se-row:last-child{border-bottom:none}
.se-icon{font-size:14px;flex-shrink:0;width:22px;text-align:center}
.se-info{flex:1}
.se-label{font-size:13px;font-weight:600;color:var(--ink)}
.se-desc{font-size:11px;color:var(--muted);margin-top:1px}
.se-val{font-size:12px;color:var(--muted);font-weight:600}

.toggle{
  width:38px;height:21px;border-radius:11px;
  background:rgba(255,255,255,.08);border:1px solid var(--line2);
  cursor:pointer;position:relative;transition:background .16s,border-color .16s;flex-shrink:0;
}
.toggle.on{background:rgba(52,211,153,.28);border-color:rgba(52,211,153,.5)}
.toggle-thumb{
  position:absolute;top:2px;left:2px;width:17px;height:17px;border-radius:50%;
  background:var(--muted);box-shadow:0 1px 4px rgba(0,0,0,.4);
  transition:left .17s cubic-bezier(.4,0,.2,1),background .17s;
}
.toggle.on .toggle-thumb{left:19px;background:var(--grn)}

/* ‚îÄ‚îÄ‚îÄ DEPTH TOASTS ‚îÄ‚îÄ‚îÄ */
.toast-container{
  position:fixed;right:16px;bottom:72px;
  display:flex;flex-direction:column-reverse;gap:8px;
  z-index:1200;pointer-events:none;max-width:270px;
}
.depth-toast{
  background:rgba(15,18,25,.7);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(255,255,255,.12);
  border-radius:var(--r);
  padding:11px 13px;
  box-shadow:0 8px 32px rgba(0,0,0,.6), 0 0 0 1px rgba(0,212,170,.14), 0 1px 0 rgba(255,255,255,.08) inset;
  display:flex;gap:9px;align-items:flex-start;
  pointer-events:all;cursor:pointer;
  animation:toastrise .35s cubic-bezier(.34,1.56,.64,1) forwards;
  position:relative;overflow:hidden;
}
.depth-toast::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(0,212,170,.07) 0%,rgba(79,156,249,.05) 100%);
  pointer-events:none;
}
@keyframes toastrise{
  from{opacity:0;transform:translateY(12px) scale(.94)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.toast-fadeout{animation:toastfade .3s ease forwards}
@keyframes toastfade{to{opacity:0;transform:translateY(-8px) scale(.96)}}
.dt-ico{font-size:18px;flex-shrink:0}
.dt-title{font-size:12.5px;font-weight:700;color:var(--ink)}
.dt-sub{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.35}
.dt-badge{
  display:inline-block;margin-top:5px;padding:2px 7px;
  border-radius:4px;font-size:10px;font-weight:700;
}
.dt-badge-grn{background:var(--grn-l);color:var(--grn)}
.dt-badge-red{background:var(--red-l);color:var(--red)}

/* ‚îÄ‚îÄ‚îÄ INFO TOAST (top center) ‚îÄ‚îÄ‚îÄ */
.info-toast{
  position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-8px);
  background:rgba(12,15,22,.72);
  backdrop-filter:blur(16px) saturate(160%);
  -webkit-backdrop-filter:blur(16px) saturate(160%);
  border:1px solid rgba(255,255,255,.12);
  border-radius:var(--r);
  padding:9px 18px;font-size:13px;font-weight:600;color:var(--ink);
  box-shadow:0 4px 20px rgba(0,0,0,.5), 0 1px 0 rgba(255,255,255,.07) inset;
  z-index:800;pointer-events:none;
  opacity:0;transition:opacity .2s,transform .2s;white-space:nowrap;
}
.info-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ‚îÄ‚îÄ‚îÄ PROFILE OVERLAY ‚îÄ‚îÄ‚îÄ */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(10px) saturate(140%);
  -webkit-backdrop-filter:blur(10px) saturate(140%);
  z-index:900;
  display:flex;align-items:center;justify-content:center;padding:16px;
  opacity:0;pointer-events:none;transition:opacity .2s;
}
.overlay.show{opacity:1;pointer-events:all}
.modal{
  background:rgba(22,27,42,.75);
  backdrop-filter:blur(20px) saturate(170%);
  -webkit-backdrop-filter:blur(20px) saturate(170%);
  border:1px solid rgba(255,255,255,.11);
  border-radius:var(--rl);
  width:100%;max-width:640px;max-height:82vh;
  overflow:hidden;display:flex;flex-direction:column;
  box-shadow:0 24px 64px rgba(0,0,0,.8), 0 1px 0 rgba(255,255,255,.08) inset;
  transform:scale(.92) translateY(8px);transition:transform .22s cubic-bezier(.34,1.56,.64,1);
}
.overlay.show .modal{transform:scale(1) translateY(0)}
.modal-head{
  padding:16px 18px 14px;border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
}
.modal-av{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.modal-name{font-size:16px;font-weight:800;color:var(--ink)}
.modal-handle{font-size:12px;color:var(--muted)}
.modal-close{
  margin-left:auto;width:28px;height:28px;border-radius:7px;
  background:rgba(255,255,255,.07);border:1px solid var(--line2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;color:var(--muted);
  font-size:16px;transition:all .12s;line-height:1;flex-shrink:0;
}
.modal-close:hover{background:var(--red-l);color:var(--red);border-color:rgba(248,113,113,.4)}
.modal-body{padding:14px 18px;overflow-y:auto;flex:1}
.modal-body::-webkit-scrollbar{width:4px}
.modal-body::-webkit-scrollbar-thumb{background:var(--line2);border-radius:2px}
.profile-stats{display:flex;gap:8px;margin-bottom:16px}
.pstat{flex:1;background:rgba(255,255,255,.05);border-radius:var(--r);padding:10px;text-align:center;border:1px solid var(--line2)}
.pstat-val{font-size:20px;font-weight:800;color:var(--acc)}
.pstat-lbl{font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.06em;margin-top:2px}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width:980px){
  .gallery-layout,.activity-layout{grid-template-columns:1fr}
  .nav-hint{display:none}
  #layer0{max-width:100%}
  #layer1,#layer2{max-width:100%}
  .gallery-grid{grid-template-columns:1fr 1fr}
}

/* ‚îÄ‚îÄ‚îÄ REDUCED MOTION ‚îÄ‚îÄ‚îÄ */
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation:none!important;transition:none!important}
  .layer-panel{transition:none!important}
}

/* ‚îÄ‚îÄ‚îÄ SCROLL HINT ‚îÄ‚îÄ‚îÄ */
.scroll-hint{
  position:fixed;bottom:60px;right:20px;
  font-size:11px;color:var(--faint);
  display:flex;flex-direction:column;align-items:center;gap:4px;
  animation:hintfade 2.5s ease-in-out 2s forwards;
  pointer-events:none;z-index:400;
}
@keyframes hintfade{0%{opacity:.7}80%{opacity:.7}100%{opacity:0}}
.hint-arrow{font-size:16px;animation:hintarrow 1.2s ease-in-out 2s infinite}
@keyframes hintarrow{0%,100%{transform:translateY(0)}50%{transform:translateY(3px)}}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ -->
<div class="nav">
  <div class="nav-logo">
    <div class="nav-mark">V</div>
    Media Vault
  </div>
  <div class="nav-sep"></div>
  <div class="nav-tabs">
    <button class="ntab active" onclick="gotoLayer(0,true)">
      Active
      <span class="ntab-badge" id="badge0">2</span>
    </button>
    <button class="ntab" onclick="gotoLayer(1,true)">Gallery</button>
    <button class="ntab" onclick="gotoLayer(2,true)">Activity</button>
  </div>
  <div class="nav-sp"></div>
  <div class="nav-hint">
    <kbd>scroll</kbd> or <kbd>‚Üê ‚Üí</kbd> to navigate &nbsp;¬∑&nbsp; <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> layers
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ STAGE ‚îÄ‚îÄ‚îÄ -->
<div class="stage" id="stage">

  <!-- LAYER 0: ACTIVE DOWNLOADS -->
  <div class="layer-panel is-active" id="layer0">
    <div id="l0-inner" style="width:100%;max-width:820px">
      <!-- Intake -->
      <div class="intake-wrap">
        <div class="intake-title">
          <h1>Download Media</h1>
          <p>Paste an X or TikTok URL to save to your vault</p>
        </div>
        <div class="url-wrap">
          <input class="url-input" id="url-input"
            placeholder="https://x.com/... or tiktok.com/..."
            oninput="checkUrl(this)"
            onkeydown="if(event.key==='Enter')submitUrl()">
          <button class="url-btn" id="submit-btn" onclick="submitUrl()">Download</button>
        </div>
        <div class="plat-chips">
          <div class="pchip pchip-x"><div class="pchip-dot" style="background:var(--blue)"></div>X (Twitter)</div>
          <div class="pchip pchip-tt"><div class="pchip-dot" style="background:var(--purp)"></div>TikTok</div>
        </div>
      </div>

      <!-- Jobs -->
      <div>
        <div class="sec-hdr">
          <div class="sec-title">All Jobs</div>
          <div class="sec-sp"></div>
          <span class="sec-badge badge-amber" id="run-badge">2 running</span>
        </div>
        <div id="bulk-bar" style="display:none" class="bulk-bar">
          <span class="bulk-count" id="bulk-count">0 selected</span>
          <span class="bulk-sp"></span>
          <button class="bulk-btn bulk-del" onclick="bulkDelete()">Delete Selected</button>
          <button class="bulk-btn bulk-cancel" onclick="clearSelection()">Cancel</button>
        </div>
        <div class="job-list" id="job-list"></div>
      </div>
    </div>
  </div>

  <!-- LAYER 1: GALLERY & CREATORS -->
  <div class="layer-panel" id="layer1">
    <div style="width:100%;max-width:1100px">
      <div class="gallery-layout">
        <div class="panel">
          <div class="panel-title">
            <div class="panel-dot" style="background:var(--acc)"></div>
            Completed Downloads
          </div>
          <div class="panel-scroll">
            <div class="gallery-grid" id="gallery-grid"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-title">
            <div class="panel-dot" style="background:var(--purp)"></div>
            Creators
          </div>
          <div class="panel-scroll">
            <div class="cr-list" id="creator-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LAYER 2: ACTIVITY & SETTINGS -->
  <div class="layer-panel" id="layer2">
    <div style="width:100%;max-width:1100px">
      <div class="activity-layout">
        <!-- Activity log -->
        <div class="ac-panel">
          <div class="ac-head">
            <div class="ac-title">Activity Log</div>
            <div class="live-dot"></div>
            <div class="live-txt">Live</div>
          </div>
          <div class="ac-filters">
            <button class="afpill active" onclick="filterActivity(this,'all')">All</button>
            <button class="afpill" onclick="filterActivity(this,'info')">Info</button>
            <button class="afpill" onclick="filterActivity(this,'warn')">Warn</button>
            <button class="afpill" onclick="filterActivity(this,'error')">Error</button>
            <button class="afpill" onclick="filterActivity(this,'debug')">Debug</button>
          </div>
          <div class="ac-scroll" id="activity-list"></div>
        </div>

        <!-- Settings -->
        <div class="se-panel">
          <div class="se-title">Settings</div>
          <div class="se-section">
            <div class="se-section-title">Platforms</div>
            <div class="se-row">
              <div class="se-icon">ùïè</div>
              <div class="se-info"><div class="se-label">X (Twitter)</div><div class="se-desc">Download from X posts</div></div>
              <button class="toggle on" onclick="toggleSetting(this,'X')"><div class="toggle-thumb"></div></button>
            </div>
            <div class="se-row">
              <div class="se-icon">‚ñ∂</div>
              <div class="se-info"><div class="se-label">TikTok</div><div class="se-desc">Playwright automation</div></div>
              <button class="toggle on" onclick="toggleSetting(this,'TikTok')"><div class="toggle-thumb"></div></button>
            </div>
          </div>
          <div class="se-section">
            <div class="se-section-title">Interface</div>
            <div class="se-row">
              <div class="se-icon">‚ú¶</div>
              <div class="se-info"><div class="se-label">Depth Notifications</div><div class="se-desc">Toast alerts across layers</div></div>
              <button class="toggle on" id="notif-toggle" onclick="this.classList.toggle('on')"><div class="toggle-thumb"></div></button>
            </div>
            <div class="se-row">
              <div class="se-icon">‚ö°</div>
              <div class="se-info"><div class="se-label">Live Simulation</div><div class="se-desc">Animate job progress</div></div>
              <button class="toggle on" id="sim-toggle" onclick="toggleSim(this)"><div class="toggle-thumb"></div></button>
            </div>
          </div>
          <div class="se-section">
            <div class="se-section-title">Processing</div>
            <div class="se-row">
              <div class="se-icon">‚è±</div>
              <div class="se-info"><div class="se-label">Extraction Timeout</div><div class="se-desc">Max wait for Playwright</div></div>
              <span class="se-val">180s</span>
            </div>
            <div class="se-row">
              <div class="se-icon">‚Ü∫</div>
              <div class="se-info"><div class="se-label">Auto-Retry Failed</div><div class="se-desc">Re-queue failed jobs once</div></div>
              <button class="toggle" onclick="this.classList.toggle('on')"><div class="toggle-thumb"></div></button>
            </div>
            <div class="se-row">
              <div class="se-icon">‚äï</div>
              <div class="se-info"><div class="se-label">HLS Fallback</div><div class="se-desc">Use ffmpeg for .m3u8</div></div>
              <button class="toggle on" onclick="this.classList.toggle('on')"><div class="toggle-thumb"></div></button>
            </div>
          </div>
          <div class="se-section">
            <div class="se-section-title">System</div>
            <div class="se-row">
              <div class="se-icon">‚óâ</div>
              <div class="se-info"><div class="se-label">Worker Status</div><div class="se-desc">Queue poller ‚Äî 1s interval</div></div>
              <span style="font-size:11px;font-weight:700;color:var(--grn)">‚óè Active</span>
            </div>
            <div class="se-row">
              <div class="se-icon">üîó</div>
              <div class="se-info"><div class="se-label">MongoDB</div><div class="se-desc">Atlas connection</div></div>
              <span class="se-val" style="color:var(--grn)">Connected</span>
            </div>
            <div class="se-row">
              <div class="se-icon">üé≠</div>
              <div class="se-info"><div class="se-label">Playwright</div><div class="se-desc">Chromium context</div></div>
              <span class="se-val" style="color:var(--grn)">Ready</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /stage -->

<!-- ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ -->
<div class="bnav">
  <button class="bnav-btn" id="prev-btn" onclick="prevLayer()" disabled>&#8592;</button>
  <div class="bnav-dots">
    <div class="bnav-dot active" onclick="gotoLayer(0,true)" title="Active Downloads"></div>
    <div class="bnav-dot" onclick="gotoLayer(1,true)" title="Gallery & Creators"></div>
    <div class="bnav-dot" onclick="gotoLayer(2,true)" title="Activity & Settings"></div>
  </div>
  <div class="bnav-label" id="bnav-label">Active</div>
  <button class="bnav-btn" id="next-btn" onclick="nextLayer()">&#8594;</button>
</div>

<!-- ‚îÄ‚îÄ‚îÄ DEPTH TOASTS ‚îÄ‚îÄ‚îÄ -->
<div class="toast-container" id="toast-container"></div>

<!-- ‚îÄ‚îÄ‚îÄ INFO TOAST ‚îÄ‚îÄ‚îÄ -->
<div class="info-toast" id="info-toast"></div>

<!-- ‚îÄ‚îÄ‚îÄ SCROLL HINT ‚îÄ‚îÄ‚îÄ -->
<div class="scroll-hint">
  <div class="hint-arrow">&#x2193;</div>
  <div>scroll to navigate</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ PROFILE OVERLAY ‚îÄ‚îÄ‚îÄ -->
<div class="overlay" id="overlay" onclick="if(event.target===this)closeProfile()">
  <div class="modal">
    <div class="modal-head" id="modal-head"></div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ MOCK DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const JOBS = [
  {id:'j1',title:'@elonmusk tweet about Mars colonization',creator:'elonmusk',platform:'x',status:'running',pct:67,time:'2m ago',icon:'üöÄ'},
  {id:'j2',title:'@natgeo deep ocean documentary series',creator:'natgeo',platform:'x',status:'running',pct:34,time:'4m ago',icon:'üåä'},
  {id:'j3',title:"@charlidamelio viral dance compilation",creator:'charlidamelio',platform:'tiktok',status:'completed',pct:100,time:'12m ago',icon:'üíÉ'},
  {id:'j4',title:'@mkbhd latest flagship phone review',creator:'mkbhd',platform:'x',status:'completed',pct:100,time:'28m ago',icon:'üì±'},
  {id:'j5',title:'@nasa ISS orbital time-lapse 4K',creator:'nasa',platform:'x',status:'failed',pct:0,time:'1h ago',icon:'üõ∏'},
  {id:'j6',title:"@gordonramsay perfect pasta recipe tutorial",creator:'gordonramsay',platform:'tiktok',status:'queued',pct:0,time:'just now',icon:'üë®‚Äçüç≥'},
  {id:'j7',title:'@nytimes breaking news segment',creator:'nytimes',platform:'x',status:'completed',pct:100,time:'2h ago',icon:'üì∞'},
  {id:'j8',title:'@billnye science explainer for kids',creator:'billnye',platform:'tiktok',status:'completed',pct:100,time:'3h ago',icon:'üî¨'},
  {id:'j9',title:'@veritasium quantum physics explained',creator:'veritasium',platform:'x',status:'queued',pct:0,time:'just now',icon:'‚öõÔ∏è'},
];

const CREATORS = [
  {slug:'elonmusk',name:'Elon Musk',handle:'@elonmusk',jobs:12,done:10,platform:'x',color:'#1a4de8',icon:'üöÄ'},
  {slug:'natgeo',name:'National Geographic',handle:'@natgeo',jobs:8,done:8,platform:'x',color:'#e8a51a',icon:'üåç'},
  {slug:'charlidamelio',name:"Charli D'Amelio",handle:'@charlidamelio',jobs:24,done:22,platform:'tiktok',color:'#e81a8e',icon:'üíÉ'},
  {slug:'mkbhd',name:'MKBHD',handle:'@mkbhd',jobs:16,done:15,platform:'x',color:'#444',icon:'üì±'},
  {slug:'nasa',name:'NASA',handle:'@nasa',jobs:6,done:4,platform:'x',color:'#1a4de8',icon:'üõ∏'},
  {slug:'gordonramsay',name:'Gordon Ramsay',handle:'@gordonramsay',jobs:19,done:19,platform:'tiktok',color:'#e8361a',icon:'üë®‚Äçüç≥'},
  {slug:'nytimes',name:'NY Times',handle:'@nytimes',jobs:11,done:9,platform:'x',color:'#666',icon:'üì∞'},
  {slug:'billnye',name:'Bill Nye',handle:'@billnye',jobs:7,done:6,platform:'tiktok',color:'#1ae8b4',icon:'üî¨'},
  {slug:'veritasium',name:'Veritasium',handle:'@veritasium',jobs:9,done:7,platform:'x',color:'#ff6b35',icon:'‚öõÔ∏è'},
];

let ACTIVITY = [
  {time:'14:32:01',level:'info',msg:'Job j1 transitioned to running status',job:'j1'},
  {time:'14:31:58',level:'info',msg:'Playwright extracted 3 media candidates',job:'j1'},
  {time:'14:31:55',level:'info',msg:'Job j2 claimed by worker ‚Äî atomic FIFO claim',job:'j2'},
  {time:'14:31:50',level:'warn',msg:'TikTok rate limit detected, backing off 2s',job:'j6'},
  {time:'14:31:44',level:'info',msg:'Job j3 completed ‚Äî downloads/charlidamelio/j3.mp4',job:'j3'},
  {time:'14:31:40',level:'error',msg:'Extraction timeout for job j5 after 180s',job:'j5'},
  {time:'14:31:35',level:'debug',msg:'ffmpeg HLS stream started, 47 segments detected',job:'j2'},
  {time:'14:31:30',level:'info',msg:'Worker heartbeat OK ‚Äî queue depth: 2',job:null},
  {time:'14:31:25',level:'info',msg:'New job j6 queued via POST /api/jobs',job:'j6'},
  {time:'14:31:10',level:'debug',msg:'Playwright browser context reused (singleton)',job:'j1'},
  {time:'14:30:55',level:'info',msg:'Job j4 completed in 34.2s',job:'j4'},
  {time:'14:30:40',level:'warn',msg:'MongoDB slow query (>100ms) on jobs collection',job:null},
  {time:'14:30:20',level:'debug',msg:'pickMediaUrl scored 3 candidates ‚Äî direct MP4 wins',job:'j4'},
  {time:'14:30:05',level:'debug',msg:'Worker poll interval: 1000ms, no jobs in queue',job:null},
  {time:'14:30:00',level:'info',msg:'Server started on port 4000, MongoDB connected',job:null},
  {time:'14:29:55',level:'info',msg:'Playwright singleton context initialized',job:null},
  {time:'14:29:50',level:'debug',msg:'ENABLE_X=true ENABLE_TIKTOK=true loaded from env',job:null},
  {time:'14:29:45',level:'info',msg:'Telemetry ring buffer initialized (4000 slots)',job:null},
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentLayer = 0;
let transitioning = false;
let selectedJobs = new Set();
let activityFilter = 'all';
let wheelCooldown = false;
let simRunning = true;
let simTimer = null;

// ‚îÄ‚îÄ‚îÄ LAYER NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const LAYER_NAMES = ['Active', 'Gallery', 'Activity'];
const LAYER_COUNT = 3;

function gotoLayer(target, isUserAction) {
  if (transitioning) return;
  if (target === currentLayer) return;
  if (target < 0 || target >= LAYER_COUNT) return;

  transitioning = true;
  const from = currentLayer;
  const goingDeeper = target > from; // scrolling "into" the stack

  const fromEl = document.getElementById('layer' + from);
  const toEl   = document.getElementById('layer' + target);

  // Step 1: Set the incoming panel to its START position instantly (no transition)
  toEl.className = 'layer-panel ' + (goingDeeper ? 'enter-from-back' : 'enter-from-front');

  // Force a reflow so the browser sees the start position before we animate
  void toEl.offsetWidth;

  // Step 2: Start outgoing animation on current panel
  fromEl.classList.remove('is-active');
  fromEl.classList.add(goingDeeper ? 'exit-to-back' : 'exit-to-front');

  // Step 3: Start incoming animation ‚Äî add is-active which triggers the CSS transition
  toEl.classList.remove('enter-from-back', 'enter-from-front');
  toEl.classList.add('is-active');

  currentLayer = target;
  updateNavUI();

  // Cleanup: remove exit class from old panel after transition completes
  setTimeout(() => {
    fromEl.className = 'layer-panel'; // back to default hidden state
    transitioning = false;
  }, 450);
}

function prevLayer() { gotoLayer(currentLayer - 1, true); }
function nextLayer() { gotoLayer(currentLayer + 1, true); }

function updateNavUI() {
  const n = currentLayer;
  // Nav tabs
  document.querySelectorAll('.ntab').forEach((t, i) => t.classList.toggle('active', i === n));
  // Dots
  document.querySelectorAll('.bnav-dot').forEach((d, i) => d.classList.toggle('active', i === n));
  // Label
  document.getElementById('bnav-label').textContent = LAYER_NAMES[n];
  // Arrows
  document.getElementById('prev-btn').disabled = n === 0;
  document.getElementById('next-btn').disabled = n === LAYER_COUNT - 1;
}

// Scroll to navigate (with debounce)
document.getElementById('stage').addEventListener('wheel', (e) => {
  if (wheelCooldown) return;
  const delta = e.deltaY;
  if (delta > 25 && currentLayer < LAYER_COUNT - 1) {
    nextLayer();
    wheelCooldown = true;
    setTimeout(() => { wheelCooldown = false; }, 700);
  } else if (delta < -25 && currentLayer > 0) {
    prevLayer();
    wheelCooldown = true;
    setTimeout(() => { wheelCooldown = false; }, 700);
  }
}, { passive: true });

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (document.getElementById('overlay').classList.contains('show')) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); nextLayer(); }
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); prevLayer(); }
  if (e.key === '1') gotoLayer(0, true);
  if (e.key === '2') gotoLayer(1, true);
  if (e.key === '3') gotoLayer(2, true);
  if (e.key === 'Escape') closeProfile();
});

// ‚îÄ‚îÄ‚îÄ URL INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function checkUrl(el) {
  const v = el.value;
  el.classList.remove('valid', 'invalid');
  if (v && (v.includes('x.com') || v.includes('twitter.com') || v.includes('tiktok.com'))) {
    el.classList.add('valid');
  }
}

function submitUrl() {
  const inp = document.getElementById('url-input');
  const btn = document.getElementById('submit-btn');
  const v = inp.value.trim();
  if (!v) { inp.focus(); return; }
  const isX  = v.includes('x.com') || v.includes('twitter.com');
  const isTT = v.includes('tiktok.com');
  if (!isX && !isTT) {
    inp.classList.add('invalid');
    setTimeout(() => inp.classList.remove('invalid'), 900);
    return;
  }
  btn.classList.add('loading');
  btn.textContent = '...';
  btn.disabled = true;
  setTimeout(() => {
    const id = 'j' + Date.now();
    JOBS.unshift({
      id, title:'New download from ' + (isX ? 'X (Twitter)' : 'TikTok'),
      creator:'unknown', platform: isX ? 'x' : 'tiktok',
      status:'queued', pct:0, time:'just now', icon:'üì•'
    });
    inp.value = '';
    inp.classList.remove('valid');
    btn.classList.remove('loading');
    btn.textContent = 'Download';
    btn.disabled = false;
    renderJobs();
    showInfoToast('Job queued ‚Äî processing will begin shortly');
    pushActivity('info', 'New job ' + id + ' queued via intake form', id);
  }, 900);
}

// ‚îÄ‚îÄ‚îÄ JOBS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function statusClass(s) {
  return {running:'running',completed:'completed',failed:'failed',queued:'queued'}[s] || 'queued';
}

function renderJobs() {
  const el = document.getElementById('job-list');
  if (!JOBS.length) {
    el.innerHTML = '<div class="empty"><div class="empty-ico">üì≠</div><div class="empty-h">No jobs yet</div><p>Submit a URL above to start downloading.</p></div>';
    return;
  }
  const order = {running:0,queued:1,completed:2,failed:3};
  const sorted = [...JOBS].sort((a,b) => (order[a.status]??9)-(order[b.status]??9));

  el.innerHTML = sorted.map(j => {
    const sc = statusClass(j.status);
    const isSel = selectedJobs.has(j.id);
    const statusLabel = j.status === 'running' ? j.pct + '%' : j.status;
    return `
    <div class="jcard${isSel ? ' selected' : ''}" onclick="toggleSelect('${j.id}',event)">
      <div class="jbar jbar-${sc}"></div>
      <input class="jchk" type="checkbox" ${isSel?'checked':''} onclick="event.stopPropagation();toggleSelect('${j.id}',event)">
      <div class="jthumbnail">${j.icon}</div>
      <div class="jinfo">
        <div class="jtitle">${j.title}</div>
        <div class="jmeta">
          <span class="jpill jpill-${j.platform}">${j.platform === 'x' ? 'X' : 'TikTok'}</span>
          <span class="jhandle">@${j.creator}</span>
          <span class="jtime">${j.time}</span>
        </div>
      </div>
      <span class="jstatus js-${sc}">${statusLabel}</span>
      <div class="jactions">
        ${j.status==='completed' ? `<button class="jact" onclick="event.stopPropagation();showInfoToast('Downloading file‚Ä¶')" title="Download">‚¨á</button>` : ''}
        ${j.status==='failed'    ? `<button class="jact retry" onclick="event.stopPropagation();retryJob('${j.id}')" title="Retry">‚Ü∫</button>` : ''}
        <button class="jact del" onclick="event.stopPropagation();deleteJob('${j.id}')" title="Delete">‚úï</button>
      </div>
      ${j.status==='running' ? `<div class="jprog" style="width:${j.pct}%"></div>` : ''}
    </div>`;
  }).join('');

  const running = JOBS.filter(x => x.status === 'running');
  const queued  = JOBS.filter(x => x.status === 'queued');
  document.getElementById('run-badge').textContent = running.length + ' running';
  document.getElementById('badge0').textContent = running.length || queued.length || '0';
  updateBulkBar();
}

function toggleSelect(id, e) {
  if (e && e.target.tagName === 'INPUT') return;
  if (selectedJobs.has(id)) selectedJobs.delete(id); else selectedJobs.add(id);
  updateBulkBar();
  renderJobs();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  if (selectedJobs.size > 0) {
    bar.style.display = 'flex';
    document.getElementById('bulk-count').textContent = selectedJobs.size + ' selected';
  } else {
    bar.style.display = 'none';
  }
}

function clearSelection() { selectedJobs.clear(); updateBulkBar(); renderJobs(); }

function bulkDelete() {
  const n = selectedJobs.size;
  selectedJobs.forEach(id => {
    const i = JOBS.findIndex(x => x.id === id);
    if (i > -1) JOBS.splice(i, 1);
  });
  selectedJobs.clear();
  updateBulkBar();
  renderJobs();
  renderGallery();
  showInfoToast(n + ' job' + (n > 1 ? 's' : '') + ' deleted');
}

function deleteJob(id) {
  const i = JOBS.findIndex(x => x.id === id);
  if (i > -1) JOBS.splice(i, 1);
  selectedJobs.delete(id);
  updateBulkBar();
  renderJobs();
  renderGallery();
}

function retryJob(id) {
  const j = JOBS.find(x => x.id === id);
  if (!j) return;
  j.status = 'queued';
  j.pct = 0;
  j.time = 'just now';
  renderJobs();
  pushActivity('info', 'Job ' + id + ' manually re-queued for retry', id);
  showInfoToast('Job re-queued');
}

// ‚îÄ‚îÄ‚îÄ GALLERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderGallery() {
  const done = JOBS.filter(x => x.status === 'completed');
  const el = document.getElementById('gallery-grid');
  if (!done.length) {
    el.innerHTML = `<div class="empty" style="grid-column:1/-1">
      <div class="empty-ico">üóÇ</div>
      <div class="empty-h">No completed downloads</div>
    </div>`;
    return;
  }
  el.innerHTML = done.map(j => `
    <div class="gitem" onclick="openProfile('${j.creator}')" title="${j.title}">
      ${j.icon}
      <div class="g-overlay"></div>
      <div class="g-info">
        <div class="g-title">${j.title}</div>
        <div class="g-handle">@${j.creator}</div>
      </div>
      <span class="g-badge">‚úì done</span>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ CREATORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderCreators() {
  document.getElementById('creator-list').innerHTML = CREATORS.map(c => `
    <div class="cr-row" onclick="openProfile('${c.slug}')">
      <div class="cr-avatar" style="background:${c.color}22;border:1.5px solid ${c.color}40">${c.icon}</div>
      <div>
        <div class="cr-name">${c.name}</div>
        <div class="cr-handle">${c.handle} ¬∑ <span style="color:${c.platform==='x'?'var(--blue)':'var(--purp)'}">${c.platform==='x'?'X':'TikTok'}</span></div>
      </div>
      <div class="cr-sp"></div>
      <div class="cr-stats">
        <div class="cr-stat"><div class="cr-stat-val">${c.jobs}</div><div class="cr-stat-lbl">jobs</div></div>
        <div class="cr-stat"><div class="cr-stat-val" style="color:var(--grn)">${c.done}</div><div class="cr-stat-lbl">done</div></div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ ACTIVITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderActivity(filter) {
  const list = filter === 'all' ? ACTIVITY : ACTIVITY.filter(x => x.level === filter);
  document.getElementById('activity-list').innerHTML = list.map(ev => `
    <div class="ac-entry">
      <span class="ac-ts">${ev.time}</span>
      <span class="ac-lvl lvl-${ev.level}">${ev.level}</span>
      <span class="ac-msg">${ev.msg}${ev.job ? `<span class="ac-job">[${ev.job}]</span>` : ''}</span>
    </div>`).join('');
}

function filterActivity(btn, f) {
  activityFilter = f;
  document.querySelectorAll('.afpill').forEach(p => p.classList.toggle('active', p === btn));
  renderActivity(f);
}

function pushActivity(level, msg, jobId) {
  const now = new Date();
  const t = now.toTimeString().slice(0, 8);
  ACTIVITY.unshift({time:t, level, msg, job:jobId || null});
  if (ACTIVITY.length > 60) ACTIVITY.pop();
  renderActivity(activityFilter);
}

// ‚îÄ‚îÄ‚îÄ PROFILE OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openProfile(slug) {
  const c = CREATORS.find(x => x.slug === slug);
  const jobs = JOBS.filter(x => x.creator === slug);

  if (!c) {
    document.getElementById('modal-head').innerHTML = `
      <div class="modal-av" style="background:rgba(0,212,170,.12)">üë§</div>
      <div><div class="modal-name">@${slug}</div><div class="modal-handle">Unknown creator</div></div>
      <button class="modal-close" onclick="closeProfile()">&times;</button>`;
    document.getElementById('modal-body').innerHTML = `
      <div class="empty"><div class="empty-ico">üì≠</div><div class="empty-h">No profile data</div></div>`;
    document.getElementById('overlay').classList.add('show');
    return;
  }

  const done   = jobs.filter(x => x.status === 'completed').length;
  const active = jobs.filter(x => x.status === 'running' || x.status === 'queued').length;

  document.getElementById('modal-head').innerHTML = `
    <div class="modal-av" style="background:${c.color}22;border:2px solid ${c.color}44">${c.icon}</div>
    <div>
      <div class="modal-name">${c.name}</div>
      <div class="modal-handle">${c.handle} ¬∑ <span style="color:${c.platform==='x'?'var(--blue)':'var(--purp)'}">${c.platform==='x'?'X (Twitter)':'TikTok'}</span></div>
    </div>
    <button class="modal-close" onclick="closeProfile()">&times;</button>`;

  document.getElementById('modal-body').innerHTML = `
    <div class="profile-stats">
      <div class="pstat"><div class="pstat-val">${c.jobs}</div><div class="pstat-lbl">Total</div></div>
      <div class="pstat"><div class="pstat-val" style="color:var(--grn)">${c.done}</div><div class="pstat-lbl">Completed</div></div>
      <div class="pstat"><div class="pstat-val" style="color:var(--amber)">${active}</div><div class="pstat-lbl">Active</div></div>
    </div>
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:.09em;color:var(--faint);margin-bottom:10px">Recent Downloads</div>
    ${jobs.length ? `<div style="display:flex;flex-direction:column;gap:7px">${jobs.map(j => `
      <div class="jcard" style="cursor:default">
        <div class="jbar jbar-${statusClass(j.status)}"></div>
        <div class="jthumbnail">${j.icon}</div>
        <div class="jinfo">
          <div class="jtitle">${j.title}</div>
          <div class="jmeta"><span class="jtime">${j.time}</span></div>
        </div>
        <span class="jstatus js-${statusClass(j.status)}">${j.status}</span>
      </div>`).join('')}</div>` :
    '<div class="empty" style="padding:24px 0"><div class="empty-ico">üì≠</div><div class="empty-h">No downloads yet</div></div>'}`;

  document.getElementById('overlay').classList.add('show');
}

function closeProfile() { document.getElementById('overlay').classList.remove('show'); }

// ‚îÄ‚îÄ‚îÄ DEPTH TOASTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function spawnDepthToast(job, type) {
  const togEl = document.getElementById('notif-toggle');
  if (!togEl || !togEl.classList.contains('on')) return;
  if (currentLayer === 0) return; // already on the layer where the job is

  const icon = type === 'completed' ? job.icon : type === 'failed' ? '‚úó' : '‚ü≥';
  const title = type === 'completed' ? 'Download Complete' : type === 'failed' ? 'Download Failed' : 'Job Started';
  const label = job.title.length > 40 ? job.title.slice(0, 37) + '‚Ä¶' : job.title;
  const badgeCls = type === 'completed' ? 'dt-badge-grn' : 'dt-badge-red';
  const badgeTxt = type === 'completed' ? '‚úì completed' : '‚úó failed';

  const div = document.createElement('div');
  div.className = 'depth-toast';
  div.innerHTML = `
    <div class="dt-ico">${icon}</div>
    <div>
      <div class="dt-title">${title}</div>
      <div class="dt-sub">${label}</div>
      <span class="dt-badge ${badgeCls}">${badgeTxt}</span>
    </div>`;

  div.addEventListener('click', () => {
    gotoLayer(0, true);
    div.classList.add('toast-fadeout');
    setTimeout(() => div.remove(), 320);
  });

  const container = document.getElementById('toast-container');
  container.appendChild(div);

  // Auto-dismiss after 4s
  setTimeout(() => {
    if (!div.parentNode) return;
    div.classList.add('toast-fadeout');
    setTimeout(() => div.remove(), 320);
  }, 4000);
}

// ‚îÄ‚îÄ‚îÄ INFO TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let infoToastTimer = null;
function showInfoToast(msg) {
  const t = document.getElementById('info-toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(infoToastTimer);
  infoToastTimer = setTimeout(() => t.classList.remove('show'), 2400);
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleSetting(btn, label) {
  btn.classList.toggle('on');
  const on = btn.classList.contains('on');
  showInfoToast(label + ' platform ' + (on ? 'enabled' : 'disabled'));
}

let simRunningFlag = true;
function toggleSim(btn) {
  btn.classList.toggle('on');
  simRunningFlag = btn.classList.contains('on');
  if (simRunningFlag) startSimulation();
}

// ‚îÄ‚îÄ‚îÄ SIMULATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startSimulation() {
  if (simTimer) clearInterval(simTimer);
  simTimer = setInterval(() => {
    if (!simRunningFlag) return;

    const wasRunning = new Set(JOBS.filter(x => x.status === 'running').map(x => x.id));

    // Advance running jobs
    JOBS.filter(x => x.status === 'running').forEach(j => {
      j.pct = Math.min(100, j.pct + Math.random() * 10 + 3);
      if (j.pct >= 100) { j.status = 'completed'; j.pct = 100; }
    });

    // Promote queued ‚Üí running (max 2 concurrent)
    const running = JOBS.filter(x => x.status === 'running');
    const queued  = JOBS.filter(x => x.status === 'queued');
    if (running.length < 2 && queued.length > 0) {
      queued[0].status = 'running';
      queued[0].pct = 0;
      pushActivity('info', 'Job ' + queued[0].id + ' claimed by worker ‚Äî atomic FIFO', queued[0].id);
    }

    // Fire completion events
    JOBS.filter(x => x.status === 'completed' && wasRunning.has(x.id)).forEach(j => {
      pushActivity('info', 'Job ' + j.id + ' completed ‚Äî downloads/' + j.creator + '/' + j.id + '.mp4', j.id);
      spawnDepthToast(j, 'completed');
    });

    renderJobs();
    renderGallery();
  }, 1800);
}

// Periodic system activity
setInterval(() => {
  if (!simRunningFlag) return;
  const msgs = [
    ['debug', 'Worker heartbeat OK ‚Äî queue depth: ' + JOBS.filter(x=>x.status==='queued').length, null],
    ['debug', 'Playwright browser context reused (singleton)', null],
    ['info',  'MongoDB connection pool healthy', null],
    ['debug', 'pickMediaUrl ranking candidates by bitrate/codec', JOBS[0]?.id || null],
    ['debug', 'SSE heartbeat sent to 1 connected client', null],
  ];
  const m = msgs[Math.floor(Math.random() * msgs.length)];
  pushActivity(m[0], m[1], m[2]);
}, 4500);

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function init() {
  renderJobs();
  renderGallery();
  renderCreators();
  renderActivity('all');
  updateNavUI();
  startSimulation();

  // Demo depth notification after 5s (only if not on layer 0)
  setTimeout(() => {
    if (currentLayer !== 0) {
      spawnDepthToast({icon:'‚ú®', title:'Depth notifications are working!', creator:'system'}, 'completed');
    }
  }, 5000);
}

init();
</script>
</body>
</html>
